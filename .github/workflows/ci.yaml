# .github/workflows/ci.yaml
name: CI

on:
  pull_request:
    branches: [main]

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      go: ${{ steps.filter.outputs.go }}
      rust: ${{ steps.filter.outputs.rust }}
      ts: ${{ steps.filter.outputs.ts }}
      dart: ${{ steps.filter.outputs.dart }}
      python: ${{ steps.filter.outputs.python }}
      helm: ${{ steps.filter.outputs.helm }}
      csharp: ${{ steps.filter.outputs.csharp }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            go:
              - 'regions/**/go/**'
            rust:
              - 'regions/**/rust/**'
              - 'CLI/**'
            ts:
              - 'regions/**/react/**'
              - 'regions/**/ts/**'
            dart:
              - 'regions/**/flutter/**'
              - 'regions/**/dart/**'
            python:
              - 'e2e/**'
            helm:
              - 'infra/helm/**'
            csharp:
              - 'regions/**/csharp/**'

  lint-go:
    needs: detect-changes
    if: needs.detect-changes.outputs.go == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Lint Go modules
        run: |
          for mod in regions/system/library/go/*/; do
            if [ -f "$mod/go.mod" ]; then
              echo "=== Linting $mod ==="
              (cd "$mod" && golangci-lint run ./...)
            fi
          done

  lint-rust:
    needs: detect-changes
    if: needs.detect-changes.outputs.rust == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.82       # Dockerイメージ戦略.md / devcontainer設計.md と同期
        with:
          components: clippy, rustfmt
      - name: Format check Rust crates
        run: |
          for crate in regions/system/server/rust/*/; do
            if [ -f "$crate/Cargo.toml" ]; then
              echo "=== fmt $crate ==="
              (cd "$crate" && cargo fmt --all -- --check)
            fi
          done
          for lib in regions/system/library/rust/*/; do
            if [ -f "$lib/Cargo.toml" ]; then
              echo "=== fmt $lib ==="
              (cd "$lib" && cargo fmt --all -- --check)
            fi
          done
      - name: Clippy check Rust crates
        run: |
          for crate in regions/system/server/rust/*/; do
            if [ -f "$crate/Cargo.toml" ]; then
              echo "=== clippy $crate ==="
              (cd "$crate" && cargo clippy --all-targets -- -D warnings)
            fi
          done
          for lib in regions/system/library/rust/*/; do
            if [ -f "$lib/Cargo.toml" ]; then
              echo "=== clippy $lib ==="
              (cd "$lib" && cargo clippy --all-targets -- -D warnings)
            fi
          done

  lint-ts:
    needs: detect-changes
    if: needs.detect-changes.outputs.ts == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - run: npm ci
      - run: npx eslint .
      - run: npx prettier --check .

  lint-dart:
    needs: detect-changes
    if: needs.detect-changes.outputs.dart == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"              # devcontainer設計.md と同期
      - run: dart analyze
      - run: dart format --set-exit-if-changed .

  lint-csharp:
    needs: detect-changes
    if: needs.detect-changes.outputs.csharp == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
      - name: Restore all libraries
        run: |
          for proj in regions/system/library/csharp/*/K1s0.System.*.csproj; do
            if [ -f "$proj" ]; then
              echo "=== Restoring $proj ==="
              dotnet restore "$proj"
            fi
          done
      - name: Format check
        run: |
          for proj in regions/system/library/csharp/*/K1s0.System.*.csproj; do
            if [ -f "$proj" ]; then
              echo "=== Format check $proj ==="
              dotnet format "$proj" --verify-no-changes
            fi
          done
      - name: Build (TreatWarningsAsErrors)
        run: |
          for proj in regions/system/library/csharp/*/K1s0.System.*.csproj; do
            if [ -f "$proj" ]; then
              echo "=== Building $proj ==="
              dotnet build "$proj" -c Release --no-restore
            fi
          done

  lint-python:
    needs: detect-changes
    if: needs.detect-changes.outputs.python == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install ruff mypy
      - run: ruff check .
      - run: ruff format --check .
      - run: mypy e2e/

  test-go:
    needs: lint-go
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: "1.23"
      - name: Test Go modules
        run: |
          mkdir -p coverage
          for mod in regions/system/library/go/*/; do
            if [ -f "$mod/go.mod" ]; then
              modname=$(basename "$mod")
              echo "=== Testing $mod ==="
              (cd "$mod" && go test ./... -race -count=1 -coverprofile="$GITHUB_WORKSPACE/coverage/${modname}.out")
            fi
          done
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: go-coverage
          path: coverage/

  test-rust:
    needs: lint-rust
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@1.82       # Dockerイメージ戦略.md / devcontainer設計.md と同期
      - name: Test Rust crates
        run: |
          for crate in regions/system/server/rust/*/; do
            if [ -f "$crate/Cargo.toml" ]; then
              echo "=== Testing $crate ==="
              (cd "$crate" && cargo test --all)
            fi
          done
          for lib in regions/system/library/rust/*/; do
            if [ -f "$lib/Cargo.toml" ]; then
              echo "=== Testing $lib ==="
              (cd "$lib" && cargo test --all)
            fi
          done

  test-ts:
    needs: lint-ts
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
      - run: npm ci
      - run: npm test

  test-dart:
    needs: lint-dart
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.24.0"              # devcontainer設計.md と同期
      - run: flutter test

  test-csharp:
    needs: lint-csharp
    if: needs.detect-changes.outputs.csharp == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.x'
      - name: Test with coverage
        run: |
          mkdir -p coverage
          for testproj in regions/system/library/csharp/*/tests/K1s0.System.*.Tests.csproj; do
            if [ -f "$testproj" ]; then
              lib=$(basename "$(dirname "$(dirname "$testproj")")")
              echo "=== Testing $testproj ==="
              dotnet test "$testproj" \
                --collect:"XPlat Code Coverage" \
                --results-directory "./coverage/$lib" \
                -- DataCollectionRunSettings.DataCollectors.DataCollector.Configuration.Format=cobertura
            fi
          done
      - uses: actions/upload-artifact@v4
        if: always()
        with:
          name: csharp-coverage
          path: coverage/

  test-python:
    needs: lint-python
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - run: pip install -r e2e/requirements.txt
      - run: pytest e2e/ --tb=short

  # NOTE: proto チェックは専用ワークフロー proto.yaml で実行する。
  # ci.yaml の detect-changes で proto 変更を検出し、proto.yaml が独立してトリガーされる。

  helm-lint:
    needs: detect-changes
    if: needs.detect-changes.outputs.helm == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: azure/setup-helm@v4
        with:
          version: "3.16"   # devcontainer設計.md の Helm バージョンと同期
      - run: |
          for chart in infra/helm/services/*/* infra/helm/services/*/*/*; do
            if [ -f "$chart/Chart.yaml" ]; then
              helm lint "$chart"
            fi
          done

  build:
    needs:
      - test-go
      - test-rust
      - test-ts
      - test-dart
      - test-csharp
    if: always() && !contains(needs.*.result, 'failure')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker images (dry-run)
        run: |
          echo "Build validation passed"

  security-scan:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Trivy filesystem scan
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: fs
          scan-ref: .
          severity: HIGH,CRITICAL
          exit-code: 1
