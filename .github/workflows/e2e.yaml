# .github/workflows/e2e.yaml
# docker-compose 全体起動 + pytest E2E テスト
name: E2E Test

on:
  pull_request:
    branches: [main]
    paths:
      - 'regions/system/**'
      - 'e2e/**'
      - 'docker-compose.yaml'
      - 'infra/**'
  workflow_dispatch:

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install E2E test dependencies
        run: pip install -r e2e/requirements.txt

      - name: Start infrastructure
        run: docker compose --profile infra up -d --wait
        timeout-minutes: 5

      - name: Start system services
        run: docker compose --profile system up -d --wait
        timeout-minutes: 10

      - name: Start observability stack
        run: docker compose --profile observability up -d --wait
        timeout-minutes: 5

      - name: Wait for services to be ready
        run: |
          echo "Waiting for services to become ready..."
          for port in 8083 8084 8085; do
            for i in $(seq 1 30); do
              if curl -sf "http://localhost:${port}/healthz" > /dev/null 2>&1; then
                echo "Service on port ${port} is ready"
                break
              fi
              echo "Waiting for port ${port}... (attempt $i/30)"
              sleep 5
            done
          done

      - name: Run docs compliance tests
        run: pytest e2e/tests/docs_compliance/ --tb=short -q

      - name: Run system API tests
        env:
          AUTH_BASE_URL: http://localhost:8083
          CONFIG_BASE_URL: http://localhost:8084
          SAGA_SERVER_URL: http://localhost:8085
          DLQ_SERVER_URL: http://localhost:8086
          KEYCLOAK_BASE_URL: http://localhost:8180
          KONG_PROXY_URL: http://localhost:8000
          KAFKA_BROKERS: localhost:9092
        run: pytest e2e/tests/system_api/ --tb=short -q

      - name: Collect logs on failure
        if: failure()
        run: |
          docker compose logs --tail=100 > docker-compose-logs.txt 2>&1
          echo "=== Container status ==="
          docker compose ps

      - name: Upload logs artifact
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-logs
          path: docker-compose-logs.txt

      - name: Cleanup
        if: always()
        run: docker compose --profile infra --profile system --profile observability down -v
