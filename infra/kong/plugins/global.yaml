# Global Kong Plugins
# These plugins are applied to all services and routes.

plugins:
  # Rate Limiting - グローバルデフォルト (service Tier: 500 req/min)
  # Tier別デフォルト値: system=3000, business=1000, service=500
  # 環境別倍率: dev=x10, staging=x2, prod=x1
  - name: rate-limiting
    config:
      minute: 500                    # デフォルト（service Tier）
      second: 20                     # 秒あたりの上限（バースト制御）
      policy: redis                  # Redis で共有状態を管理
      redis_host: redis.k1s0-system.svc.cluster.local
      redis_port: 6379
      redis_database: 1
      fault_tolerant: true           # Redis 障害時は制限なしで通過
      hide_client_headers: false     # X-RateLimit-* ヘッダーを返却

  # CORS - クロスオリジンリソース共有
  - name: cors
    config:
      origins:
        - "https://*.k1s0.internal.example.com"
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
        - X-Request-ID
      exposed_headers:
        - X-RateLimit-Limit
        - X-RateLimit-Remaining
        - X-RateLimit-Reset
      max_age: 3600
      credentials: true

  # Prometheus - メトリクス収集
  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true
      latency_metrics: true
      bandwidth_metrics: true

  # File Log - アクセスログ出力
  - name: file-log
    config:
      path: /dev/stdout
      reopen: false

  # Post Function - JWT Claims をバックエンドへのリクエストヘッダーに転送
  - name: post-function
    config:
      header_filter:
        - |
          local jwt = kong.ctx.shared.authenticated_jwt_token
          if jwt then
            kong.service.request.set_header("X-User-Id", jwt.claims.sub)
            kong.service.request.set_header("X-User-Roles", table.concat(jwt.claims.realm_access.roles, ","))
            kong.service.request.set_header("X-User-Email", jwt.claims.email or "")
          end
