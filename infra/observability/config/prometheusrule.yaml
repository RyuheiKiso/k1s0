apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: config-server-alerts
  namespace: k1s0-system
  labels:
    app.kubernetes.io/name: config-server
    tier: system
    service: config
spec:
  groups:
    - name: config_server.rules
      rules:
        # High Error Rate
        - alert: config_server_high_error_rate
          expr: |
            (
              sum(rate(http_requests_total{service="config-server", status=~"5.."}[5m]))
              /
              sum(rate(http_requests_total{service="config-server"}[5m]))
            ) > 0.01
          for: 5m
          labels:
            severity: critical
            service: config-server
            tier: system
          annotations:
            summary: "High error rate on config-server"
            description: "Error rate is above 1% for config-server in k1s0-system"

        # High Latency (P99)
        - alert: config_server_high_latency
          expr: |
            histogram_quantile(0.99,
              sum(rate(http_request_duration_seconds_bucket{service="config-server"}[5m])) by (le)
            ) > 0.5
          for: 5m
          labels:
            severity: warning
            service: config-server
            tier: system
          annotations:
            summary: "High P99 latency on config-server"
            description: "P99 latency is above 500ms for config-server in k1s0-system"

        # Pod Restart
        - alert: config_server_pod_restart
          expr: |
            increase(kube_pod_container_status_restarts_total{namespace="k1s0-system", pod=~"config-server.*"}[1h]) > 3
          for: 5m
          labels:
            severity: critical
            service: config-server
            tier: system
          annotations:
            summary: "Pod restarts detected for config-server"
            description: "Pod config-server in k1s0-system has restarted more than 3 times in the last hour"
