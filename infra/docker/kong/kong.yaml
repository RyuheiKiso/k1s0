# infra/docker/kong/kong.yaml（ローカル開発用 declarative config）
# 本番環境の infra/kong/kong.yaml とは異なり、docker-compose サービス名で接続する
_format_version: "3.0"

services:
  - name: auth-v1
    url: http://auth-rust:8080
    routes:
      - name: auth-token-route
        paths:
          - /api/v1/auth
        strip_path: false
      - name: auth-users-route
        paths:
          - /api/v1/users
        strip_path: false
      - name: auth-audit-route
        paths:
          - /api/v1/audit
        strip_path: false

  - name: config-v1
    url: http://config-rust:8080
    routes:
      - name: config-route
        paths:
          - /api/v1/config
        strip_path: false

plugins:
  - name: cors
    config:
      origins:
        - "http://localhost:3000"
      methods:
        - GET
        - POST
        - PUT
        - PATCH
        - DELETE
        - OPTIONS
      headers:
        - Authorization
        - Content-Type
        - X-Request-ID
      credentials: true

  - name: rate-limiting
    config:
      minute: 5000
      policy: local
      fault_tolerant: true

  # JWT Plugin - Keycloak JWKS 連携（Docker用）
  - name: jwt
    config:
      uri_param_names: []
      cookie_names: []
      key_claim_name: kid
      claims_to_verify:
        - exp
      maximum_expiration: 900
      header_names:
        - Authorization

  - name: prometheus
    config:
      per_consumer: true
      status_code_metrics: true

# Consumers - Keycloak JWKS 連携
consumers:
  - username: keycloak
    jwt_secrets:
      - algorithm: RS256
        key: "http://keycloak:8080/realms/k1s0"
