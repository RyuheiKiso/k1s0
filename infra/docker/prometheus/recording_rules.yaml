groups:
  - name: red-recording-rules
    interval: 30s
    rules:
      # リクエストレート（サービス別）
      - record: service:http_requests:rate5m
        expr: sum(rate(http_requests_total[5m])) by (service)

      # エラーレート（サービス別）
      - record: service:http_errors:rate5m
        expr: |
          sum(rate(http_requests_total{status=~"5.."}[5m])) by (service)
          / sum(rate(http_requests_total[5m])) by (service)

      # P99 レイテンシ（サービス別）
      - record: service:http_request_duration_seconds:p99
        expr: |
          histogram_quantile(0.99,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (service, le)
          )

      # P95 レイテンシ（サービス別）
      - record: service:http_request_duration_seconds:p95
        expr: |
          histogram_quantile(0.95,
            sum(rate(http_request_duration_seconds_bucket[5m])) by (service, le)
          )

      # gRPC リクエストレート（サービス別）
      - record: service:grpc_requests:rate5m
        expr: sum(rate(grpc_server_handled_total[5m])) by (service, grpc_service)

      # gRPC エラーレート（サービス別）
      - record: service:grpc_errors:rate5m
        expr: |
          sum(rate(grpc_server_handled_total{grpc_code!="OK"}[5m])) by (service, grpc_service)
          / sum(rate(grpc_server_handled_total[5m])) by (service, grpc_service)

      # gRPC P99 レイテンシ
      - record: service:grpc_handling_seconds:p99
        expr: |
          histogram_quantile(0.99,
            sum(rate(grpc_server_handling_seconds_bucket[5m])) by (service, grpc_service, le)
          )

  - name: slo-recording-rules
    rules:
      - record: slo:availability:ratio
        expr: |
          sum(rate(http_requests_total{status!~"5.."}[30d])) by (namespace, service)
          / sum(rate(http_requests_total[30d])) by (namespace, service)

      - record: slo:error_budget:remaining
        expr: |
          1 - (
            (1 - slo:availability:ratio)
            / (1 - (
              label_replace(
                vector(0.9995) and on() (kube_namespace_labels{namespace="k1s0-system"})
                or vector(0.999),
                "namespace", "$1", "namespace", "(.*)"
              )
            ))
          )
        # system Tier: 可用性目標 99.95% (0.9995)
        # business / service Tier: 可用性目標 99.9% (0.999)
