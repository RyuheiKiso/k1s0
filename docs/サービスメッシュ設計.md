# サービスメッシュ設計

Istio によるサービスメッシュの詳細設計および耐障害性設計を定義する。
Tier アーキテクチャの詳細は [tier-architecture.md](tier-architecture.md) を参照。

## 基本方針

- サービスメッシュは **Istio** を採用する
- サービス間通信の暗号化（mTLS）を必須とする
- トラフィック制御（カナリアリリース・トラフィック分割）を Istio で管理する
- 耐障害性（Circuit Breaker・Retry）をアプリケーション外で統一的に設定する
- Istio Control Plane は `service-mesh` Namespace にデプロイする

---

## D-116: Istio 詳細設計

### VirtualService 設計

VirtualService でサービスへのトラフィックルーティングを定義する。

#### 基本ルーティング

```yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: order-server
  namespace: k1s0-service
spec:
  hosts:
    - order-server
  http:
    - route:
        - destination:
            host: order-server
            port:
              number: 80
      timeout: 10s
      retries:
        attempts: 3
        perTryTimeout: 3s
        retryOn: "5xx,reset,connect-failure,retriable-4xx"
```

#### カナリアリリース

```yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: order-server
  namespace: k1s0-service
spec:
  hosts:
    - order-server
  http:
    - route:
        - destination:
            host: order-server
            subset: stable
          weight: 90
        - destination:
            host: order-server
            subset: canary
          weight: 10
```

#### ヘッダーベースルーティング

テスト用にヘッダーでルーティング先を切り替える。

```yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: order-server
  namespace: k1s0-service
spec:
  hosts:
    - order-server
  http:
    - match:
        - headers:
            x-canary:
              exact: "true"
      route:
        - destination:
            host: order-server
            subset: canary
    - route:
        - destination:
            host: order-server
            subset: stable
```

### DestinationRule 設計

DestinationRule でサブセット定義とロードバランシングポリシーを設定する。

```yaml
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: order-server
  namespace: k1s0-service
spec:
  host: order-server
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        h2UpgradePolicy: UPGRADE
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRequestsPerConnection: 10
    loadBalancer:
      simple: LEAST_REQUEST
    tls:
      mode: ISTIO_MUTUAL
  subsets:
    - name: stable
      labels:
        version: stable
    - name: canary
      labels:
        version: canary
```

### Gateway 設計

外部からのトラフィックを受け付ける Istio Gateway を定義する。

```yaml
apiVersion: networking.istio.io/v1
kind: Gateway
metadata:
  name: k1s0-gateway
  namespace: service-mesh
spec:
  selector:
    istio: ingressgateway
  servers:
    - port:
        number: 443
        name: https
        protocol: HTTPS
      tls:
        mode: SIMPLE
        credentialName: k1s0-tls-cert
      hosts:
        - "api.k1s0.internal.example.com"
        - "*.k1s0.internal.example.com"
    - port:
        number: 80
        name: http
        protocol: HTTP
      hosts:
        - "*.k1s0.internal.example.com"
      tls:
        httpsRedirect: true
```

### トラフィック制御

#### カナリアリリースの段階的ロールアウト

| ステージ | 安定版 | カナリア | 期間    | 判定基準                |
| -------- | ------ | -------- | ------- | ----------------------- |
| 1        | 95%    | 5%       | 30 分   | エラーレート < 1%       |
| 2        | 80%    | 20%      | 1 時間  | P99 レイテンシ正常      |
| 3        | 50%    | 50%      | 2 時間  | SLO 内                  |
| 4        | 0%     | 100%     | -       | 完全切り替え            |

#### トラフィックミラーリング

本番トラフィックのコピーを新バージョンに送信し、レスポンスを検証する（ユーザーには影響しない）。

```yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: order-server
  namespace: k1s0-service
spec:
  hosts:
    - order-server
  http:
    - route:
        - destination:
            host: order-server
            subset: stable
      mirror:
        host: order-server
        subset: canary
      mirrorPercentage:
        value: 10.0
```

### Timeout / Retry ポリシー

#### Tier 別デフォルト値

| Tier     | Timeout | Retry 回数 | perTryTimeout | retryOn                              |
| -------- | ------- | ---------- | ------------- | ------------------------------------ |
| system   | 5s      | 3          | 2s            | `5xx,reset,connect-failure`          |
| business | 10s     | 3          | 3s            | `5xx,reset,connect-failure`          |
| service  | 15s     | 2          | 5s            | `5xx,reset,connect-failure,retriable-4xx` |

#### system Tier のデフォルト

```yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: default-system
  namespace: k1s0-system
spec:
  hosts:
    - "*.k1s0-system.svc.cluster.local"
  http:
    - route:
        - destination:
            host: "*.k1s0-system.svc.cluster.local"
      timeout: 5s
      retries:
        attempts: 3
        perTryTimeout: 2s
        retryOn: "5xx,reset,connect-failure"
```

### mTLS 設定

すべてのサービス間通信で mTLS を強制する。

```yaml
apiVersion: security.istio.io/v1
kind: PeerAuthentication
metadata:
  name: default
  namespace: istio-system
spec:
  mtls:
    mode: STRICT

---
# observability Namespace は PERMISSIVE（Prometheus の scrape を許可）
apiVersion: security.istio.io/v1
kind: PeerAuthentication
metadata:
  name: allow-prometheus
  namespace: observability
spec:
  mtls:
    mode: PERMISSIVE
```

### AuthorizationPolicy

Tier 間のアクセス制御を Istio AuthorizationPolicy で強制する。

```yaml
# system Tier: business/service からのアクセスのみ許可
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-from-lower-tiers
  namespace: k1s0-system
spec:
  rules:
    - from:
        - source:
            namespaces:
              - k1s0-business
              - k1s0-service

---
# business Tier: service からのアクセスのみ許可
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-from-service
  namespace: k1s0-business
spec:
  rules:
    - from:
        - source:
            namespaces:
              - k1s0-service
```

---

## D-118: 耐障害性設計

### Circuit Breaker

Istio の DestinationRule で outlierDetection を設定し、異常なインスタンスを自動的に除外する。

#### Tier 別デフォルト値

| 設定                      | system  | business | service |
| ------------------------- | ------- | -------- | ------- |
| consecutive5xxErrors      | 3       | 5        | 5       |
| interval                  | 10s     | 30s      | 30s     |
| baseEjectionTime          | 30s     | 30s      | 60s     |
| maxEjectionPercent        | 30      | 50       | 50      |

#### system Tier の Circuit Breaker

```yaml
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: auth-server
  namespace: k1s0-system
spec:
  host: auth-server
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 200
      http:
        http1MaxPendingRequests: 200
        http2MaxRequests: 2000
        maxRequestsPerConnection: 20
    outlierDetection:
      consecutive5xxErrors: 3
      interval: 10s
      baseEjectionTime: 30s
      maxEjectionPercent: 30
    tls:
      mode: ISTIO_MUTUAL
```

#### service Tier の Circuit Breaker

```yaml
apiVersion: networking.istio.io/v1
kind: DestinationRule
metadata:
  name: order-server
  namespace: k1s0-service
spec:
  host: order-server
  trafficPolicy:
    connectionPool:
      tcp:
        maxConnections: 100
      http:
        http1MaxPendingRequests: 100
        http2MaxRequests: 1000
        maxRequestsPerConnection: 10
    outlierDetection:
      consecutive5xxErrors: 5
      interval: 30s
      baseEjectionTime: 60s
      maxEjectionPercent: 50
    tls:
      mode: ISTIO_MUTUAL
```

### Retry + Exponential Backoff

Istio VirtualService の retry 設定で自動リトライを行う。Exponential Backoff は Envoy のデフォルト動作（25ms ベース + ジッター）に従う。

```yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: order-server
  namespace: k1s0-service
spec:
  hosts:
    - order-server
  http:
    - route:
        - destination:
            host: order-server
      retries:
        attempts: 3
        perTryTimeout: 5s
        retryOn: "5xx,reset,connect-failure,retriable-4xx"
        retryRemoteLocalities: true
```

### Retry 対象の判定基準

| 対象               | リトライ | 理由                                |
| ------------------ | -------- | ----------------------------------- |
| 5xx                | Yes      | サーバー側の一時的なエラー          |
| connect-failure    | Yes      | ネットワーク接続失敗                |
| reset              | Yes      | 接続リセット                        |
| retriable-4xx      | Yes      | 409 Conflict 等の一時的な 4xx       |
| 400 Bad Request    | No       | クライアント側のリクエスト不正      |
| 401/403            | No       | 認証・認可エラー                    |
| 404 Not Found      | No       | リソースが存在しない                |

### フォールト インジェクション（テスト用）

staging 環境で障害をシミュレートし、耐障害性を検証する。

#### 遅延注入

```yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: order-server-fault-test
  namespace: k1s0-service
spec:
  hosts:
    - order-server
  http:
    - fault:
        delay:
          percentage:
            value: 10.0
          fixedDelay: 5s
      route:
        - destination:
            host: order-server
```

#### 障害注入

```yaml
apiVersion: networking.istio.io/v1
kind: VirtualService
metadata:
  name: order-server-abort-test
  namespace: k1s0-service
spec:
  hosts:
    - order-server
  http:
    - fault:
        abort:
          percentage:
            value: 5.0
          httpStatus: 503
      route:
        - destination:
            host: order-server
```

---

## 関連ドキュメント

- [tier-architecture.md](tier-architecture.md) — Tier アーキテクチャの詳細
- [kubernetes設計.md](kubernetes設計.md) — Namespace・NetworkPolicy 設計
- [インフラ設計.md](インフラ設計.md) — オンプレミスインフラ構成
- [APIゲートウェイ設計.md](APIゲートウェイ設計.md) — Kong 構成管理
- [可観測性設計.md](可観測性設計.md) — 監視・ログ・トレース設計
- [helm設計.md](helm設計.md) — Helm Chart と values 設計
