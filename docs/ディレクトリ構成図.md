# ディレクトリ構成図

k1s0 モノリポの理想的なディレクトリ構成を定義する。
階層アーキテクチャの詳細は [tier-architecture.md](tier-architecture.md) を参照。

## 全体構成

```
k1s0/
├── CLI/                        # Rust製の対話式CLIツール
├── regions/                    # system / business / service の3階層
│   ├── system/                 # 全プロジェクト横断の共通基盤
│   ├── business/               # 部門・業務領域ごとの共通基盤
│   └── service/                # 個別サービスの実装
├── api/                        # プロジェクト横断の API 定義
│   └── proto/                  # 共有プロトコル定義（サービス間で共有）
│       ├── k1s0/
│       │   ├── event/          # イベント定義（メッセージング設計.md 参照）
│       │   │   ├── system/
│       │   │   ├── business/
│       │   │   └── service/
│       │   └── system/
│       │       └── common/
│       │           └── v1/
│       │               ├── types.proto           # 共通型（Pagination, Timestamp 等）
│       │               └── event_metadata.proto  # イベントメタデータ
│       └── buf.yaml            # buf 設定（lint・breaking change 検出）
├── infra/                      # インフラ定義（IaC）
├── e2e/                        # E2Eテスト
├── docs/                       # ドキュメント
├── .devcontainer/
│   └── devcontainer.json       # Dev Container 設定
├── .github/
│   └── workflows/              # CI/CD パイプライン
│       ├── ci.yaml
│       ├── deploy.yaml
│       └── tauri-build.yaml    # Tauri GUI クロスプラットフォームビルド
├── docker-compose.yaml         # ローカル開発用
└── README.md
```

---

## CLI

CLI バイナリ・Tauri GUI・共有ライブラリの 3 コンポーネントで構成する。詳細は [TauriGUI設計](TauriGUI設計.md) を参照。

```
CLI/
├── Cargo.toml                              # workspace メンバー定義
├── crates/
│   └── k1s0-core/                          # 共有ライブラリクレート（CLI・GUI 共用）
│       ├── Cargo.toml
│       └── src/
│           ├── lib.rs
│           ├── commands/                   # init, generate, build, test, deploy
│           │   ├── init.rs                 # プロジェクト初期化
│           │   ├── generate/               # ひな形生成
│           │   │   ├── mod.rs              # エントリーポイント（run + ステートマシン）
│           │   │   ├── types.rs            # 型定義（Kind, Tier, Language 等）
│           │   │   ├── steps.rs            # 対話ステップ関数
│           │   │   ├── execute.rs          # 生成実行・テンプレートエンジン統合
│           │   │   ├── scaffold.rs         # インラインひな形生成
│           │   │   └── helpers.rs          # ヘルパー関数
│           │   ├── build.rs                # ビルド
│           │   ├── test.rs                 # テスト実行
│           │   └── deploy.rs               # デプロイ
│           ├── config/                     # CLI設定の読み込み
│           └── template/                   # Tera テンプレート処理
├── src/                                    # CLI バイナリ
│   ├── main.rs                             # dialoguer による対話 UI
│   └── prompt/                             # 対話式プロンプト（dialoguer）
├── gui/                                    # Tauri GUI アプリケーション
│   ├── src-tauri/
│   │   ├── Cargo.toml                      # k1s0-core を依存に持つ
│   │   ├── src/
│   │   │   ├── main.rs                     # Tauri エントリーポイント
│   │   │   └── commands.rs                 # #[tauri::command] 定義
│   │   └── tauri.conf.json
│   ├── src/                                # React フロントエンド
│   │   ├── App.tsx
│   │   ├── pages/                          # メニュー別ページ
│   │   └── components/
│   ├── package.json
│   └── tsconfig.json
├── templates/                              # scaffold用テンプレート（CLI・GUI 共有）
│   ├── server/
│   │   ├── go/
│   │   └── rust/
│   ├── client/
│   │   ├── react/
│   │   └── flutter/
│   ├── library/
│   │   ├── go/
│   │   ├── rust/
│   │   ├── typescript/
│   │   ├── dart/
│   │   └── csharp/
│   └── database/
└── Cargo.lock
```

---

## regions

### system（最上位 Tier）

全プロジェクトで横断的に利用する共通基盤。client は UI を持たない共通 SDK パッケージとして配置する。

```
regions/system/
├── server/                        # 各サービスは Rust で実装
│   └── rust/
│       └── {サービス名}/
│           └── （Rust サーバー構成）
├── client/                        # UI を持たない共通 SDK パッケージ
│   ├── flutter/
│   │   └── system_client/         # Flutter 共通 SDK（認証・API クライアント・共通 Widget）
│   └── react/
│       └── system-client/         # React 共通 SDK（認証・API クライアント・共通 Component）
├── library/
│   ├── go/
│   │   ├── auth/                  # JWT 検証・OAuth2
│   │   ├── config/                # YAML 設定読み込み
│   │   ├── correlation/           # 相関 ID 管理
│   │   ├── dlq/                   # Kafka DLQ クライアント
│   │   ├── kafka/                 # Kafka 接続管理
│   │   ├── messaging/             # イベント発行・購読
│   │   ├── outbox/                # トランザクショナルアウトボックス
│   │   ├── saga/                  # Saga パターンクライアント
│   │   ├── schemaregistry/        # Schema Registry クライアント
│   │   ├── serviceauth/           # サービス間 OAuth2 認証
│   │   └── telemetry/             # OpenTelemetry 初期化
│   ├── rust/
│   │   ├── auth/                  # JWT 検証・OAuth2
│   │   ├── config/                # YAML 設定読み込み
│   │   ├── correlation/           # 相関 ID 管理
│   │   ├── dlq/                   # Kafka DLQ クライアント
│   │   ├── kafka/                 # Kafka 接続管理
│   │   ├── messaging/             # イベント発行・購読
│   │   ├── outbox/                # トランザクショナルアウトボックス
│   │   ├── saga/                  # Saga パターンクライアント
│   │   ├── schemaregistry/        # Schema Registry クライアント
│   │   ├── serviceauth/           # サービス間 OAuth2 認証
│   │   └── telemetry/             # OpenTelemetry 初期化
│   ├── typescript/
│   │   ├── auth/                  # JWT 検証・OAuth2
│   │   ├── config/                # YAML 設定読み込み
│   │   ├── correlation/           # 相関 ID 管理
│   │   ├── dlq-client/            # Kafka DLQ クライアント
│   │   ├── kafka/                 # Kafka 接続管理
│   │   ├── messaging/             # イベント発行・購読
│   │   ├── outbox/                # トランザクショナルアウトボックス
│   │   ├── saga/                  # Saga パターンクライアント
│   │   ├── schemaregistry/        # Schema Registry クライアント
│   │   ├── serviceauth/           # サービス間 OAuth2 認証
│   │   └── telemetry/             # OpenTelemetry 初期化
│   ├── dart/
│   │   ├── auth/                  # JWT 検証・OAuth2
│   │   ├── config/                # YAML 設定読み込み
│   │   ├── correlation/           # 相関 ID 管理
│   │   ├── dlq_client/            # Kafka DLQ クライアント
│   │   ├── kafka/                 # Kafka 接続管理
│   │   ├── messaging/             # イベント発行・購読
│   │   ├── outbox/                # トランザクショナルアウトボックス
│   │   ├── saga/                  # Saga パターンクライアント
│   │   ├── schemaregistry/        # Schema Registry クライアント
│   │   ├── serviceauth/           # サービス間 OAuth2 認証
│   │   └── telemetry/             # OpenTelemetry 初期化
│   └── csharp/
│       ├── auth/                  # JWT 検証・OAuth2
│       ├── config/                # YAML 設定読み込み
│       ├── correlation/           # 相関 ID 管理
│       ├── dlq-client/            # Kafka DLQ クライアント
│       ├── kafka/                 # Kafka 接続管理
│       ├── messaging/             # イベント発行・購読
│       ├── outbox/                # トランザクショナルアウトボックス
│       ├── saga/                  # Saga パターンクライアント
│       ├── schemaregistry/        # Schema Registry クライアント
│       ├── serviceauth/           # サービス間 OAuth2 認証
│       └── telemetry/             # OpenTelemetry 初期化
└── database/
    └── {データベース名}/           # 例: auth-db
        └── （データベース構成）
```

### business（中位 Tier）

部門名・業務領域ごとにディレクトリを切る。

```
regions/business/
└── {領域名}/                       # 例: accounting, fa
    ├── server/                    # 各サービスは Rust で実装
    │   └── rust/
    │       └── {サービス名}/
    │           └── （Rust サーバー構成）
    ├── client/
    │   ├── react/
    │   │   └── {アプリ名}/
    │   │       └── （React クライアント構成）
    │   └── flutter/
    │       └── {アプリ名}/
    │           └── （Flutter クライアント構成）
    ├── library/
    │   ├── go/
    │   │   └── {ライブラリ名}/
    │   │       └── （Go ライブラリ構成）
    │   ├── rust/
    │   │   └── {ライブラリ名}/
    │   │       └── （Rust ライブラリ構成）
    │   ├── typescript/
    │   │   └── {ライブラリ名}/
    │   │       └── （TypeScript ライブラリ構成）
    │   ├── dart/
    │   │   └── {ライブラリ名}/
    │   │       └── （Dart ライブラリ構成）
    │   └── csharp/
    │       └── {ライブラリ名}/
    │           └── （C# ライブラリ構成）
    └── database/
        └── {データベース名}/
            └── （データベース構成）
```

### service（最下位 Tier）

実際にデプロイ・稼働する個別サービス。

```
regions/service/
└── {サービス名}/                   # 例: order, inventory
    ├── server/                    # Rust を配置
    │   └── rust/
    │       ├── （Rust サーバー構成）
    │       └── bff/               # GraphQL BFF（オプション。API設計.md の導入基準を満たす場合）
    │           └── （Rust BFF 構成）
    ├── client/
    │   ├── react/
    │   │   └── （React クライアント構成）
    │   └── flutter/
    │       └── （Flutter クライアント構成）
    └── database/
        └── {データベース名}/
            └── （データベース構成）
```

---

## サーバー内部構成（クリーンアーキテクチャ）

### Rust サーバー構成

```
{サービス名}/
├── src/
│   ├── main.rs                     # エントリーポイント
│   ├── domain/                     # ドメイン層
│   │   ├── model/                  # Entity・Value Object
│   │   ├── repository/             # Repository トレイト
│   │   └── service/                # ドメインサービス
│   ├── usecase/                    # ユースケース層
│   ├── adapter/                    # インターフェースアダプター層
│   │   ├── handler/                # HTTP / gRPC ハンドラー
│   │   ├── presenter/              # レスポンス整形
│   │   └── gateway/                # 外部サービス呼び出し
│   └── infra/                      # インフラストラクチャ層
│       ├── persistence/            # DB 実装
│       ├── messaging/              # Kafka プロデューサー / コンシューマー
│       └── config/                 # YAML 設定読み込み
├── tests/                          # 統合テスト・テストヘルパーを格納（ユニットテストは src/ 内に #[cfg(test)] で配置）
│   ├── integration/                # 統合テスト
│   └── testutil/                   # テストヘルパー・フィクスチャ
├── api/
│   ├── openapi/                    # OpenAPI 定義
│   ├── proto/                      # protobuf 定義
│   └── graphql/                    # GraphQL スキーマ定義
├── config/
│   ├── config.yaml                 # アプリケーション設定
│   ├── config.dev.yaml             # 開発環境設定
│   ├── config.staging.yaml         # ステージング環境設定
│   └── config.prod.yaml            # 本番環境設定
├── Dockerfile
├── Cargo.toml
└── Cargo.lock
```

---

## クライアント内部構成

### React クライアント構成

```
{アプリ名}/
├── src/
│   ├── app/                        # ルーティング・レイアウト
│   ├── features/                   # 機能単位のモジュール
│   │   └── {機能名}/
│   │       ├── components/
│   │       ├── hooks/
│   │       ├── api/
│   │       └── types/
│   ├── components/                 # 共通UIコンポーネント
│   ├── hooks/                      # 共通フック
│   ├── lib/                        # ユーティリティ
│   └── types/                      # 共通型定義
├── tests/                          # テストコード（ソースと分離）
│   ├── unit/                       # ユニットテスト
│   ├── integration/                # 統合テスト
│   └── testutil/                   # テストヘルパー・モック
├── public/
├── package.json
└── Dockerfile
```

### Flutter クライアント構成

```
{アプリ名}/
├── lib/
│   ├── app/                        # ルーティング・テーマ
│   ├── features/                   # 機能単位のモジュール
│   │   └── {機能名}/
│   │       ├── presentation/
│   │       ├── application/
│   │       └── data/
│   ├── widgets/                    # 共通ウィジェット
│   └── utils/                      # ユーティリティ
├── test/                           # テストコード（ソースと分離）
│   ├── unit/                       # ユニットテスト
│   ├── widget/                     # ウィジェットテスト
│   └── testutil/                   # テストヘルパー・モック
├── pubspec.yaml
└── Dockerfile
```

---

## ライブラリ内部構成

### Rust ライブラリ構成

```
{ライブラリ名}/
├── src/
│   ├── lib.rs                      # エントリーポイント
│   ├── {モジュール名}/             # 機能単位のモジュール
│   │   ├── mod.rs
│   │   └── *.rs
│   └── internal/                   # 非公開の内部実装（pub(crate)）
│       └── *.rs
├── tests/                          # 統合テスト・テストヘルパーを格納（ユニットテストは src/ 内に #[cfg(test)] で配置）
│   ├── integration/                # 統合テスト
│   └── testutil/                   # テストヘルパー・フィクスチャ
└── Cargo.toml
```

### TypeScript ライブラリ構成

```
{ライブラリ名}/
├── src/
│   ├── index.ts                    # エントリーポイント
│   └── {モジュール名}/             # 機能単位のモジュール
│       └── *.ts
├── tests/
│   ├── unit/                       # ユニットテスト
│   └── testutil/                   # テストヘルパー・モック
├── package.json
└── tsconfig.json
```

### Dart ライブラリ構成

```
{ライブラリ名}/
├── lib/
│   ├── {ライブラリ名}.dart          # エントリーポイント
│   └── src/                        # 内部実装
│       └── *.dart
├── test/
│   ├── unit/                       # ユニットテスト
│   └── testutil/                   # テストヘルパー・モック
├── pubspec.yaml
└── analysis_options.yaml
```

### C# ライブラリ構成

```
{ライブラリ名}/
├── src/
│   ├── {ライブラリ名}.csproj        # プロジェクトファイル
│   └── *.cs                        # 公開 API・内部実装
├── tests/
│   ├── {ライブラリ名}.Tests.csproj   # テストプロジェクトファイル
│   ├── Unit/                       # ユニットテスト
│   │   └── *Tests.cs
│   └── Integration/                # 統合テスト
│       └── *IntegrationTests.cs
├── {ライブラリ名}.sln
└── .editorconfig
```

---

## データベース構成

```
{データベース名}/
├── migrations/                     # マイグレーションファイル（連番管理）
│   ├── 001_create_xxx.up.sql
│   └── 001_create_xxx.down.sql
├── seeds/                          # 初期データ投入
└── schema/                         # スキーマ定義（参照用）
```

RDBMS は階層・サービスの要件に応じて PostgreSQL / MySQL / SQLite から選択する。

---

## infra

```
infra/
├── terraform/                      # インフラのコード管理
│   ├── environments/
│   │   ├── dev/
│   │   ├── staging/
│   │   └── prod/
│   └── modules/
├── helm/                           # Kubernetes マニフェストテンプレート
│   ├── charts/
│   │   └── k1s0-common/            # Library Chart（共通テンプレート）
│   │       ├── Chart.yaml
│   │       └── templates/
│   │           ├── _deployment.tpl
│   │           ├── _service.tpl
│   │           ├── _hpa.tpl
│   │           ├── _pdb.tpl
│   │           ├── _configmap.tpl
│   │           ├── _ingress.tpl
│   │           └── _helpers.tpl
│   └── services/
│       ├── system/
│       │   └── {サービス名}/        # 例: auth
│       │       ├── Chart.yaml
│       │       ├── values.yaml
│       │       ├── values-dev.yaml
│       │       ├── values-staging.yaml
│       │       ├── values-prod.yaml
│       │       └── templates/
│       ├── business/
│       │   └── {領域名}/
│       │       └── {サービス名}/    # 例: accounting/ledger
│       │           ├── Chart.yaml
│       │           ├── values.yaml
│       │           ├── values-dev.yaml
│       │           ├── values-staging.yaml
│       │           ├── values-prod.yaml
│       │           └── templates/
│       └── service/
│           └── {サービス名}/        # 例: order
│               ├── Chart.yaml
│               ├── values.yaml
│               ├── values-dev.yaml
│               ├── values-staging.yaml
│               ├── values-prod.yaml
│               └── templates/
├── kong/                           # Kong API Gateway 設定
│   ├── kong.yaml                   # メイン設定ファイル（decK 形式）
│   ├── plugins/                    # プラグイン設定
│   │   ├── global.yaml             # グローバルプラグイン
│   │   └── auth.yaml               # 認証プラグイン
│   └── services/                   # Tier 別サービス定義
│       ├── system.yaml
│       ├── business.yaml
│       └── service.yaml
├── docker/                         # 共通 Docker 設定
│   ├── base-images/
│   ├── init-db/                    # PostgreSQL 初期化スクリプト
│   ├── prometheus/                 # Prometheus 設定ファイル
│   └── grafana/                    # Grafana プロビジョニング設定
└── istio/                          # サービスメッシュ CRD 定義（kubectl apply または Terraform kubernetes_manifest で管理。Istio 本体の Helm デプロイは terraform設計.md を参照）
    ├── gateway.yaml
    └── virtual-service.yaml
```

---

## e2e

```
e2e/
├── tests/                          # テストケース
│   └── {テストスイート名}/
│       └── test_*.py
├── fixtures/                       # テストデータ
├── conftest.py                     # pytest 共通設定
├── requirements.txt
└── pytest.ini
```

---

## docs

```
docs/
├── diagrams/                       # 図表（drawio / svg）
├── CLIフロー.md                    # CLI操作フロー定義
├── コンセプト.md                   # プロジェクトの目的・技術スタック
├── tier-architecture.md            # 階層アーキテクチャ設計
├── ディレクトリ構成図.md           # 本ドキュメント
├── コーディング規約.md             # Linter・Formatter・命名規則
├── config設計.md                   # config.yaml スキーマ・環境別管理
├── devcontainer設計.md             # Dev Container 設定
├── docker-compose設計.md           # ローカル開発用 Compose 設計
├── インフラ設計.md                 # オンプレミスインフラ構成
├── terraform設計.md                # Terraform モジュール設計
├── Dockerイメージ戦略.md           # イメージビルド・タグ・レジストリ
├── kubernetes設計.md               # Kubernetes リソース設計
├── helm設計.md                     # Helm Chart・values 設計
├── API設計.md                      # REST API・gRPC・GraphQL・レート制限・コード生成
├── 認証認可設計.md                 # 認証・認可・シークレット管理
├── CI-CD設計.md                    # GitHub Actions CI/CD パイプライン
├── 可観測性設計.md                 # 監視・アラート・SLO/SLA・構造化ログ
├── サービスメッシュ設計.md         # Istio 詳細設計・耐障害性
├── APIゲートウェイ設計.md          # Kong 構成管理
├── メッセージング設計.md           # Kafka トピック・イベント駆動アーキテクチャ
├── テンプレート仕様-サーバー.md    # サーバーテンプレート（Rust axum）
├── テンプレート仕様-クライアント.md # クライアントテンプレート（React / Flutter）
├── テンプレート仕様-ライブラリ.md  # ライブラリテンプレート（Go / Rust / TS / Dart）
├── テンプレート仕様-データベース.md # データベースマイグレーションテンプレート
├── テンプレートエンジン仕様.md     # Tera テンプレートエンジン・変数・条件分岐
└── TauriGUI設計.md                # Tauri GUI デスクトップアプリケーション設計
```

---

## 設計上の補足

- **環境変数の直接参照は禁止** — 各サーバーは `config/config.yaml` で設定を一元管理する。ただし config ローダー内での環境変数参照、テスト用のフィクスチャやヘルパー、Kubernetes の ConfigMap / Secret による注入、および CI/CD パイプラインでの環境変数設定は例外とする
- **依存方向は下位→上位の一方向のみ** — service → business → system。全 Tier から system への直接依存は許可される（service → system の直接通信は business を経由しなくてよい）。逆方向の依存は禁止。同階層間の通信は原則禁止だが、[tier-architecture.md](tier-architecture.md) に定義された例外ルール（system 層内の共通基盤サービス間通信、business 層の同一ドメインコンテキスト内の同期通信、異なるドメインコンテキスト間のメッセージング経由の間接通信等）は許容される
- **データベースへのアクセスはその階層の server のみ** — 他階層のデータが必要な場合は API（gRPC 等）を経由する
- **system/client は UI を持たない共通 SDK** — system/client はエンドユーザー向けの画面アプリではなく、business/service client が import して使う共有ライブラリパッケージ（認証・API クライアント・共通 Widget・ルーティングガード）を提供する。エンドユーザー向けのアプリは business/service 以下で実装する
- **service 層に library がない理由** — service は独立してデプロイ・稼働する最小単位であり、他サービスとコードを共有しない。複数サービスで共通化すべきコードが生じた場合は、上位層（business または system）の library に昇格させる
- **ソースコードとテストコードの分離** — テストコードは `tests/`（Flutter / Dart は `test/`）ディレクトリに分離する。ただし Go はユニットテスト（`*_test.go`）をソースと同一パッケージに配置、Rust はユニットテスト（`#[cfg(test)]`）をソースと同一ファイルに配置する言語慣習に従い、統合テスト・テストヘルパーのみ `tests/` に分離する。C# は `tests/` ディレクトリに別プロジェクト（`.Tests.csproj`）として配置し、`Unit/` と `Integration/` で分離する

## 関連ドキュメント

- [tier-architecture](tier-architecture.md)
- [API設計](API設計.md)
- [proto設計](proto設計.md) — Protobuf スキーマ定義・gRPC サービス定義・buf 設定
- [CLIフロー](CLIフロー.md)
- [docker-compose設計](docker-compose設計.md)
- [テンプレート仕様-サーバー](テンプレート仕様-サーバー.md)
- [テンプレート仕様-クライアント](テンプレート仕様-クライアント.md)
- [テンプレート仕様-ライブラリ](テンプレート仕様-ライブラリ.md)
- [テンプレート仕様-データベース](テンプレート仕様-データベース.md)
- [テンプレートエンジン仕様](テンプレートエンジン仕様.md)
- [TauriGUI設計](TauriGUI設計.md)
