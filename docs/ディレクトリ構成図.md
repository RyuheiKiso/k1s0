# ディレクトリ構成図

k1s0 モノリポの理想的なディレクトリ構成を定義する。
階層アーキテクチャの詳細は [tier-architecture.md](tier-architecture.md) を参照。

## 全体構成

```
k1s0/
├── CLI/                        # Rust製の対話式CLIツール
├── regions/                    # system / business / service の3階層
│   ├── system/                 # 全プロジェクト横断の共通基盤
│   ├── business/               # 部門・業務領域ごとの共通基盤
│   └── service/                # 個別サービスの実装
├── infra/                      # インフラ定義（IaC）
├── e2e/                        # E2Eテスト
├── docs/                       # ドキュメント
├── .devcontainer/
│   └── devcontainer.json       # Dev Container 設定
├── .github/
│   └── workflows/              # CI/CD パイプライン
│       ├── ci.yaml
│       └── deploy.yaml
├── docker-compose.yaml         # ローカル開発用
└── README.md
```

---

## CLI

```
CLI/
├── src/
│   ├── main.rs
│   ├── commands/               # サブコマンド定義
│   │   ├── init.rs             # プロジェクト初期化
│   │   ├── generate.rs         # ひな形生成
│   │   ├── build.rs            # ビルド
│   │   ├── test.rs             # テスト実行
│   │   └── deploy.rs           # デプロイ
│   ├── config/                 # CLI設定の読み込み
│   └── prompt/                 # 対話式プロンプト（dialoguer）
├── templates/                  # scaffold用テンプレート
│   ├── server/
│   │   ├── go/
│   │   └── rust/
│   ├── client/
│   │   ├── react/
│   │   └── flutter/
│   ├── library/
│   │   ├── go/
│   │   ├── rust/
│   │   ├── ts/
│   │   └── dart/
│   └── database/
├── Cargo.toml
└── Cargo.lock
```

---

## regions

### system（最上位層）

全プロジェクトで横断的に利用する共通基盤。client は持たない。

```
regions/system/
├── server/                        # 各サービスは Go または Rust のいずれかで実装
│   ├── go/
│   │   └── {サービス名}/           # 例: auth, gateway
│   │       └── （Go サーバー構成）
│   └── rust/
│       └── {サービス名}/
│           └── （Rust サーバー構成）
├── library/
│   ├── go/
│   │   └── {ライブラリ名}/         # 例: authlib, telemetry
│   │       └── （Go ライブラリ構成）
│   ├── rust/
│   │   └── {ライブラリ名}/
│   │       └── （Rust ライブラリ構成）
│   ├── ts/
│   │   └── {ライブラリ名}/
│   │       └── （TypeScript ライブラリ構成）
│   └── dart/
│       └── {ライブラリ名}/
│           └── （Dart ライブラリ構成）
└── database/
    └── {データベース名}/           # 例: auth-db
        └── （データベース構成）
```

### business（中位層）

部門名・業務領域ごとにディレクトリを切る。

```
regions/business/
└── {領域名}/                       # 例: accounting, fa
    ├── server/                    # 各サービスは Go または Rust のいずれかで実装
    │   ├── go/
    │   │   └── {サービス名}/
    │   │       └── （Go サーバー構成）
    │   └── rust/
    │       └── {サービス名}/
    │           └── （Rust サーバー構成）
    ├── client/
    │   ├── react/
    │   │   └── {アプリ名}/
    │   │       └── （React クライアント構成）
    │   └── flutter/
    │       └── {アプリ名}/
    │           └── （Flutter クライアント構成）
    ├── library/
    │   ├── go/
    │   │   └── {ライブラリ名}/
    │   │       └── （Go ライブラリ構成）
    │   ├── rust/
    │   │   └── {ライブラリ名}/
    │   │       └── （Rust ライブラリ構成）
    │   ├── ts/
    │   │   └── {ライブラリ名}/
    │   │       └── （TypeScript ライブラリ構成）
    │   └── dart/
    │       └── {ライブラリ名}/
    │           └── （Dart ライブラリ構成）
    └── database/
        └── {データベース名}/
            └── （データベース構成）
```

### service（最下位層）

実際にデプロイ・稼働する個別サービス。

```
regions/service/
└── {サービス名}/                   # 例: order, inventory
    ├── server/                    # Go または Rust のいずれかを配置
    │   ├── go/
    │   │   └── （Go サーバー構成）
    │   └── rust/
    │       └── （Rust サーバー構成）
    ├── client/
    │   ├── react/
    │   │   └── （React クライアント構成）
    │   └── flutter/
    │       └── （Flutter クライアント構成）
    └── database/
        └── {データベース名}/
            └── （データベース構成）
```

---

## サーバー内部構成（クリーンアーキテクチャ）

### Go サーバー構成

```
{サービス名}/
├── cmd/
│   └── main.go                     # エントリーポイント
├── internal/                       # ユニットテスト（*_test.go）はソースと同一パッケージに配置
│   ├── domain/                     # ドメイン層
│   │   ├── model/                  # Entity・Value Object
│   │   ├── repository/             # Repository インターフェース
│   │   └── service/                # ドメインサービス
│   ├── usecase/                    # ユースケース層
│   ├── adapter/                    # インターフェースアダプター層
│   │   ├── handler/                # HTTP / gRPC ハンドラー
│   │   ├── presenter/              # レスポンス整形
│   │   └── gateway/                # 外部サービス呼び出し
│   └── infra/                      # インフラストラクチャ層
│       ├── persistence/            # DB 実装
│       ├── messaging/              # Kafka プロデューサー / コンシューマー
│       └── config/                 # YAML 設定読み込み
├── tests/
│   ├── integration/                # 統合テスト
│   └── testutil/                   # テストヘルパー・フィクスチャ
├── api/
│   ├── openapi/                    # OpenAPI 定義
│   ├── proto/                      # protobuf 定義
│   └── graphql/                    # GraphQL スキーマ定義
├── config/
│   └── config.yaml                 # アプリケーション設定
├── Dockerfile
├── go.mod
└── go.sum
```

### Rust サーバー構成

```
{サービス名}/
├── src/
│   ├── main.rs                     # エントリーポイント
│   ├── domain/                     # ドメイン層
│   │   ├── model/                  # Entity・Value Object
│   │   ├── repository/             # Repository トレイト
│   │   └── service/                # ドメインサービス
│   ├── usecase/                    # ユースケース層
│   ├── adapter/                    # インターフェースアダプター層
│   │   ├── handler/                # HTTP / gRPC ハンドラー
│   │   ├── presenter/              # レスポンス整形
│   │   └── gateway/                # 外部サービス呼び出し
│   └── infra/                      # インフラストラクチャ層
│       ├── persistence/            # DB 実装
│       ├── messaging/              # Kafka プロデューサー / コンシューマー
│       └── config/                 # YAML 設定読み込み
├── tests/                          # 統合テスト・テストヘルパーを格納（ユニットテストは src/ 内に #[cfg(test)] で配置）
│   ├── integration/                # 統合テスト
│   └── testutil/                   # テストヘルパー・フィクスチャ
├── api/
│   ├── openapi/                    # OpenAPI 定義
│   ├── proto/                      # protobuf 定義
│   └── graphql/                    # GraphQL スキーマ定義
├── config/
│   └── config.yaml                 # アプリケーション設定
├── Dockerfile
├── Cargo.toml
└── Cargo.lock
```

---

## クライアント内部構成

### React クライアント構成

```
{アプリ名}/
├── src/
│   ├── app/                        # ルーティング・レイアウト
│   ├── features/                   # 機能単位のモジュール
│   │   └── {機能名}/
│   │       ├── components/
│   │       ├── hooks/
│   │       ├── api/
│   │       └── types/
│   ├── components/                 # 共通UIコンポーネント
│   ├── hooks/                      # 共通フック
│   ├── lib/                        # ユーティリティ
│   └── types/                      # 共通型定義
├── tests/                          # テストコード（ソースと分離）
│   ├── unit/                       # ユニットテスト
│   ├── integration/                # 統合テスト
│   └── testutil/                   # テストヘルパー・モック
├── public/
├── package.json
└── Dockerfile
```

### Flutter クライアント構成

```
{アプリ名}/
├── lib/
│   ├── app/                        # ルーティング・テーマ
│   ├── features/                   # 機能単位のモジュール
│   │   └── {機能名}/
│   │       ├── presentation/
│   │       ├── application/
│   │       └── data/
│   ├── widgets/                    # 共通ウィジェット
│   └── utils/                      # ユーティリティ
├── test/                           # テストコード（ソースと分離）
│   ├── unit/                       # ユニットテスト
│   ├── widget/                     # ウィジェットテスト
│   └── testutil/                   # テストヘルパー・モック
├── pubspec.yaml
└── Dockerfile
```

---

## ライブラリ内部構成

### Go ライブラリ構成

```
{ライブラリ名}/
├── {パッケージ名}/                 # 公開パッケージ（例: auth, trace）。*_test.go を同一パッケージに配置
│   └── *.go
├── internal/                       # 非公開の内部実装
│   └── *.go
├── tests/
│   ├── integration/                # 統合テスト
│   └── testutil/                   # テストヘルパー・フィクスチャ
├── go.mod
└── go.sum
```

### Rust ライブラリ構成

```
{ライブラリ名}/
├── src/
│   ├── lib.rs                      # エントリーポイント
│   ├── {モジュール名}/             # 機能単位のモジュール
│   │   ├── mod.rs
│   │   └── *.rs
│   └── internal/                   # 非公開の内部実装（pub(crate)）
│       └── *.rs
├── tests/                          # 統合テスト・テストヘルパーを格納（ユニットテストは src/ 内に #[cfg(test)] で配置）
│   ├── integration/                # 統合テスト
│   └── testutil/                   # テストヘルパー・フィクスチャ
└── Cargo.toml
```

### TypeScript ライブラリ構成

```
{ライブラリ名}/
├── src/
│   ├── index.ts                    # エントリーポイント
│   └── {モジュール名}/             # 機能単位のモジュール
│       └── *.ts
├── tests/
│   ├── unit/                       # ユニットテスト
│   └── testutil/                   # テストヘルパー・モック
├── package.json
└── tsconfig.json
```

### Dart ライブラリ構成

```
{ライブラリ名}/
├── lib/
│   ├── {ライブラリ名}.dart          # エントリーポイント
│   └── src/                        # 内部実装
│       └── *.dart
├── test/
│   ├── unit/                       # ユニットテスト
│   └── testutil/                   # テストヘルパー・モック
├── pubspec.yaml
└── analysis_options.yaml
```

---

## データベース構成

```
{データベース名}/
├── migrations/                     # マイグレーションファイル（連番管理）
│   ├── 001_create_xxx.up.sql
│   └── 001_create_xxx.down.sql
├── seeds/                          # 初期データ投入
└── schema/                         # スキーマ定義（参照用）
```

RDBMS は階層・サービスの要件に応じて PostgreSQL / MySQL / SQL Server / SQLite から選択する。

---

## infra

```
infra/
├── terraform/                      # インフラのコード管理
│   ├── environments/
│   │   ├── dev/
│   │   ├── staging/
│   │   └── prod/
│   └── modules/
├── helm/                           # Kubernetes マニフェストテンプレート
│   └── {サービス名}/
│       ├── Chart.yaml
│       ├── values.yaml
│       └── templates/
├── docker/                         # 共通 Docker 設定
│   └── base-images/
└── istio/                          # サービスメッシュ設定
    ├── gateway.yaml
    └── virtual-service.yaml
```

---

## e2e

```
e2e/
├── tests/                          # テストケース
│   └── {テストスイート名}/
│       └── test_*.py
├── fixtures/                       # テストデータ
├── conftest.py                     # pytest 共通設定
├── requirements.txt
└── pytest.ini
```

---

## docs

```
docs/
├── diagrams/                       # 図表（drawio / svg）
├── CLIフロー.md                    # CLI操作フロー定義
├── コンセプト.md
├── tier-architecture.md
└── ディレクトリ構成図.md           # 本ドキュメント
```

---

## 設計上の補足

- **環境変数の直接参照は禁止** — 各サーバーは `config/config.yaml` で設定を一元管理する。ただし Kubernetes の ConfigMap / Secret による注入および CI/CD パイプラインでの環境変数設定は例外とする
- **依存方向は下位→上位の一方向のみ** — service → business → system。逆方向・同階層間の直接依存は禁止
- **データベースへのアクセスはその階層の server のみ** — 他階層のデータが必要な場合は API（gRPC 等）を経由する
- **system 層に client がない理由** — system は基盤提供が目的であり、ユーザー向け画面を持たない。client は business 以下で実装する
- **service 層に library がない理由** — service は独立してデプロイ・稼働する最小単位であり、他サービスとコードを共有しない。複数サービスで共通化すべきコードが生じた場合は、上位層（business または system）の library に昇格させる
- **ソースコードとテストコードの分離** — テストコードは `tests/`（Flutter / Dart は `test/`）ディレクトリに分離する。ただし Go はユニットテスト（`*_test.go`）をソースと同一パッケージに配置、Rust はユニットテスト（`#[cfg(test)]`）をソースと同一ファイルに配置する言語慣習に従い、統合テスト・テストヘルパーのみ `tests/` に分離する
