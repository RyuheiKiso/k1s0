# 可観測性 - トレーシング設計

D-110: 分散トレーシング設計。OpenTelemetry SDK 初期化パターン、自動インストルメンテーション、カスタムスパンガイドラインを定義する。

元ドキュメント: [可観測性設計.md](可観測性設計.md)

---

## D-110: 分散トレーシング設計（OpenTelemetry）

### OpenTelemetry SDK 初期化パターン

#### Go

```go
package otel

import (
    "context"

    "go.opentelemetry.io/otel"
    "go.opentelemetry.io/otel/exporters/otlp/otlptrace/otlptracegrpc"
    "go.opentelemetry.io/otel/sdk/resource"
    sdktrace "go.opentelemetry.io/otel/sdk/trace"
    semconv "go.opentelemetry.io/otel/semconv/v1.21.0"
)

func initTracer(ctx context.Context, serviceName string) (*sdktrace.TracerProvider, error) {
    exporter, err := otlptracegrpc.New(ctx)
    if err != nil {
        return nil, err
    }
    tp := sdktrace.NewTracerProvider(
        sdktrace.WithBatcher(exporter),
        sdktrace.WithResource(resource.NewWithAttributes(
            semconv.SchemaURL,
            semconv.ServiceNameKey.String(serviceName),
        )),
    )
    otel.SetTracerProvider(tp)
    return tp, nil
}
```

#### Rust

```rust
use opentelemetry::global;
use opentelemetry_otlp::SpanExporter;
use opentelemetry_sdk::{trace as sdktrace, Resource};
use std::error::Error;

fn init_tracer(service_name: &str) -> Result<sdktrace::TracerProvider, Box<dyn Error>> {
    let exporter = SpanExporter::builder()
        .with_tonic()
        .build()?;
    let provider = sdktrace::TracerProvider::builder()
        .with_batch_exporter(exporter)
        .with_resource(Resource::builder()
            .with_service_name(service_name)
            .build())
        .build();
    global::set_tracer_provider(provider.clone());
    Ok(provider)
}
```

### 自動インストルメンテーション

| 言語 | ライブラリ                | 用途                                           |
| ---- | ------------------------- | ---------------------------------------------- |
| Go   | `otelhttp` ミドルウェア   | HTTP サーバー/クライアントの自動スパン生成      |
| Rust | `tracing-opentelemetry`   | `tracing` クレートとの統合によるスパン自動生成  |

### カスタムスパン ガイドライン

ビジネスロジックの重要な処理にはカスタムスパンを追加し、処理の可視性を高める。

**カスタムスパンを追加すべき箇所:**
- 外部サービス呼び出し（gRPC / HTTP クライアント）
- データベースクエリ（特に複雑なトランザクション）
- Kafka メッセージの Produce / Consume
- Saga の各ステップ実行
- キャッシュの読み書き

**Go でのカスタムスパン例:**

```go
func (s *OrderService) CreateOrder(ctx context.Context, input CreateOrderInput) (*Order, error) {
    ctx, span := otel.Tracer("order-server").Start(ctx, "OrderService.CreateOrder")
    defer span.End()

    span.SetAttributes(
        attribute.String("order.customer_id", input.CustomerID),
        attribute.Int("order.item_count", len(input.Items)),
    )

    // ビジネスロジック...
}
```

**Rust でのカスタムスパン例:**

```rust
#[tracing::instrument(skip(self), fields(order.customer_id = %input.customer_id))]
async fn create_order(&self, input: CreateOrderInput) -> Result<Order, AppError> {
    tracing::info!("Creating order");
    // ビジネスロジック...
}
```

---

## 関連ドキュメント

- [可観測性設計.md](可観測性設計.md) -- 基本方針・概要
- [可観測性-監視アラート設計.md](可観測性-監視アラート設計.md) -- 監視・アラート設計
- [可観測性-SLO設計.md](可観測性-SLO設計.md) -- SLO/SLA・エラーバジェット
- [可観測性-ログ設計.md](可観測性-ログ設計.md) -- 構造化ログ・Loki
