# インフラ設計（オンプレミス）

k1s0 はオンプレミス環境で運用する。本ドキュメントではインフラ構成の全体像を定義する。

## 基本方針

- すべてのサービスをオンプレミス Kubernetes クラスタ上で稼働させる
- コンテナイメージは Harbor（プライベートレジストリ）で管理する
- Infrastructure as Code（Terraform + Ansible）で構成を管理する
- 3環境（dev / staging / prod）を運用する

## 全体構成図

```
┌─────────────────────────────────────────────────────────────────┐
│  オンプレミス データセンター                                    │
│                                                                 │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐       │
│  │ dev クラスタ   │  │ staging       │  │ prod クラスタ  │       │
│  │ (Kubernetes)  │  │ クラスタ      │  │ (Kubernetes)  │       │
│  │               │  │ (Kubernetes)  │  │               │       │
│  │ Master x1     │  │               │  │ Master x3     │       │
│  │ Worker x2     │  │ Master x1     │  │ Worker x5+    │       │
│  └───────────────┘  │ Worker x3     │  └───────────────┘       │
│                      └───────────────┘                          │
│                                                                 │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ 共有サービス                                         │       │
│  │  Vault     (シークレット管理)                        │       │
│  │  Consul    (Terraform State 管理)                    │       │
│  │  GitLab / GitHub Enterprise (ソースコード管理)       │       │
│  │  Ceph      (分散ストレージ)                          │       │
│  └──────────────────────────────────────────────────────┘       │
│                                                                 │
│  ┌──────────────────────────────────────────────────────┐       │
│  │ Kubernetes クラスタ内サービス                         │       │
│  │  Keycloak  (認証基盤 — k1s0-system Namespace)        │       │
│  │  Harbor    (コンテナレジストリ — harbor Namespace)    │       │
│  └──────────────────────────────────────────────────────┘       │
└─────────────────────────────────────────────────────────────────┘
```

## 環境構成

| 環境    | 用途                 | Master | Worker | 備考                       |
| ------- | -------------------- | ------ | ------ | -------------------------- |
| dev     | 開発・動作確認       | 1      | 2      | リソース制限を緩めに設定   |
| staging | リリース前の検証     | 1      | 3      | prod 相当のアーキテクチャで台数を削減 |
| prod    | 本番運用             | 3      | 5+     | HA 構成・オートスケール    |

## サーバー要件

### Kubernetes Master ノード

| 項目  | dev       | staging   | prod              |
| ----- | --------- | --------- | ----------------- |
| CPU   | 4 vCPU    | 4 vCPU    | 8 vCPU            |
| メモリ | 8 GB     | 8 GB      | 16 GB             |
| ディスク | 100 GB SSD | 100 GB SSD | 200 GB SSD     |
| 台数  | 1         | 1         | 3（HA 構成）      |

### Kubernetes Worker ノード

| 項目  | dev       | staging   | prod              |
| ----- | --------- | --------- | ----------------- |
| CPU   | 8 vCPU    | 16 vCPU   | 32 vCPU           |
| メモリ | 16 GB    | 32 GB     | 64 GB             |
| ディスク | 200 GB SSD | 500 GB SSD | 1 TB SSD      |
| 台数  | 2         | 3         | 5+                |

## ネットワーク設計

```
┌──────────────────────────────────────────────────────┐
│  社内ネットワーク (10.0.0.0/8)                        │
│                                                       │
│  ┌─────────────┐     ┌─────────────────────────────┐  │
│  │ ロード       │     │ Kubernetes Ingress           │  │
│  │ バランサー   │────▶│ (Nginx Ingress Controller)   │  │
│  │ (MetalLB)   │     └─────────────────────────────┘  │
│  └─────────────┘                                       │
│                             │                         │
│        ┌────────────────────┼────────────────────┐    │
│        ▼                    ▼                    ▼    │
│  ┌──────────┐        ┌──────────┐         ┌─────────┐│
│  │ API GW   │        │ サービス  │         │ 可観測性 ││
│  │ (Kong)   │        │ メッシュ  │         │ スタック ││
│  └──────────┘        │ (Istio)  │         └─────────┘│
│                       └──────────┘                    │
└──────────────────────────────────────────────────────┘
```

| セグメント        | CIDR            | 用途                          |
| ----------------- | --------------- | ----------------------------- |
| Pod ネットワーク  | 10.244.0.0/16   | Pod 間通信（Calico）          |
| Service ネットワーク | 10.96.0.0/12 | Kubernetes Service            |
| MetalLB プール    | 10.0.100.0/24   | LoadBalancer 用 IP アドレス   |
| 管理ネットワーク  | 10.0.200.0/24   | ノード管理・SSH               |

## ストレージ

| ストレージ種別   | 技術         | 用途                                  |
| ---------------- | ------------ | ------------------------------------- |
| ブロック         | Ceph RBD     | データベースの永続ボリューム          |
| ファイル         | CephFS       | 共有ファイルストレージ                |
| オブジェクト     | Ceph RGW     | バックアップ・ログアーカイブ          |

Kubernetes の StorageClass として Ceph を登録し、PVC で動的プロビジョニングする。

```yaml
# StorageClass の例
apiVersion: storage.k8s.io/v1
kind: StorageClass
metadata:
  name: ceph-block
provisioner: rbd.csi.ceph.com
parameters:
  clusterID: ceph-cluster
  pool: k8s-block
reclaimPolicy: Retain
allowVolumeExpansion: true
```

## コンテナレジストリ（Harbor）

| 項目           | 値                              |
| -------------- | ------------------------------- |
| URL            | `harbor.internal.example.com`   |
| 認証           | LDAP / AD 連携                  |
| レプリケーション | なし（単一インスタンス）       |
| イメージ保持   | 直近 10 バージョン + latest     |
| 脆弱性スキャン | Trivy（Harbor 組み込み）        |

### プロジェクト構成

```
harbor.internal.example.com/
├── k1s0-system/       # system 層のイメージ
├── k1s0-business/     # business 層のイメージ
├── k1s0-service/      # service 層のイメージ
└── k1s0-infra/        # インフラ系イメージ（Kafka UI 等）
```

## Kubernetes クラスタ構築

| コンポーネント           | 技術・ツール                 |
| ------------------------ | ---------------------------- |
| クラスタ構築             | kubeadm                      |
| CNI（ネットワーク）      | Calico                       |
| Ingress Controller       | Nginx Ingress Controller     |
| LoadBalancer             | MetalLB                      |
| CSI（ストレージ）        | Ceph CSI                     |
| DNS                      | CoreDNS                      |
| 証明書管理               | cert-manager                 |
| プログレッシブデリバリー | Flagger                      |

## 構成管理ツール

| レイヤー                         | ツール    | 用途                                    |
| -------------------------------- | --------- | --------------------------------------- |
| 物理 / 仮想サーバー             | Ansible   | OS セットアップ・パッケージ管理         |
| Kubernetes クラスタ構築          | Ansible   | kubeadm によるクラスタ構築・ノード追加  |
| Kubernetes リソース              | Terraform | Namespace・RBAC・StorageClass 等の管理  |
| アプリケーションデプロイ         | Helm      | サービスのデプロイ・アップデート        |

詳細は [terraform設計](terraform設計.md) を参照。

## バックアップ

| 対象                | 方式                           | 頻度     | 保持期間 |
| ------------------- | ------------------------------ | -------- | -------- |
| etcd                | etcdctl snapshot               | 毎日     | 30 日    |
| データベース        | pg_dump / mysqldump            | 毎日     | 30 日    |
| Ceph                | RBD スナップショット           | 毎日     | 14 日    |
| Harbor              | Harbor のバックアップ機能      | 週次     | 90 日    |
| Vault               | Vault snapshot                 | 毎日     | 30 日    |

## 関連ドキュメント

- [kubernetes設計](kubernetes設計.md)
- [helm設計](helm設計.md)
- [terraform設計](terraform設計.md)
- [可観測性設計](可観測性設計.md)
- [認証認可設計](認証認可設計.md)
