# 可観測性 - SLO 設計

D-108: SLO/SLA 定義。SLI、SLO、SLA、エラーバジェット運用を定義する。

元ドキュメント: [可観測性設計.md](../overview/可観測性設計.md)

---

## D-108: SLO/SLA 定義

### SLI（Service Level Indicators）

| SLI          | 定義                                                    | 計測方法                                    |
| ------------ | ------------------------------------------------------- | ------------------------------------------- |
| 可用性       | 正常レスポンス数 / 全リクエスト数                       | `http_requests_total{status!~"5.."} / total` |
| レイテンシ   | P99 レスポンスタイム                                    | `histogram_quantile(0.99, ...)`             |
| エラーレート | 5xx レスポンス率                                        | `rate(http_requests_total{status=~"5.."})`  |

### SLO（Service Level Objectives）

> **可用性とエラーレートの関係**: 可用性 SLO は「正常レスポンス数 / 全リクエスト数」で計測するため、可用性 99.95% はエラーレート < 0.05% と同義である。同様に、可用性 99.9% はエラーレート < 0.1% と同義である。以下の表では両指標を並記し、計測方法の違いを明示する。

#### system Tier

| SLO               | 目標値   | 計測期間 | エラーバジェット（30日） |
| ------------------ | -------- | -------- | ------------------------ |
| 可用性             | 99.95%   | 30 日    | 21.6 分                  |
| P99 レイテンシ     | < 200ms  | 30 日    | -                        |
| エラーレート       | < 0.05%  | 30 日    | -（可用性 99.95% と同義）|

#### business Tier

| SLO               | 目標値   | 計測期間 | エラーバジェット（30日） |
| ------------------ | -------- | -------- | ------------------------ |
| 可用性             | 99.9%    | 30 日    | 43.2 分                  |
| P99 レイテンシ     | < 500ms  | 30 日    | -                        |
| エラーレート       | < 0.1%   | 30 日    | -（可用性 99.9% と同義） |

#### service Tier

| SLO               | 目標値   | 計測期間 | エラーバジェット（30日） |
| ------------------ | -------- | -------- | ------------------------ |
| 可用性             | 99.9%    | 30 日    | 43.2 分                  |
| P99 レイテンシ     | < 1s     | 30 日    | -                        |
| エラーレート       | < 0.1%   | 30 日    | -（可用性 99.9% と同義） |

### SLA（Service Level Agreements）

#### 内部 SLA（チーム間合意）

| Tier     | 可用性    | P99 レイテンシ | 計測期間 |
| -------- | --------- | -------------- | -------- |
| system   | 99.9%     | < 500ms        | 月間     |
| business | 99.8%     | < 1s           | 月間     |
| service  | 99.8%     | < 2s           | 月間     |

#### SLA 違反時のエスカレーション

| 条件                   | アクション                                                     |
| ---------------------- | -------------------------------------------------------------- |
| リアルタイム可用性低下 | 即座にオンコール担当に通知（Alertmanager → Teams 連携）        |
| 月間 SLA 未達          | 月次レビューで原因分析と再発防止策を検討、ポストモーテム実施   |

### エラーバジェット運用

```
エラーバジェット = 1 - SLO目標値
エラーバジェット残量 = エラーバジェット - 実測エラー率
```

| バジェット残量 | アクション                                      |
| -------------- | ----------------------------------------------- |
| > 50%          | 通常運用。新機能リリース可能                    |
| 25% - 50%      | 注意。リリース頻度を下げ、信頼性改善に注力      |
| < 25%          | 警告。新機能リリースを凍結し、信頼性改善に専念  |
| 0%             | リリース凍結。ポストモーテム実施                |

#### Prometheus Recording Rule

```yaml
groups:
  - name: slo-recording-rules
    rules:
      - record: slo:availability:ratio
        expr: |
          sum(rate(http_requests_total{status!~"5.."}[30d])) by (namespace, service)
          / sum(rate(http_requests_total[30d])) by (namespace, service)

      - record: slo:error_budget:remaining
        expr: |
          1 - (
            (1 - slo:availability:ratio)
            / (1 - (
              label_replace(
                vector(0.9995) and on() (kube_namespace_labels{namespace="k1s0-system"})
                or vector(0.999),
                "namespace", "$1", "namespace", "(.*)"
              )
            ))
          )
        # system Tier: 可用性目標 99.95%（0.9995）
        # business / service Tier: 可用性目標 99.9%（0.999）
```

---

## 関連ドキュメント

- [可観測性設計.md](../overview/可観測性設計.md) -- 基本方針・概要
- [可観測性-監視アラート設計.md](../monitoring/監視アラート設計.md) -- 監視・アラート設計
- [可観測性-トレーシング設計.md](../tracing/トレーシング設計.md) -- 分散トレーシング
- [可観測性-ログ設計.md](../logging/ログ設計.md) -- 構造化ログ・Loki
