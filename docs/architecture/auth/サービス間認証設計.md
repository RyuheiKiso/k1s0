# サービス間認証設計

D-003: サービス間認証 mTLS。Istio STRICT モード、Tier 間 AuthorizationPolicy、証明書管理を定義する。

元ドキュメント: [認証認可設計.md](認証認可設計.md)

---

## D-003: サービス間認証 mTLS

### Istio STRICT モード

サービス間通信の暗号化と認証には **Istio の mTLS STRICT モード** を使用する。

**メッシュワイドデフォルト** として、Istio Control Plane の Namespace（`service-mesh`）に STRICT mTLS を定義している（[サービスメッシュ設計.md](../../infrastructure/service-mesh/サービスメッシュ設計.md) の「mTLS 設定」参照）。

**防御多層化** として、各 Tier の Namespace にも個別の PeerAuthentication を定義する。メッシュワイド設定が誤って変更された場合でも、Namespace レベルの設定が防御層として機能する。

> **例外**: `observability` Namespace は **PERMISSIVE** モードで運用する。Prometheus の scrape（メトリクス収集）が mTLS なしの平文 HTTP で行われるため、STRICT モードでは scrape が失敗する。詳細は [サービスメッシュ設計.md](../../infrastructure/service-mesh/サービスメッシュ設計.md) の「mTLS 設定」を参照。

```yaml
# Namespace レベルの防御多層化（メッシュワイドデフォルトに加えて適用）
apiVersion: security.istio.io/v1
kind: PeerAuthentication
metadata:
  name: default
  namespace: k1s0-system
spec:
  mtls:
    mode: STRICT
---
apiVersion: security.istio.io/v1
kind: PeerAuthentication
metadata:
  name: default
  namespace: k1s0-business
spec:
  mtls:
    mode: STRICT
---
apiVersion: security.istio.io/v1
kind: PeerAuthentication
metadata:
  name: default
  namespace: k1s0-service
spec:
  mtls:
    mode: STRICT
```

### Tier 間 AuthorizationPolicy

[kubernetes設計.md](../../infrastructure/kubernetes/kubernetes設計.md) の NetworkPolicy と連携し、Istio の AuthorizationPolicy で Tier 間のアクセス制御を行う。NetworkPolicy が L3/L4 レベルの制御を担い、AuthorizationPolicy が L7 レベルの制御を担う。

```yaml
# system 層: business・service からのアクセスのみ許可
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-from-lower-tiers
  namespace: k1s0-system
spec:
  action: ALLOW
  rules:
    - from:
        - source:
            namespaces: ["k1s0-business", "k1s0-service"]
    - from:
        - source:
            namespaces: ["k1s0-system"]           # 同一 Tier 内の通信も許可
---
# business 層: service からのアクセスのみ許可
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-from-service-tier
  namespace: k1s0-business
spec:
  action: ALLOW
  rules:
    - from:
        - source:
            namespaces: ["k1s0-service"]
    - from:
        - source:
            namespaces: ["k1s0-business"]         # 同一 Tier 内の通信も許可
---
# service 層: ingress と同一 Tier からのアクセスのみ許可
# 注意: 同一 Tier 内の通信を Namespace レベルで許可しているが、
# tier-architecture.md の「service 層の BFF 間の通信は原則禁止」ルールに基づき、
# BFF 間の直接通信は下記の deny ポリシーで制御する。
# BFF 以外の同一 Tier 内通信（例: BFF → バックエンドサーバー）は許可される。
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: allow-from-ingress
  namespace: k1s0-service
spec:
  action: ALLOW
  rules:
    - from:
        - source:
            namespaces: ["ingress"]
    - from:
        - source:
            namespaces: ["k1s0-service"]          # 同一 Tier 内の通信も許可
---
# service 層: BFF 間の直接通信を禁止
# tier-architecture.md の「service 層の BFF 間の通信は原則禁止」ルールを
# L7 レベルで強制する。BFF のサービスアカウント（*-bff-sa）から他の BFF への
# 通信を DENY する。BFF からバックエンドサーバーへの通信は上記の ALLOW ポリシーで許可される。
# 注: BFF のサービスアカウント命名規則は「{service}-bff-sa」とする。
# 新規 BFF 追加時は principals にサービスアカウントを追加すること。
apiVersion: security.istio.io/v1
kind: AuthorizationPolicy
metadata:
  name: deny-bff-to-bff
  namespace: k1s0-service
spec:
  action: DENY
  selector:
    matchLabels:
      app.kubernetes.io/component: bff            # 宛先が BFF の場合に適用
  rules:
    - from:
        - source:
            principals: ["cluster.local/ns/k1s0-service/sa/*-bff-sa"]
```

### 証明書管理

| 項目                   | 値                                  |
| ---------------------- | ----------------------------------- |
| CA                     | Istio CA（istiod 内蔵）            |
| 証明書ローテーション   | 24 時間（自動）                    |
| ルート CA 有効期限     | 10 年                              |
| ワークロード証明書     | SAN に SPIFFE ID を使用            |

cert-manager と Istio CA の連携により、ワークロード証明書は自動的にローテーションされる。

```
SPIFFE ID 形式: spiffe://k1s0.internal/ns/{namespace}/sa/{service-account}
```

---

## 関連ドキュメント

- [認証認可設計.md](認証認可設計.md) -- 基本方針・技術スタック
- [認証設計.md](認証設計.md) -- OAuth 2.0 / OIDC 実装
- [JWT設計.md](./JWT設計.md) -- JWT 公開鍵ローテーション
- [RBAC設計.md](./RBAC設計.md) -- RBAC 設計
- [サービスメッシュ設計.md](../../infrastructure/service-mesh/サービスメッシュ設計.md) -- Istio 設計
- [kubernetes設計.md](../../infrastructure/kubernetes/kubernetes設計.md) -- NetworkPolicy 設計
