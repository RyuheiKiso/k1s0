# 可観測性 - ログ設計

> **ガイド**: 実装パターン・トレース相関の仕組みは [ログ設計.guide.md](./ログ設計.guide.md) を参照。

D-109: 構造化ログ設計。JSON 標準フィールド、Loki・Promtail 構成を定義する。

元ドキュメント: [可観測性設計.md](./可観測性設計.md)

---

## D-109: 構造化ログ設計

### JSON ログ標準フィールド

すべてのサービスは JSON 形式の構造化ログを標準出力に出力する。

```json
{
  "timestamp": "2026-02-15T10:30:00.123Z",
  "level": "info",
  "message": "Request completed",
  "service": "order-server",
  "version": "1.2.3",
  "tier": "service",
  "environment": "prod",
  "trace_id": "abc123def456",
  "span_id": "789ghi012",
  "request_id": "req_xyz789",
  "method": "POST",
  "path": "/api/v1/orders",
  "status": 201,
  "duration_ms": 45,
  "user_id": "usr_123",
  "error": null
}
```

### 標準フィールド定義

| フィールド    | 型     | 必須 | 説明                              |
| ------------- | ------ | ---- | --------------------------------- |
| `timestamp`   | string | Yes  | ISO 8601 形式（UTC）              |
| `level`       | string | Yes  | `debug`, `info`, `warn`, `error`  |
| `message`     | string | Yes  | ログメッセージ                    |
| `service`     | string | Yes  | サービス名                        |
| `version`     | string | Yes  | アプリケーションバージョン        |
| `tier`        | string | Yes  | `system`, `business`, `service`   |
| `environment` | string | Yes  | `dev`, `staging`, `prod`          |
| `trace_id`    | string | No   | 分散トレースの Trace ID           |
| `span_id`     | string | No   | 分散トレースの Span ID            |
| `request_id`  | string | No   | リクエスト追跡 ID                 |
| `error`       | object | No   | エラー詳細（スタックトレース等）  |

### トレース相関

`trace_id` / `span_id` をログに埋め込み、Grafana でトレースと相関表示する（詳細はガイドを参照）。

### 環境別ログレベル

| 環境    | デフォルトレベル | フォーマット | 出力先   |
| ------- | ---------------- | ------------ | -------- |
| dev     | debug            | text         | stdout   |
| staging | info             | json         | stdout   |
| prod    | warn             | json         | stdout   |

Go / Rust の実装例はガイドを参照。

### ログ保持期間ポリシー

| 環境    | 保持期間 | 設定方法                            |
| ------- | -------- | ----------------------------------- |
| dev     | 7 日     | Loki `retention_period` で自動削除  |
| staging | 30 日    | Loki `retention_period` で自動削除  |
| prod    | 90 日    | Loki `retention_period` で自動削除  |

監査ログ（認証・認可関連）は通常ログとは別に長期保存する。

| ログ種別     | 保持期間 | 保存先                               |
| ------------ | -------- | ------------------------------------ |
| 監査ログ     | 1 年間   | Ceph オブジェクトストレージにアーカイブ |

```yaml
# Loki 保持期間設定例（prod）
limits_config:
  retention_period: 2160h  # 90日

# 監査ログ用の別テナント設定
overrides:
  audit:
    retention_period: 8760h  # 1年（365日）
```

### ログ集約（Loki）

```yaml
# Loki Stack (Promtail → Loki → Grafana)
apiVersion: v1
kind: ConfigMap
metadata:
  name: promtail-config
  namespace: observability
data:
  promtail.yaml: |
    server:
      http_listen_port: 3101
    positions:
      filename: /tmp/positions.yaml
    clients:
      - url: http://loki:3100/loki/api/v1/push
    scrape_configs:
      - job_name: kubernetes-pods
        kubernetes_sd_configs:
          - role: pod
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace]
            target_label: namespace
          - source_labels: [__meta_kubernetes_pod_label_app_kubernetes_io_name]
            target_label: app
          - source_labels: [__meta_kubernetes_pod_label_tier]
            target_label: tier
        pipeline_stages:
          - json:
              expressions:
                level: level
                trace_id: trace_id
                service: service
          - labels:
              level:
              trace_id:
              service:
```

---

## 関連ドキュメント

- [可観測性設計.md](./可観測性設計.md) -- 基本方針・概要
- [可観測性-監視アラート設計.md](./監視アラート設計.md) -- 監視・アラート設計
- [可観測性-SLO設計.md](./SLO設計.md) -- SLO/SLA・エラーバジェット
- [可観測性-トレーシング設計.md](./トレーシング設計.md) -- 分散トレーシング
- [helm設計.md](../../infrastructure/kubernetes/helm設計.md) -- Helm Chart 設計
