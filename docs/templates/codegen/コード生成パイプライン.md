# テンプレート仕様 — コード生成パイプライン

## 概要

本ドキュメントは、k1s0 CLI の「ひな形生成」機能においてテンプレートファイル生成後に自動実行される **後処理パイプライン** を定義する。パイプラインは以下の4つのフェーズで構成される。

1. テンプレート生成（Tera エンジンによるひな形出力）
2. 依存解決（言語固有のパッケージマネージャー実行）
3. コード生成（API 定義からのスタブ・型生成）
4. DB 初期化（マイグレーションツールのセットアップ）

対象ツール:

| ツール | 用途 |
|---|---|
| `go mod tidy` | Go 依存解決 |
| `cargo check` | Rust コンパイルチェック |
| `npm install` | TypeScript/React 依存インストール |
| `flutter pub get` | Dart/Flutter 依存インストール |
| `buf generate` | gRPC コード生成（Go/Rust 共通） |
| `oapi-codegen` | OpenAPI コード生成（Go） |
| `cargo xtask codegen` | OpenAPI コード生成（Rust） |
| `sqlx database create` | DB 初期化 |

## パイプライン全体フロー

```
┌──────────────────┐
│ テンプレート生成   │  Tera エンジンで CLI/templates/ からひな形を出力
│ (TemplateEngine)  │  失敗時はインライン生成にフォールバック
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ 依存解決          │  go mod tidy / cargo check / npm install / flutter pub get
│ (Dependency)      │  kind + language に応じて選択
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ コード生成        │  buf generate / oapi-codegen / cargo xtask codegen
│ (Code Generation) │  api_style に応じて選択（Server のみ）
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ DB 初期化         │  sqlx database create
│ (DB Init)         │  has_database = true の場合のみ（Server のみ）
└──────────────────┘
```

パイプラインの実装は `CLI/src/commands/generate/execute.rs` の以下の関数に対応する。

| 関数 | 役割 |
|---|---|
| `execute_generate_with_config()` | 生成全体のオーケストレーション |
| `try_generate_from_templates()` | テンプレートエンジンによる生成 |
| `run_post_processing()` | 後処理コマンドの逐次実行 |
| `determine_post_commands()` | kind × language × api_styles から実行コマンドリストを決定 |

## 実行条件マトリクス

### 依存解決コマンド

| kind | language / framework | コマンド |
|---|---|---|
| Server | Go | `go mod tidy` |
| Server | Rust | `cargo check` |
| BFF | Go | `go mod tidy` |
| BFF | Rust | `cargo check` |
| Client | React | `npm install` |
| Client | Flutter | `flutter pub get` |
| Library | Go | `go mod tidy` |
| Library | Rust | `cargo check` |
| Library | TypeScript | `npm install` |
| Library | Dart | `flutter pub get` |
| Database | — | （なし） |

### コード生成コマンド

コード生成は **Server** または **BFF** かつ対象の `api_styles` が選択されている場合に実行される。

| api_style | language | コマンド |
|---|---|---|
| gRPC | Go / Rust 共通 | `buf generate` |
| REST | Go | `oapi-codegen -generate types,server -package handler -o internal/handler/openapi.gen.go api/openapi/openapi.yaml` |
| REST | Rust | `cargo xtask codegen` |
| GraphQL | Go | `go run github.com/99designs/gqlgen generate`（実装済み） |
| GraphQL | Rust | コード生成不要（async-graphql はマクロベース `#[Object]`） |

### DB 初期化コマンド

| 条件 | コマンド |
|---|---|
| Server かつ `has_database = true` | `sqlx database create` |
| BFF | （なし — BFF は DB を持たない） |
| 上記以外 | （なし） |

## 依存解決パイプライン

後処理の第1フェーズ。テンプレートから生成されたプロジェクトの依存関係を解決する。実行ディレクトリは `build_output_path()` で構築された出力先パス。

### Go

```bash
go mod tidy
```

`go.mod.tera` から生成された `go.mod` に基づき、未使用の依存を削除し不足する依存を追加する。Server・Library の両方で実行される。

### Rust

```bash
cargo check
```

`Cargo.toml.tera` から生成された `Cargo.toml` に基づき、依存クレートのダウンロードとコンパイルチェックを行う。Server・Library の両方で実行される。

### TypeScript

```bash
npm install
```

`package.json.tera` から生成された `package.json` に基づき、npm パッケージをインストールする。Client（React）・Library（TypeScript）で実行される。

### Dart

```bash
flutter pub get
```

`pubspec.yaml.tera` から生成された `pubspec.yaml` に基づき、Dart パッケージを取得する。Client（Flutter）・Library（Dart）で実行される。

## コード生成パイプライン

後処理の第2フェーズ。API 定義ファイルからスタブコードや型定義を自動生成する。**Server のみ** で実行され、選択された `api_styles` に応じてコマンドが決定される。

### gRPC — `buf generate`

```bash
buf generate
```

`api/proto/service.proto.tera` から生成された `.proto` ファイルと、`buf.yaml.tera` / `buf.gen.yaml.tera` から生成された設定ファイルを入力として、Go / Rust 両言語で共通に実行される。

生成先は `buf.gen.yaml` の設定に依存する。

### REST — Go

```bash
oapi-codegen -generate types,server -package handler -o internal/handler/openapi.gen.go api/openapi/openapi.yaml
```

`api/openapi/openapi.yaml.tera` から生成された OpenAPI 定義を入力として、型定義とサーバーインターフェースを `internal/handler/openapi.gen.go` に出力する。`oapi-codegen.yaml.tera` から生成された設定ファイルも参照される。

### REST — Rust

```bash
cargo xtask codegen
```

`api/openapi/openapi.yaml` を入力として、`xtask` クレートのコード生成タスクを実行する。

### GraphQL — Go

```bash
go run github.com/99designs/gqlgen generate
```

`gqlgen.yml.tera` から生成された設定ファイルと `api/graphql/schema.graphql.tera` から生成された GraphQL スキーマを入力として、リゾルバーのスケルトンコードを生成する。`execute.rs` の `determine_post_commands()` に実装済み。

### GraphQL — Rust

Rust の GraphQL 実装は `async-graphql` クレートを使用しており、マクロベース（`#[Object]`）でスキーマを定義するため、**コード生成パイプラインは不要**。テンプレート（`src/adapter/handler/graphql.rs.tera`）が直接リゾルバーコードを生成する。

## DB マイグレーション初期化

後処理の第3フェーズ。Server で `has_database = true` の場合のみ実行される。

```bash
sqlx database create
```

`DATABASE_URL` 環境変数に基づきデータベースを作成する。マイグレーションファイル自体は Database テンプレート（`001_init.up.sql.tera` / `001_init.down.sql.tera`）で別途生成される。

## エラーハンドリング仕様

パイプラインは **best-effort 方式** で動作する。`run_post_processing()` の実装に基づく仕様は以下の通り。

### 基本方針

- 各コマンドは逐次実行され、あるコマンドが失敗しても後続コマンドの実行は継続する
- 生成済みファイルのロールバックは行わない
- コマンドの実行結果（成功/失敗）は戻り値に影響しない

### 失敗時の動作

1. **コマンド実行は成功したが終了コードが非ゼロの場合**:
   - stderr の内容を標準エラー出力に表示
   - 手動実行コマンドを提示: `cd {output_path} && {cmd} {args}`

2. **コマンドの起動自体が失敗した場合**（バイナリ未インストール等）:
   - エラー内容を標準エラー出力に表示
   - 手動実行コマンドを提示: `cd {output_path} && {cmd} {args}`

### エラーメッセージ形式

```
後処理コマンド '{cmd} {args}' が失敗しました: {stderr}
手動で実行してください: cd {output_path} && {cmd} {args}
```

```
後処理コマンド '{cmd} {args}' の実行に失敗しました: {error}
手動で実行してください: cd {output_path} && {cmd} {args}
```

### リトライ機構

後処理コマンドの実行にはリトライ機構を備える。ネットワーク依存のコマンド（`go mod tidy`、`npm install`、`flutter pub get`、`buf generate`）がタイムアウトや一時的なネットワークエラーで失敗した場合に自動リトライする。

#### リトライ対象コマンド

| コマンド | リトライ対象 | 理由 |
|---|---|---|
| `go mod tidy` | ○ | Go モジュールのダウンロードにネットワーク必要 |
| `cargo check` | ○ | crate のダウンロードにネットワーク必要 |
| `npm install` | ○ | npm パッケージのダウンロードにネットワーク必要 |
| `flutter pub get` | ○ | Dart パッケージのダウンロードにネットワーク必要 |
| `buf generate` | ○ | プラグインのダウンロードにネットワーク必要 |
| `oapi-codegen` | × | ローカルファイルのみ参照 |
| `cargo xtask codegen` | × | ローカルファイルのみ参照 |
| `go run github.com/99designs/gqlgen generate` | × | go mod tidy 後はキャッシュ済み |
| `sqlx database create` | × | DB 接続失敗はリトライしても解決しない |

#### リトライパラメータ

| パラメータ | 値 | 説明 |
|---|---|---|
| 最大リトライ回数 | 3 | 初回実行 + 最大3回リトライ = 最大4回実行 |
| 初回待機時間 | 1秒 | 最初のリトライまでの待機 |
| バックオフ係数 | 2 | 指数バックオフ（1秒 → 2秒 → 4秒） |
| 最大待機時間 | 10秒 | バックオフの上限 |

#### リトライ判定

リトライは以下の条件を **すべて** 満たす場合に実行される:

1. コマンドがリトライ対象である
2. 終了コードが非ゼロである
3. リトライ回数が上限に達していない

stderr の内容によるリトライ判定は行わない（終了コードのみで判断）。

#### 実装インターフェース

```rust
/// リトライ設定。
pub struct RetryConfig {
    /// 最大リトライ回数（0 = リトライなし）
    pub max_retries: u32,
    /// 初回待機時間（ミリ秒）
    pub initial_delay_ms: u64,
    /// バックオフ係数
    pub backoff_multiplier: u64,
    /// 最大待機時間（ミリ秒）
    pub max_delay_ms: u64,
}

impl Default for RetryConfig {
    fn default() -> Self {
        Self {
            max_retries: 3,
            initial_delay_ms: 1000,
            backoff_multiplier: 2,
            max_delay_ms: 10000,
        }
    }
}
```

#### ログ出力

リトライ時は以下の形式でログを出力する:

```
後処理コマンド '{cmd} {args}' がリトライ中 ({attempt}/{max_retries}): {delay_ms}ms 後に再試行
```

全リトライ失敗後:

```
後処理コマンド '{cmd} {args}' が {max_retries} 回リトライ後も失敗しました: {stderr}
手動で実行してください: cd {output_path} && {cmd} {args}
```

## 設定ファイルテンプレート一覧

各コード生成ツールが参照する設定ファイルのテンプレート一覧。

| ツール | 設定ファイル | テンプレートパス |
|---|---|---|
| buf（gRPC） | `buf.yaml` | `CLI/crates/k1s0-cli/templates/server/go/buf.yaml.tera` |
| buf（gRPC） | `buf.gen.yaml` | `CLI/crates/k1s0-cli/templates/server/go/buf.gen.yaml.tera` |
| buf（gRPC） | `buf.yaml` | `CLI/crates/k1s0-cli/templates/server/rust/buf.yaml.tera` |
| oapi-codegen | `oapi-codegen.yaml` | `CLI/crates/k1s0-cli/templates/server/go/oapi-codegen.yaml.tera` |
| gqlgen | `gqlgen.yml` | `CLI/crates/k1s0-cli/templates/server/go/gqlgen.yml.tera` |

API 定義ファイル:

| API 方式 | 定義ファイル | テンプレートパス |
|---|---|---|
| REST | `api/openapi/openapi.yaml` | `CLI/crates/k1s0-cli/templates/server/go/api/openapi/openapi.yaml.tera` |
| gRPC | `api/proto/service.proto` | `CLI/crates/k1s0-cli/templates/server/go/api/proto/service.proto.tera` |
| GraphQL | `api/graphql/schema.graphql` | `CLI/crates/k1s0-cli/templates/server/go/api/graphql/schema.graphql.tera` |
| REST | `api/openapi/openapi.yaml` | `CLI/crates/k1s0-cli/templates/server/rust/api/openapi/openapi.yaml.tera` |
| gRPC | `api/proto/service.proto` | `CLI/crates/k1s0-cli/templates/server/rust/api/proto/service.proto.tera` |
| GraphQL | `api/graphql/schema.graphql` | `CLI/crates/k1s0-cli/templates/server/rust/api/graphql/schema.graphql.tera` |

## 関連ドキュメント

> 共通参照は [テンプレートエンジン仕様.md](../engine/テンプレートエンジン仕様.md) を参照。

- [テンプレート仕様 — サーバー](../server/サーバー.md) --- サーバーテンプレートの詳細
- [テンプレート仕様 — BFF](../client/BFF.md) --- BFF テンプレートの詳細
- [テンプレート仕様 — クライアント](../client/クライアント.md) --- クライアントテンプレートの詳細
- [テンプレート仕様 — ライブラリ](ライブラリ.md) --- ライブラリテンプレートの詳細
- [テンプレート仕様 — データベース](../data/データベース.md) --- データベーステンプレートの詳細
