# テンプレート仕様 — データベース

## 1. 概要

k1s0 プロジェクトにおけるデータベーステンプレートは、CLI の「ひな形生成」機能でデータベース種別（PostgreSQL / MySQL / SQLite）を選択した際に、マイグレーションファイル一式を自動生成するためのものである。

本テンプレートの目的は以下の通り。

- サービス新規作成時に、選択した RDBMS に応じた初期マイグレーションファイルを生成する
- マイグレーションの命名規則・ディレクトリ構成を統一する
- up / down の対称性を保証し、安全なロールバックを可能にする

サーバーテンプレートで `has_database: true` を指定した場合にも、DB 接続コードとともに本テンプレートのマイグレーションファイルが生成される。

## 2. 配置パス

マイグレーションファイルは Region 階層に応じて以下のパスに配置される。データベースへのアクセスはその階層の server のみが行う。

| Region | 配置先 |
|---|---|
| system | `regions/system/server/{lang}/{service_name}/migrations/` |
| business | `regions/business/{domain}/server/{lang}/{service_name}/migrations/` |
| service | `regions/service/{service_name}/server/{lang}/migrations/` |

テンプレート変数:

- `{{ service_name }}` — サービス名
- `{{ lang }}` — 言語（go / rust）
- `{{ domain }}` — ビジネスドメイン名（business 階層のみ）
- `{{ database_type }}` — データベース種別（postgresql / mysql / sqlite）

## 3. マイグレーション命名規則

### 形式

```
{番号}_{説明}.{方向}.sql
```

| 要素 | ルール | 例 |
|---|---|---|
| 番号 | 3桁ゼロ埋め | `001`, `002`, `010` |
| 説明 | snake_case で簡潔に | `init`, `add_users_table`, `add_index_on_email` |
| 方向 | `up`（適用）/ `down`（ロールバック） | `up`, `down` |

### ディレクトリ構成例

```
migrations/
├── 001_init.up.sql
├── 001_init.down.sql
├── 002_add_users_table.up.sql
├── 002_add_users_table.down.sql
└── ...
```

## 4. PostgreSQL テンプレート

### 4.1 001_init.up.sql

```sql
-- {{ service_name }} 初期マイグレーション (PostgreSQL)
-- 生成元: k1s0 CLI テンプレート

-- 拡張機能
CREATE EXTENSION IF NOT EXISTS "uuid-ossp";
CREATE EXTENSION IF NOT EXISTS "pgcrypto";

-- スキーマ
CREATE SCHEMA IF NOT EXISTS {{ service_name_snake }};

-- サンプルテーブル
CREATE TABLE {{ service_name_snake }}.examples (
    id          UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name        VARCHAR(255) NOT NULL,
    description TEXT,
    status      VARCHAR(50) NOT NULL DEFAULT 'active',
    created_at  TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    updated_at  TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

-- 更新日時の自動更新トリガー
CREATE OR REPLACE FUNCTION {{ service_name_snake }}.update_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trigger_update_updated_at
    BEFORE UPDATE ON {{ service_name_snake }}.examples
    FOR EACH ROW
    EXECUTE FUNCTION {{ service_name_snake }}.update_updated_at();

-- インデックス
CREATE INDEX idx_examples_status ON {{ service_name_snake }}.examples (status);
CREATE INDEX idx_examples_created_at ON {{ service_name_snake }}.examples (created_at);
```

### 4.2 001_init.down.sql

```sql
DROP TRIGGER IF EXISTS trigger_update_updated_at ON {{ service_name_snake }}.examples;
DROP FUNCTION IF EXISTS {{ service_name_snake }}.update_updated_at();
DROP TABLE IF EXISTS {{ service_name_snake }}.examples;
DROP SCHEMA IF EXISTS {{ service_name_snake }};
DROP EXTENSION IF EXISTS "pgcrypto";
DROP EXTENSION IF EXISTS "uuid-ossp";
```

## 5. MySQL テンプレート

### 5.1 001_init.up.sql

```sql
-- {{ service_name }} 初期マイグレーション (MySQL)

CREATE DATABASE IF NOT EXISTS {{ service_name_snake }}
    CHARACTER SET utf8mb4
    COLLATE utf8mb4_unicode_ci;

USE {{ service_name_snake }};

CREATE TABLE examples (
    id          CHAR(36) PRIMARY KEY DEFAULT (UUID()),
    name        VARCHAR(255) NOT NULL,
    description TEXT,
    status      VARCHAR(50) NOT NULL DEFAULT 'active',
    created_at  DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6),
    updated_at  DATETIME(6) NOT NULL DEFAULT CURRENT_TIMESTAMP(6) ON UPDATE CURRENT_TIMESTAMP(6),
    INDEX idx_examples_status (status),
    INDEX idx_examples_created_at (created_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci;
```

### 5.2 001_init.down.sql

```sql
DROP TABLE IF EXISTS examples;
DROP DATABASE IF EXISTS {{ service_name_snake }};
```

## 6. SQLite テンプレート

### 6.1 001_init.up.sql

```sql
-- {{ service_name }} 初期マイグレーション (SQLite)

CREATE TABLE IF NOT EXISTS examples (
    id          TEXT PRIMARY KEY DEFAULT (lower(hex(randomblob(16)))),
    name        TEXT NOT NULL,
    description TEXT,
    status      TEXT NOT NULL DEFAULT 'active',
    created_at  TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%f', 'now')),
    updated_at  TEXT NOT NULL DEFAULT (strftime('%Y-%m-%dT%H:%M:%f', 'now'))
);

CREATE INDEX IF NOT EXISTS idx_examples_status ON examples (status);
CREATE INDEX IF NOT EXISTS idx_examples_created_at ON examples (created_at);

-- updated_at の自動更新トリガー
CREATE TRIGGER IF NOT EXISTS trigger_update_updated_at
    AFTER UPDATE ON examples
    FOR EACH ROW
BEGIN
    UPDATE examples SET updated_at = strftime('%Y-%m-%dT%H:%M:%f', 'now') WHERE id = NEW.id;
END;
```

### 6.2 001_init.down.sql

```sql
DROP TRIGGER IF EXISTS trigger_update_updated_at;
DROP INDEX IF EXISTS idx_examples_created_at;
DROP INDEX IF EXISTS idx_examples_status;
DROP TABLE IF EXISTS examples;
```

## 7. RDBMS 間の構文差分

3つの RDBMS における主要な構文差分を以下にまとめる。

| 機能 | PostgreSQL | MySQL | SQLite |
|---|---|---|---|
| UUID生成 | `uuid_generate_v4()` | `UUID()` | `hex(randomblob(16))` |
| タイムスタンプ型 | `TIMESTAMPTZ` | `DATETIME(6)` | `TEXT` (ISO 8601) |
| デフォルトタイムスタンプ | `NOW()` | `CURRENT_TIMESTAMP(6)` | `strftime(..., 'now')` |
| 自動更新 | TRIGGER + FUNCTION | `ON UPDATE CURRENT_TIMESTAMP` | TRIGGER |
| スキーマ | `CREATE SCHEMA` | `CREATE DATABASE` | なし（単一ファイル） |
| 文字エンコーディング | デフォルトUTF-8 | utf8mb4指定必須 | UTF-8固定 |
| BOOLEAN | `BOOLEAN` (ネイティブ) | `TINYINT(1)` | `INTEGER` (0/1) |
| JSON | `JSONB` | `JSON` | `TEXT` (アプリ側でパース) |

## 8. マイグレーション運用ルール

- **冪等性**: up は `IF NOT EXISTS` / `IF EXISTS` を活用し、再実行しても安全な記述とする
- **対称性**: down は対応する up の完全な逆操作を記述する
- **検証**: 本番適用前にステージング環境で up / down の両方を検証する
- **分離**: データ投入（INSERT / UPDATE）とスキーマ変更（CREATE / ALTER）は別マイグレーションに分離する
- **段階的変更**: 破壊的変更（`DROP COLUMN` 等）は以下の3段階で実施する
  1. 非推奨化 — カラムの使用を停止（アプリ側の参照を除去）
  2. 移行 — 必要に応じてデータを新カラムへ移行
  3. 削除 — マイグレーションでカラムを DROP

## 9. マイグレーションツール設定

### Go (golang-migrate)

```bash
# 適用
migrate -path ./migrations -database "${DATABASE_URL}" up

# ロールバック
migrate -path ./migrations -database "${DATABASE_URL}" down 1

# 新規マイグレーション作成
migrate create -ext sql -dir ./migrations -seq {description}
```

`DATABASE_URL` の形式:

| RDBMS | URL 形式 |
|---|---|
| PostgreSQL | `postgres://user:pass@host:5432/dbname?sslmode=disable` |
| MySQL | `mysql://user:pass@tcp(host:3306)/dbname` |
| SQLite | `sqlite3://path/to/db.sqlite` |

### Rust (sqlx-cli)

```bash
# 適用
sqlx migrate run

# ロールバック
sqlx migrate revert

# 新規マイグレーション作成
sqlx migrate add {description}
```

`DATABASE_URL` 環境変数に接続文字列を設定する。Vault シークレットパスは `database/creds/{tier}-{service}-{permission}` から取得する。

## 10. 関連ドキュメント

> 共通参照は [テンプレートエンジン仕様.md](../engine/テンプレートエンジン仕様.md) を参照。

- [テンプレート仕様-サーバー](../server/サーバー.md) — サーバーテンプレート（DB接続コード）
- [テンプレート仕様-クライアント](../client/クライアント.md) — クライアントテンプレート
- [テンプレート仕様-ライブラリ](../codegen/ライブラリ.md) — ライブラリテンプレート
- [config設計](../../cli/config/config設計.md) — DB接続設定（config.yaml の database セクション）
- [認証認可設計](../../architecture/auth/認証認可設計.md) — Vault シークレット管理（DB クレデンシャル）
