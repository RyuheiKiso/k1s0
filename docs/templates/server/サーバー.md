# テンプレート仕様 — サーバー

## 概要

本ドキュメントは、k1s0 CLI の「ひな形生成」機能でサーバーを選択した際に生成される **全ファイルのスケルトンコード** を定義する。対象フレームワークは **Rust (axum + tokio)**。

クリーンアーキテクチャに基づく4レイヤー構成を採用する。

```
domain（エンティティ・リポジトリインターフェース）
  ↑
usecase（ビジネスロジック）
  ↑
adapter（ハンドラー・プレゼンター）
  ↑
infra（DB接続・メッセージング・設定ローダー）
```

## 条件付き生成表

CLI の対話フローで選択されたオプションに応じて、生成されるファイルが変わる。

| 条件                      | 選択肢                            | 影響を受けるファイル                                             |
| ------------------------- | --------------------------------- | ---------------------------------------------------------------- |
| API 方式 (`api_styles`)   | `rest`                            | handler/rest, OpenAPI 定義                                       |
|                           | `grpc`                            | handler/grpc, proto 定義, buf.yaml                               |
|                           | `graphql`                         | handler/graphql, schema.graphql（Rust はコードファースト）        |
| DB 有無 (`has_database`)  | `true`                            | persistence, config 内 database セクション, migrations/          |
|                           | `false`                           | 上記を生成しない                                                 |
| DB 種別 (`database_type`) | `postgresql` / `mysql` / `sqlite` | sqlx ドライバ依存、接続文字列形式                                |
| Kafka 有無 (`has_kafka`)  | `true`                            | messaging, config 内 kafka セクション                            |
|                           | `false`                           | 上記を生成しない                                                 |
| Redis 有無 (`has_redis`)  | `true`                            | config 内 redis セクション                                       |
|                           | `false`                           | 上記を生成しない                                                 |
| BFF (`bff_language`)      | `Go` / `Rust`                     | bff/ ディレクトリ（GraphQL + HTTP のみ、DB/Kafka/Redis なし）            |
| 常に生成                  | —                                 | テストファイル（usecase_test, handler_test, repository_test 等）、README.md |
| 常に生成                  | —                                 | observability（tracer, metrics）、auth middleware、rbac middleware        |
| API 方式 (`api_styles`)   | `grpc`                            | gRPC Health Check ハンドラー（grpc_health）                              |
| API 方式 (`api_styles`)   | `graphql`                         | GraphQL Subscription 型定義、WebSocket transport 設定                    |

### 複数 API 方式の同時選択

`api_styles` は配列型であり、REST と gRPC を同時に選択可能。テンプレート内では `api_styles is containing("xxx")` パターンで条件分岐を行う。

```tera
{% if api_styles is containing("rest") %}
  {# REST 固有のファイル内容 #}
{% endif %}
{% if api_styles is containing("grpc") %}
  {# gRPC 固有のファイル内容 #}
{% endif %}
```

REST + gRPC 同時選択時の生成ファイル一覧（Rust の例）:

| カテゴリ | 生成されるファイル |
|---|---|
| REST 固有 | `src/adapter/handler/rest.rs`, `api/openapi/openapi.yaml` |
| gRPC 固有 | `src/adapter/handler/grpc.rs`, `api/proto/service.proto`, `buf.yaml`, `build.rs` |
| 共通 | `Cargo.toml`（両方の依存を含む）, `src/main.rs`, ドメイン層, インフラ層 |

## Tier 別配置パス

| Tier     | 配置パス                                                  |
| -------- | --------------------------------------------------------- |
| system   | `regions/system/server/{lang}/{service_name}/`            |
| business | `regions/business/{domain}/server/{lang}/{service_name}/` |
| service  | `regions/service/{service_name}/server/{lang}/`           |

配置パスは CLI の `build_output_path()` で Tier・領域名・サービス名から動的に構築される。テンプレート内では `{{ rust_crate }}` でクレートパスを参照する。

---

## 共通技術スタック {#共通技術スタック}

system tier の全サーバーで共通して使用する技術スタック。サービス固有の依存は各 server.md に記載する。

| コンポーネント | Rust |
| --- | --- |
| HTTP フレームワーク | axum + tokio |
| gRPC フレームワーク | tonic v0.12 |
| DB アクセス | sqlx v0.8 |
| Kafka | rdkafka (rust-rdkafka) |
| OTel | opentelemetry v0.27 |
| 設定管理 | serde_yaml |
| バリデーション | validator v0.18 |
| シリアライゼーション | serde + serde_json |
| 非同期ランタイム | tokio 1 (full) |

---

## 分割先ドキュメント

本ドキュメントの詳細仕様は以下に分割されている。

| ドキュメント | 内容 |
|---|---|
| [テンプレート仕様-サーバー-Rust](サーバー-Rust.md) | Rust/axum+tokio テンプレート（main.rs・ドメイン・usecase・adapter・infra の詳細） |
| [テンプレート仕様-サーバー-可観測性](サーバー-可観測性.md) | 可観測性テンプレート・OpenTelemetry設定 |
| [テンプレート仕様-サーバー-認証](サーバー-認証.md) | 認証認可Middlewareテンプレート |
| [テンプレート仕様-サーバー-gRPC](サーバー-gRPC.md) | gRPC Health Check・GraphQL Subscription |

---

## 関連ドキュメント

- [テンプレートエンジン仕様](../engine/テンプレートエンジン仕様.md) — 変数置換・条件分岐の仕様
- [テンプレート仕様-クライアント](../client/クライアント.md) — クライアントテンプレート
- [テンプレート仕様-ライブラリ](../codegen/ライブラリ.md) — ライブラリテンプレート
- [テンプレート仕様-データベース](../data/データベース.md) — データベーステンプレート
- [CLIフロー](../../cli/flow/CLIフロー.md) — CLI の対話フローと操作手順
- [ディレクトリ構成図](../../architecture/overview/ディレクトリ構成図.md) — 生成先ディレクトリ構成
- [API設計](../../architecture/api/API設計.md) — REST / gRPC / GraphQL 設計
- [config設計](../../cli/config/config設計.md) — config.yaml スキーマと環境別管理
- [可観測性設計](../../architecture/observability/可観測性設計.md) — 監視・トレーシング設計
- [認証認可設計](../../architecture/auth/認証認可設計.md) — 認証・認可・シークレット管理
- [Dockerイメージ戦略](../../infrastructure/docker/Dockerイメージ戦略.md) — Docker ビルド戦略
- [メッセージング設計](../../architecture/messaging/メッセージング設計.md) — Kafka トピック・イベント駆動設計
- [コーディング規約](../../architecture/conventions/コーディング規約.md) — Linter・Formatter・テストツール
- [テンプレート仕様-Helm](../infrastructure/Helm.md) — Helm Chart テンプレート（gRPC ヘルスチェック設定含む）
- [テンプレート仕様-BFF](../client/BFF.md) — BFF テンプレート
