# テンプレート仕様 — サーバー — 可観測性

本ドキュメントは、[テンプレート仕様-サーバー](サーバー.md) から分割された可観測性テンプレート（Metrics / Tracing Exporter）の詳細仕様である。

---

## 可観測性テンプレート（Metrics / Tracing Exporter）

[可観測性設計.md](../../architecture/observability/可観測性設計.md) D-107（監視・アラート設計）および D-110（分散トレーシング設計）に基づき、サーバーテンプレート生成時に可観測性のスケルトンコードを自動生成する。メトリクスは Prometheus 形式（RED メソッド）、トレースは OpenTelemetry OTLP gRPC Exporter を使用する。

### src/infra/observability/tracer.rs

`src/infra/observability/tracer.rs.tera` — tracing-opentelemetry 初期化。[可観測性設計.md](../../architecture/observability/可観測性設計.md) D-110 の Rust 実装例に準拠する。

```rust
use opentelemetry::global;
use opentelemetry_otlp::SpanExporter;
use opentelemetry_sdk::{trace as sdktrace, Resource};
use std::error::Error;

/// OpenTelemetry TracerProvider を初期化する。
/// OTLP gRPC exporter を使用して Jaeger/Collector にトレースを送信する。
pub fn init_tracer() -> Result<sdktrace::TracerProvider, Box<dyn Error>> {
    let exporter = SpanExporter::builder()
        .with_tonic()
        .build()?;

    let provider = sdktrace::TracerProvider::builder()
        .with_batch_exporter(exporter)
        .with_resource(
            Resource::builder()
                .with_service_name("{{ service_name }}")
                .build(),
        )
        .build();

    global::set_tracer_provider(provider.clone());
    Ok(provider)
}
```

### src/infra/observability/metrics.rs

`src/infra/observability/metrics.rs.tera` — Prometheus metrics exporter。RED メソッドに基づくメトリクス公開。

```rust
use axum::{
    extract::MatchedPath,
    http::Request,
    middleware::Next,
    response::{IntoResponse, Response},
};
use prometheus::{CounterVec, Encoder, HistogramOpts, HistogramVec, TextEncoder};
use std::time::Instant;

const SERVICE_NAME: &str = "{{ service_name }}";

lazy_static::lazy_static! {
    static ref HTTP_REQUESTS_TOTAL: CounterVec = CounterVec::new(
        prometheus::opts!("http_requests_total", "Total number of HTTP requests")
            .const_label("service", SERVICE_NAME),
        &["method", "path", "status"],
    )
    .expect("failed to register http_requests_total");

    static ref HTTP_REQUEST_DURATION_SECONDS: HistogramVec = HistogramVec::new(
        HistogramOpts::new(
            "http_request_duration_seconds",
            "HTTP request duration in seconds",
        )
        .const_label("service", SERVICE_NAME)
        .buckets(vec![0.005, 0.01, 0.025, 0.05, 0.1, 0.25, 0.5, 1.0, 2.5, 5.0, 10.0]),
        &["method", "path"],
    )
    .expect("failed to register http_request_duration_seconds");
}

/// Prometheus メトリクスを収集する axum ミドルウェア。
pub async fn metrics_middleware<B>(req: Request<B>, next: Next<B>) -> Response {
    let method = req.method().to_string();
    let path = req
        .extensions()
        .get::<MatchedPath>()
        .map(|p| p.as_str().to_string())
        .unwrap_or_else(|| "unknown".to_string());

    let start = Instant::now();
    let response = next.run(req).await;
    let duration = start.elapsed().as_secs_f64();

    let status = response.status().as_u16().to_string();
    HTTP_REQUESTS_TOTAL
        .with_label_values(&[&method, &path, &status])
        .inc();
    HTTP_REQUEST_DURATION_SECONDS
        .with_label_values(&[&method, &path])
        .observe(duration);

    response
}

/// /metrics エンドポイントのハンドラー。Prometheus テキスト形式でメトリクスを返す。
pub async fn metrics_handler() -> impl IntoResponse {
    let encoder = TextEncoder::new();
    let metric_families = prometheus::gather();
    let mut buffer = Vec::new();
    encoder.encode(&metric_families, &mut buffer).unwrap();
    (
        [(axum::http::header::CONTENT_TYPE, "text/plain; charset=utf-8")],
        buffer,
    )
}
```

### src/infra/observability/mod.rs

`src/infra/observability/mod.rs.tera` — 可観測性モジュール宣言。

```rust
pub mod tracer;
pub mod metrics;
```

---

## 関連ドキュメント

> 共通参照は [テンプレートエンジン仕様.md](../engine/テンプレートエンジン仕様.md) を参照。

- [テンプレート仕様-サーバー](サーバー.md) --- 概要・条件付き生成表・Tier別配置パス
- [テンプレート仕様-サーバー-Rust](サーバー-Rust.md) --- Rust テンプレート詳細
- [テンプレート仕様-サーバー-認証](サーバー-認証.md) --- 認証認可Middleware テンプレート
- [テンプレート仕様-サーバー-gRPC](サーバー-gRPC.md) --- gRPC Health Check・GraphQL Subscription
- [可観測性設計](../../architecture/observability/可観測性設計.md) --- 監視・トレーシング設計
