# テンプレート仕様 — レンダリングテスト

## 概要

本ドキュメントは、k1s0 CLI のテンプレートレンダリング機能に対するテスト仕様を定義する。テンプレートから生成されたコードが仕様書（テンプレート仕様-サーバー.md 等）と一致し、Tera 構文の残留がないことを体系的に検証する。

### 目的

- テンプレートレンダリングの品質保証
- 仕様書とテンプレート実装の一致性検証
- 条件分岐（API 方式・DB・Kafka・Redis）の正確性保証
- テンプレート変数（ケース変換含む）の置換精度保証

### テスト2層構成

| 層 | 技術 | 対象 | 実行場所 |
|---|---|---|---|
| Rust 統合テスト | `cargo test` | テンプレートエンジンのレンダリング結果検証 | `CLI/tests/` |

Rust 統合テストは `TemplateEngine::render_to_dir()` を呼び出し、生成されたファイルの内容を直接検証する。

各層の詳細仕様は以下の分割ドキュメントを参照:

- [テンプレート仕様 — Rust 統合テスト](レンダリングテスト-Rust.md) — ヘルパー関数・テストパターン・スナップショットテスト・命名規則

---

## テスト対象マトリクス

| kind | language | オプション | Rust テスト |
|------|----------|-----------|-----------|
| server | go | REST/gRPC/GraphQL/DB/Kafka/Redis | `server_template_rendering.rs`  |
| server | rust | REST/gRPC/GraphQL/DB/Kafka/Redis | `server_template_rendering.rs`  |
| bff | go/rust | GraphQL | `bff_template_rendering.rs`  |
| client | react | — | 新規追加  |
| client | flutter | — | 新規追加  |
| library | go/rust/ts/dart | — | 新規追加  |
| database | postgresql/mysql/sqlite | — | 新規追加  |
| helm | — | REST/gRPC/GraphQL/DB | `helm_template_rendering.rs`  |
| cicd | go/rust | REST/gRPC/DB | `cicd_template_rendering.rs`  |
| terraform | — | env/modules | `terraform_template_rendering.rs`  |
| docker-compose | — | DB/Kafka/Redis | `docker_compose_template_rendering.rs`  |
| devcontainer | go/rust/ts/dart | DB/Kafka/Redis | `devcontainer_template_rendering.rs`  |
| service-mesh | — | tier/api_styles/NetworkPolicy | `service_mesh_template_rendering.rs`  |
| kong | — | tier/api_styles | `kong_template_rendering.rs`  |
| keycloak | — | tier | `keycloak_template_rendering.rs` | — |
| observability | — | tier | `observability_template_rendering.rs` | — |
| grafana | — | tier | `grafana_template_rendering.rs` | — |
| opentelemetry | — | tier | `opentelemetry_template_rendering.rs` | — |
| loki | — | tier | `loki_template_rendering.rs` | — |
| alertmanager | — | tier/environment | `alertmanager_template_rendering.rs` | — |
| kafka | — | tier/has_kafka | `kafka_template_rendering.rs` | — |
| vault | — | tier/has_database/has_kafka/has_redis | `vault_template_rendering.rs` | — |
| flagger | — | tier | `flagger_template_rendering.rs` | — |
| consul | — | environment | `consul_template_rendering.rs` | — |
| storage | — | tier/has_database | `storage_template_rendering.rs` | — |

---

## CI 統合

テンプレートレンダリングテストは CI パイプラインに統合されており、`.github/workflows/ci.yaml` の `test-rust` ジョブで自動実行される。

### 実行方法

```bash
# Rust 統合テスト（全テンプレートのレンダリング検証）
cd CLI && cargo test --all

```

### テストファイル一覧

| Rust テストファイル | テスト対象 kind | テスト数 |
|---|---|---|
| `server_template_rendering.rs` | server (Go/Rust) | ~30 |
| `bff_template_rendering.rs` | bff (Go/Rust) | 16 |
| `helm_template_rendering.rs` | helm | ~15 |
| `service_mesh_template_rendering.rs` | service-mesh (NetworkPolicy 含む) | ~20 |
| `client_template_rendering.rs` | client (React/Flutter) | ~10 |
| `library_template_rendering.rs` | library (Go/Rust/TS/Dart) | ~10 |
| `cicd_template_rendering.rs` | cicd | ~10 |
| `devcontainer_template_rendering.rs` | devcontainer | ~10 |
| `docker_compose_template_rendering.rs` | docker-compose | ~10 |
| `terraform_template_rendering.rs` | terraform | ~10 |
| `database_template_rendering.rs` | database | ~5 |
| `kong_template_rendering.rs` | kong | ~10 |
| `keycloak_template_rendering.rs` | keycloak | ~7 |
| `observability_template_rendering.rs` | observability | ~10 |
| `grafana_template_rendering.rs` | grafana | ~10 |
| `opentelemetry_template_rendering.rs` | opentelemetry | ~8 |
| `loki_template_rendering.rs` | loki | ~8 |
| `alertmanager_template_rendering.rs` | alertmanager | ~10 |
| `kafka_template_rendering.rs` | kafka | ~10 |
| `vault_template_rendering.rs` | vault | ~12 |
| `flagger_template_rendering.rs` | flagger | ~10 |
| `consul_template_rendering.rs` | consul | ~6 |
| `storage_template_rendering.rs` | storage | ~8 |

---

## テストデータ定義

### 標準コンテキスト

Rust 統合テストで使用するデフォルトのテンプレートコンテキスト値。

| 変数 | テスト用デフォルト値 | 備考 |
|------|-------------------|------|
| `service_name` | `"order-api"` | kebab-case 正規形 |
| `service_name_snake` | `"order_api"` | 自動導出 |
| `service_name_pascal` | `"OrderApi"` | 自動導出 |
| `service_name_camel` | `"orderApi"` | 自動導出 |
| `tier` | `"service"` | 最も一般的な階層 |
| `domain` | `""` | service tier では空 |
| `language` | テストにより変動 | `"rust"` / `"typescript"` / `"dart"` |
| `kind` | テストにより変動 | `"server"` / `"client"` / `"library"` / `"database"` |
| `api_style` | テストにより変動 | `"rest"` / `"grpc"` / `"graphql"` |
| `has_database` | テストにより変動 | `true` / `false` |
| `database_type` | テストにより変動 | `"postgresql"` / `"mysql"` / `"sqlite"` |
| `has_kafka` | テストにより変動 | `true` / `false` |
| `has_redis` | テストにより変動 | `true` / `false` |
| `rust_crate` | 自動導出 | `"order-api"` |
| `docker_registry` | `"harbor.internal.example.com"` | デフォルト値 |
| `docker_project` | `"k1s0-service"` | 自動導出: `"k1s0-{tier}"` |

### 変数置換テスト用コンテキスト

ケース変換の正確性を検証するため、別名 `"user-auth"` を使用する。

| 変数 | 値 |
|------|-----|
| `service_name` | `"user-auth"` |
| `service_name_snake` | `"user_auth"` |
| `service_name_pascal` | `"UserAuth"` |
| `service_name_camel` | `"userAuth"` |

---

## テスト命名規則

### Rust 統合テスト

```
test_{kind}_{language}_{feature}
```

例:
- `test_go_server_rest_full_stack_file_list` — Go サーバー・REST・フルスタック・ファイルリスト
- `test_rust_server_grpc_minimal_file_list` — Rust サーバー・gRPC・最小構成・ファイルリスト
- `test_tera_variable_substitution_consistency` — Tera 変数置換の一貫性

---

## 関連ドキュメント

- [テンプレート仕様 — Rust 統合テスト](レンダリングテスト-Rust.md) — ヘルパー関数・テストパターン・スナップショットテスト・命名規則
- [テンプレートエンジン仕様](../engine/テンプレートエンジン仕様.md) — テンプレート変数・フィルタ・構文の定義
- [テンプレート仕様-サーバー](../server/サーバー.md) — サーバーテンプレートの詳細仕様
- [テンプレート仕様-React](../client/React.md) — React クライアントテンプレートの詳細仕様
- [テンプレート仕様-Flutter](../client/Flutter.md) — Flutter クライアントテンプレートの詳細仕様
- [テンプレート仕様-ライブラリ](../codegen/ライブラリ.md) — ライブラリテンプレートの詳細仕様
- [テンプレート仕様-データベース](../data/データベース.md) — データベーステンプレートの詳細仕様
- [テンプレート仕様-Terraform](../infrastructure/Terraform.md) — Terraform テンプレートの詳細仕様
- [テンプレート仕様-DockerCompose](../infrastructure/DockerCompose.md) — Docker Compose テンプレートの詳細仕様
- [テンプレート仕様-devcontainer](../infrastructure/devcontainer.md) — devcontainer テンプレートの詳細仕様
- [テンプレート仕様-ServiceMesh](../middleware/ServiceMesh.md) — Service Mesh テンプレートの詳細仕様
- [テンプレート仕様-Grafana](../observability/Grafana.md) — Grafana ダッシュボードテンプレートの詳細仕様
- [テンプレート仕様-OpenTelemetry](../observability/OpenTelemetry.md) — OpenTelemetry Collector テンプレートの詳細仕様
- [テンプレート仕様-Loki](../observability/Loki.md) — Loki ログ収集テンプレートの詳細仕様
- [テンプレート仕様-Alertmanager](../observability/Alertmanager.md) — Alertmanager 通知テンプレートの詳細仕様
- [テンプレート仕様-Kafka](../middleware/Kafka.md) — Kafka トピックテンプレートの詳細仕様
- [テンプレート仕様-Vault](../middleware/Vault.md) — Vault シークレット管理テンプレートの詳細仕様
- [テンプレート仕様-Flagger](../middleware/Flagger.md) — Flagger カナリアリリーステンプレートの詳細仕様
- [テンプレート仕様-Consul](../middleware/Consul.md) — Consul State Backend テンプレートの詳細仕様
- [テンプレート仕様-Storage](../middleware/Storage.md) — Ceph ストレージテンプレートの詳細仕様
