# Tauri GUI 設計

k1s0 CLI の機能を GUI で提供するデスクトップアプリケーションの設計を定義する。Tauri 2 を採用し、CLI と同一の Rust コアロジックを共有することで、ターミナル操作に不慣れなユーザーにも同等の開発体験を提供する。

## 目的

| 目標                         | 概要                                                                           |
| ---------------------------- | ------------------------------------------------------------------------------ |
| ターミナル操作の代替         | コマンドプロンプトに不慣れなユーザーが GUI で k1s0 の全機能を利用できるようにする |
| CLI との機能等価             | CLI で提供するすべての操作（初期化・ひな形生成・ビルド・テスト・デプロイ）を GUI でも実行可能にする |
| コアロジックの一元化         | CLI と GUI で同一の Rust クレートを共有し、ロジックの重複と乖離を防止する       |
| クロスプラットフォーム配布   | Windows・macOS・Linux 向けのインストーラーを単一のビルドパイプラインで生成する   |

## 技術スタック

| 技術              | バージョン | 用途                                 |
| ----------------- | ---------- | ------------------------------------ |
| Tauri             | 2          | デスクトップアプリケーションフレームワーク |
| React             | 18         | GUI のフロントエンド                 |
| TypeScript        | 5          | フロントエンドの型安全な実装         |
| TanStack Router   | —          | GUI 内のページルーティング           |
| Tailwind CSS      | —          | スタイリング                         |
| Radix UI          | —          | アクセシブルな UI コンポーネント     |
| React Hook Form   | —          | フォーム状態管理                     |
| Zod               | —          | バリデーション                       |

> React 関連の技術選定は [コンセプト](コンセプト.md) のクライアント（React）セクションに準拠する。

## アーキテクチャ

### CLI コアの分離

現在の CLI（`CLI/src/`）のビジネスロジックをライブラリクレート（`lib.rs`）として分離し、CLI バイナリと Tauri アプリの両方から呼び出す構成とする。

```
CLI/
├── Cargo.toml              # workspace メンバー定義
├── crates/
│   └── k1s0-core/          # 共有ライブラリクレート
│       ├── Cargo.toml
│       └── src/
│           ├── lib.rs
│           ├── commands/    # init, generate, build, test, deploy
│           ├── config/
│           └── template/    # Tera テンプレート処理
├── src/                     # CLI バイナリ
│   ├── main.rs              # dialoguer による対話 UI
│   └── ...
├── gui/                     # Tauri GUI アプリケーション
│   ├── src-tauri/
│   │   ├── Cargo.toml       # k1s0-core を依存に持つ
│   │   ├── src/
│   │   │   ├── main.rs      # Tauri エントリーポイント
│   │   │   └── commands.rs  # #[tauri::command] 定義
│   │   └── tauri.conf.json
│   ├── src/                 # React フロントエンド
│   │   ├── App.tsx
│   │   ├── pages/
│   │   │   ├── Init.tsx         # プロジェクト初期化
│   │   │   ├── Generate.tsx     # ひな形生成ウィザード
│   │   │   ├── Build.tsx        # ビルド
│   │   │   ├── Test.tsx         # テスト実行
│   │   │   └── Deploy.tsx       # デプロイ
│   │   └── components/
│   ├── package.json
│   └── tsconfig.json
└── templates/               # 既存テンプレート（CLI・GUI 共有）
```

### 共有クレートの責務

`k1s0-core` クレートは以下の責務を持つ。CLI と GUI の両方から利用される。

| モジュール       | 責務                                                                 |
| ---------------- | -------------------------------------------------------------------- |
| `commands::init` | プロジェクト初期化（Git 初期化、sparse-checkout、ディレクトリ生成）   |
| `commands::generate` | ひな形生成（種別・Tier・言語の組み合わせに応じたテンプレート展開） |
| `commands::build` | ビルド実行                                                          |
| `commands::test_cmd` | テスト実行                                                       |
| `commands::deploy` | デプロイ実行（Docker ビルド・プッシュ・Cosign 署名・Helm デプロイ） |
| `config`         | CLI 設定の読み込み                                                   |
| `template`       | Tera テンプレート処理（コンテキスト生成・フィルタ）                  |

### CLI と GUI の関係

```
                   ┌─────────────────────┐
                   │    k1s0-core        │
                   │  (共有Rustクレート)  │
                   └──────┬──────┬───────┘
                          │      │
            ┌─────────────┘      └──────────────┐
            │                                    │
   ┌────────┴────────┐               ┌──────────┴──────────┐
   │   k1s0 CLI      │               │   k1s0 GUI (Tauri)  │
   │                  │               │                      │
   │  dialoguer       │               │  React + Tauri       │
   │  ターミナル派向け │               │  GUI 派向け          │
   └─────────────────┘               └──────────────────────┘
```

- CLI は `dialoguer` でターミナル上の対話を行い、`k1s0-core` のコマンドを呼び出す
- GUI は React で描画したフォーム・ウィザードから `#[tauri::command]` 経由で `k1s0-core` のコマンドを呼び出す
- テンプレートファイル（`CLI/templates/`）は両者で共有する

## GUI フロー

GUI は [CLIフロー](CLIフロー.md) と同等の操作をウィザード形式で提供する。CLI の各対話ステップは GUI のフォームページに対応する。

### メインメニュー

CLI のメインメニューに対応するダッシュボード画面を提供する。

| CLI メニュー項目   | GUI 対応                   |
| ------------------ | -------------------------- |
| プロジェクト初期化 | Init ページ               |
| ひな形生成         | Generate ウィザード       |
| ビルド             | Build ページ              |
| テスト実行         | Test ページ               |
| デプロイ           | Deploy ページ             |

### ひな形生成ウィザード

CLI の対話ステップ（ステップ 1〜5 + 確認）をステッパー UI で実装する。各ステップ間の遷移は「次へ」「戻る」ボタンで行う。

| ステップ | CLI の対話               | GUI の UI 要素                                             |
| -------- | ------------------------ | ---------------------------------------------------------- |
| 1        | 種別の選択               | ラジオボタン（サーバー / クライアント / ライブラリ / データベース） |
| 2        | Tier の選択              | ラジオボタン（種別に応じた選択肢の制限は CLI と同一）       |
| 3        | 配置先の指定             | セレクトボックス（既存一覧）+ テキスト入力（新規作成）      |
| 4        | 言語 / FW の選択         | ラジオボタン                                                |
| 5        | 詳細設定                 | チェックボックス群（API 方式・DB・Kafka・Redis）            |
| 確認     | 生成内容の確認           | サマリーカード + 「生成」ボタン                              |

#### バリデーション

[CLIフロー](CLIフロー.md) の入力バリデーションと同一のルールを GUI でも適用する。

- サービス名・領域名: `[a-z0-9-]+`（先頭末尾のハイフン禁止）
- 既存名との重複検出
- Zod スキーマで定義し、React Hook Form と連携する

### 進捗表示

ビルド・テスト・デプロイの実行中は、CLI のテキスト出力に代わりプログレスバーとログビューアーで進捗を表示する。Tauri のイベントシステム（`emit` / `listen`）を使用して、Rust バックエンドからフロントエンドにリアルタイムで進捗を通知する。

## Tier アーキテクチャとの関係

Tauri GUI アプリケーション自体は k1s0 の Tier（system / business / service）には属さない。GUI は **開発ツール** であり、Tier 内にデプロイされるアプリケーションとは異なる位置づけである。

- GUI が生成するひな形は、[tier-architecture](tier-architecture.md) の規則に従って `regions/` 配下に配置される
- Tier 別の配置制約（例: system 層に client を配置しない）は [CLIフロー](CLIフロー.md) のロジックと共有される `k1s0-core` によって強制される
- GUI のフロントエンド（React）は service 層のクライアントテンプレートとは独立しており、[テンプレート仕様-クライアント](テンプレート仕様-クライアント.md) の対象外である

## テンプレート変数への影響

GUI の導入に伴うテンプレート変数（[テンプレートエンジン仕様](テンプレートエンジン仕様.md)）の変更はない。GUI は CLI と同一の `k1s0-core` を通じてテンプレートコンテキストを構築するため、変数一覧・導出ルールはすべて既存の仕様に従う。

## 認証方式

GUI アプリケーション自体の認証（k1s0 の操作に必要な認証）は、CLI と同様に **Device Authorization Grant** フローを使用する（[認証認可設計](認証認可設計.md) 参照）。ただし、Tauri の WebView を利用した **Authorization Code + PKCE** フローへの変更も検討可能である。

| 方式                         | 適用対象     | 説明                                           |
| ---------------------------- | ------------ | ---------------------------------------------- |
| Device Authorization Grant   | CLI          | ブラウザで認証コードを入力（[認証認可設計](認証認可設計.md) 準拠） |
| Authorization Code + PKCE    | GUI（候補）  | Tauri の WebView 内でリダイレクトベースの認証   |

## Flutter クライアントとの棲み分け

Tauri GUI は **k1s0 開発ツールの GUI ラッパー** であり、service / business Tier にデプロイされるクライアントアプリケーションとは用途が異なる。

| 項目           | Tauri GUI                     | Flutter クライアント                       |
| -------------- | ----------------------------- | ------------------------------------------ |
| 用途           | k1s0 の操作（開発ツール）     | エンドユーザー向けアプリケーション          |
| 配置先         | 開発者のローカルマシン         | service / business Tier                    |
| 対象ユーザー   | 開発者                         | 業務ユーザー                               |
| デプロイ先     | デスクトップインストーラー配布 | Web / Mobile アプリストア                  |
| フレームワーク | React（Tauri WebView）        | Flutter（[コンセプト](コンセプト.md) 準拠） |

## 配布

Tauri 2 のバンドラーを使用して、各 OS 向けのインストーラーを生成する。

| OS      | フォーマット       |
| ------- | ------------------ |
| Windows | `.msi` / `.exe`    |
| macOS   | `.dmg`             |
| Linux   | `.AppImage` / `.deb` |

CI/CD パイプライン（GitHub Actions）でクロスプラットフォームビルドを行い、リリースごとにインストーラーを生成する。配布はプロジェクト内部のレジストリまたは GitHub Releases を使用する。

## 関連ドキュメント

- [コンセプト](コンセプト.md) — プロジェクトの技術スタック・設計思想
- [CLIフロー](CLIフロー.md) — CLI の対話フローと操作手順（GUI の機能仕様の基盤）
- [tier-architecture](tier-architecture.md) — 3 階層アーキテクチャ
- [テンプレートエンジン仕様](テンプレートエンジン仕様.md) — Tera テンプレート変数・導出ルール
- [テンプレート仕様-クライアント](テンプレート仕様-クライアント.md) — React / Flutter クライアントテンプレート
- [認証認可設計](認証認可設計.md) — OAuth2 / OIDC フロー
- [CI-CD設計](CI-CD設計.md) — GitHub Actions パイプライン
