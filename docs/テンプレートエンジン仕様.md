# テンプレートエンジン仕様

## 概要

k1s0 プロジェクトでは、テンプレートエンジンとして **Tera** を採用する。Tera は Rust 製の Jinja2 互換テンプレートエンジンであり、以下の理由から選定した。

### 選定理由

1. **ネイティブ統合** — k1s0 の CLI は Rust で実装されており、Tera は Rust のクレートとしてそのまま組み込める。FFI やサブプロセス呼び出しが不要で、パフォーマンスと安全性の両面で優れる。
2. **低い学習コスト** — Jinja2 ライクな構文（`{{ }}` による変数展開、`{% %}` による制御構文）を採用しており、Python や Go のテンプレートエンジンの経験があれば短期間で習得できる。
3. **充実した機能** — 条件分岐（`if` / `elif` / `else`）、ループ（`for`）、フィルタ（`| filter_name`）、テンプレート継承（`extends` / `block`）、マクロ（`macro`）など、プロジェクトのひな形生成に必要な機能を網羅している。

## テンプレート変数一覧

CLI の対話フローで収集した情報をもとに、以下の変数がテンプレートコンテキストに注入される。

| 変数名 | 型 | 説明 | 例 |
|---|---|---|---|
| `service_name` | String | サービス名（kebab-case） | `order-api` |
| `service_name_snake` | String | サービス名（snake_case） | `order_api` |
| `service_name_pascal` | String | サービス名（PascalCase） | `OrderApi` |
| `service_name_camel` | String | サービス名（camelCase） | `orderApi` |
| `tier` | String | 配置階層 | `system` / `business` / `service` |
| `domain` | String | 業務領域名（business Tier 時） | `accounting` / `fa` / `hr` |
| `module_path` | String | regions/ からの相対パス | `regions/service/order/server/go` |
| `language` | String | 言語識別子 | `go` / `rust` / `typescript` / `dart` |
| `kind` | String | 種別 | `server` / `client` / `library` / `database` |
| `api_style` | String | API 方式（server 時） | `rest` / `grpc` / `graphql` |
| `has_database` | bool | DB 有無 | `true` / `false` |
| `database_type` | String | RDBMS 種別（DB 有効時） | `postgresql` / `mysql` / `sqlite` |
| `has_kafka` | bool | Kafka 有無 | `true` / `false` |
| `has_redis` | bool | Redis 有無 | `true` / `false` |
| `go_module` | String | Go モジュールパス（Go 時） | `github.com/org/k1s0/regions/service/order/server/go` |
| `rust_crate` | String | Rust クレート名（Rust 時） | `order-api` |
| `docker_registry` | String | Docker レジストリ | `harbor.internal.example.com` |
| `docker_project` | String | Docker プロジェクト名 | `k1s0-service` |
| `api_styles` | Vec\<String> | API 方式リスト（複数選択対応） | `["rest", "grpc"]` |
| `framework` | String | フレームワーク名（client 時） | `react` / `flutter` |
| `helm_path` | String | Helm Chart の Tier 別相対パス | `service/order` / `business/accounting/ledger` |

## 変数の導出ルール

テンプレート変数の多くは `service_name` や `tier` などの入力値から自動的に導出される。以下にその導出ルールを示す。

### service_name からのケース変換

ユーザーが入力する `service_name` は kebab-case を正規形とする。他のケースは以下のルールで自動変換される。

| 入力 (kebab-case) | snake_case | PascalCase | camelCase |
|---|---|---|---|
| `order-api` | `order_api` | `OrderApi` | `orderApi` |
| `user-auth-service` | `user_auth_service` | `UserAuthService` | `userAuthService` |
| `inventory` | `inventory` | `Inventory` | `inventory` |

変換ロジック:

```
kebab-case  → ハイフンをアンダースコアに置換 → snake_case
snake_case  → 各セグメントの先頭を大文字化して結合 → PascalCase
PascalCase  → 先頭文字を小文字化 → camelCase
```

### tier から docker_project への導出

`docker_project` は `tier` の値を用いて以下のように構成される。

```
docker_project = "k1s0-{tier}"
```

| tier | docker_project |
|---|---|
| `system` | `k1s0-system` |
| `business` | `k1s0-business` |
| `service` | `k1s0-service` |

### domain の設定ルール

`domain` は **business Tier のみ** で使用される変数であり、業務領域名を表す。system / service Tier では空文字列となる。

| tier | domain | 説明 |
|---|---|---|
| `system` | （空文字列） | system 層にドメイン概念はない |
| `business` | `accounting` / `fa` / `hr` 等 | 業務領域ごとにディレクトリを分離 |
| `service` | （空文字列） | service 層はサービス名で直接分離 |

### module_path の構成ルール

`module_path` は **Tier ごとに異なるルール** で構成される。各 Tier の配置パスは [テンプレート仕様-サーバー](テンプレート仕様-サーバー.md)・[テンプレート仕様-クライアント](テンプレート仕様-クライアント.md)・[テンプレート仕様-ライブラリ](テンプレート仕様-ライブラリ.md) の Tier 別配置パスに準拠する。

```
# service Tier
module_path = "regions/service/{service_name}/{kind}/{language}"

# system Tier
module_path = "regions/system/{kind}/{language}/{service_name}"

# business Tier
module_path = "regions/business/{domain}/{kind}/{language}/{service_name}"
```

例:

| tier | domain | service_name | kind | language | module_path |
|---|---|---|---|---|---|
| `service` | — | `order` | `server` | `go` | `regions/service/order/server/go` |
| `system` | — | `auth` | `library` | `rust` | `regions/system/library/rust/auth` |
| `business` | `accounting` | `ledger-api` | `server` | `go` | `regions/business/accounting/server/go/ledger-api` |
| `business` | `fa` | `asset-app` | `client` | `react` | `regions/business/fa/client/react/asset-app` |

### api_styles の設定ルール

`api_styles` は `api_style` の複数選択対応版であり、CLI の対話フローで複数の API 方式を選択した場合に使用される。`api_style` は後方互換のため `api_styles` の先頭要素が設定される。

### framework の設定ルール

`framework` は **client** kind のみで使用される変数であり、選択されたフレームワーク名を表す。server / library / database では空文字列となる。

| kind | framework | language |
|---|---|---|
| `client` | `react` | `typescript` |
| `client` | `flutter` | `dart` |
| `server` | （空文字列） | `go` / `rust` |

### helm_path の構成ルール

`helm_path` は Helm Chart の配置先を示す **Tier 別の相対パス** であり、`infra/helm/services/` からの相対位置を表す。Deploy ワークフロー（CICD テンプレート）で `helm upgrade --install` のパス指定に使用される。

```
# system / service Tier
helm_path = "{tier}/{service_name}"

# business Tier
helm_path = "business/{domain}/{service_name}"
```

例:

| tier | domain | service_name | helm_path |
|---|---|---|---|
| `service` | — | `order` | `service/order` |
| `system` | — | `auth` | `system/auth` |
| `business` | `accounting` | `ledger` | `business/accounting/ledger` |

### go_module の構成ルール

Go プロジェクトの場合、`go_module` は `module_path` を用いて以下のように構成される。

```
go_module = "github.com/org/k1s0/{module_path}"
```

例:

| tier | module_path | go_module |
|---|---|---|
| `service` | `regions/service/order/server/go` | `github.com/org/k1s0/regions/service/order/server/go` |
| `system` | `regions/system/server/go/auth` | `github.com/org/k1s0/regions/system/server/go/auth` |
| `business` | `regions/business/accounting/server/go/ledger-api` | `github.com/org/k1s0/regions/business/accounting/server/go/ledger-api` |

## 条件分岐構文

Tera では `{% if %}` / `{% elif %}` / `{% else %}` / `{% endif %}` を用いて条件分岐を記述する。k1s0 で使用する主要な条件分岐パターンを以下に示す。

### データベース有無による分岐

```tera
{% if has_database %}
// DB 関連の初期化コード
// database_type: {{ database_type }}
{% endif %}
```

### API 方式による分岐

```tera
{% if api_style == "rest" %}
// REST 固有コード（gin / axum のルーティング設定）
{% elif api_style == "grpc" %}
// gRPC 固有コード（proto 定義に基づくサービス実装）
{% elif api_style == "graphql" %}
// GraphQL 固有コード（スキーマ・リゾルバ定義）
{% endif %}
```

### 言語による分岐

```tera
{% if language == "go" %}
// Go 固有コード（gin フレームワーク）
{% elif language == "rust" %}
// Rust 固有コード（axum + tokio フレームワーク）
{% endif %}
```

### メッセージング・キャッシュの分岐

```tera
{% if has_kafka %}
// Kafka プロデューサー / コンシューマーの初期化
{% endif %}

{% if has_redis %}
// Redis クライアントの初期化
{% endif %}
```

### 複合条件の例

```tera
{% if has_database and database_type == "postgresql" %}
// PostgreSQL 固有の接続設定
{% endif %}

{% if api_style == "rest" and language == "go" %}
// gin を用いた REST ハンドラ
{% elif api_style == "rest" and language == "rust" %}
// axum を用いた REST ハンドラ
{% endif %}
```

## ループ構文

Tera では `{% for %}` / `{% endfor %}` を用いてループを記述する。現時点では単一サービスの生成が主なユースケースだが、将来のバッチ生成や一括設定生成に備えてドキュメント化する。

### 基本構文

```tera
{% for item in items %}
{{ item }}
{% endfor %}
```

### インデックス付きループ

```tera
{% for item in items %}
{{ loop.index }}. {{ item }}
{% endfor %}
```

`loop` オブジェクトでは以下のプロパティが利用可能:

| プロパティ | 型 | 説明 |
|---|---|---|
| `loop.index` | int | 1 始まりのインデックス |
| `loop.index0` | int | 0 始まりのインデックス |
| `loop.first` | bool | 最初の要素かどうか |
| `loop.last` | bool | 最後の要素かどうか |

### 将来の利用想定例

```tera
{% for endpoint in endpoints %}
// {{ endpoint.method }} {{ endpoint.path }}
func {{ endpoint.handler_name }}(c *gin.Context) {
    // TODO: 実装
}
{% endfor %}
```

## フィルタ

Tera のフィルタはパイプ記法（`|`）でテンプレート変数に適用する。

### ケース変換フィルタ

k1s0 では以下のカスタムフィルタを登録して使用する。

| フィルタ | 説明 | 入力例 | 出力例 |
|---|---|---|---|
| `snake_case` | snake_case に変換 | `order-api` | `order_api` |
| `pascal_case` | PascalCase に変換 | `order-api` | `OrderApi` |
| `camel_case` | camelCase に変換 | `order-api` | `orderApi` |
| `kebab_case` | kebab-case に変換 | `order_api` | `order-api` |
| `upper_case` | 全て大文字に変換 | `order-api` | `ORDER-API` |
| `lower_case` | 全て小文字に変換 | `OrderApi` | `orderapi` |

使用例:

```tera
package {{ service_name | snake_case }}

type {{ service_name | pascal_case }}Service struct {
    // ...
}

func new{{ service_name | pascal_case }}Service() *{{ service_name | pascal_case }}Service {
    return &{{ service_name | pascal_case }}Service{}
}
```

### 組み込みフィルタ

Tera が標準で提供する主要フィルタ:

| フィルタ | 説明 | 使用例 |
|---|---|---|
| `default(value="...")` | 値が未定義の場合にデフォルト値を使用 | `{{ port \| default(value="8080") }}` |
| `trim` | 前後の空白を除去 | `{{ name \| trim }}` |
| `replace(from="...", to="...")` | 文字列置換 | `{{ name \| replace(from="-", to="_") }}` |
| `upper` | 大文字化 | `{{ name \| upper }}` |
| `lower` | 小文字化 | `{{ name \| lower }}` |
| `capitalize` | 先頭文字を大文字化 | `{{ name \| capitalize }}` |
| `title` | 各単語の先頭を大文字化（Title Case） | `{{ name \| title }}` |
| `length` | 長さを取得 | `{{ items \| length }}` |
| `join(sep="...")` | 配列を結合 | `{{ tags \| join(sep=", ") }}` |

### default フィルタの活用

オプショナルな変数にはデフォルト値を設定し、テンプレートの堅牢性を確保する。

```tera
port: {{ port | default(value="8080") }}
log_level: {{ log_level | default(value="info") }}
max_connections: {{ max_connections | default(value="100") }}
```

## CLI/templates/ ディレクトリ構成

テンプレートファイルは `CLI/templates/` 配下に、`kind` と `language` の組み合わせで階層化して配置する。ファイル名は生成先のファイル名に `.tera` 拡張子を付与した形式とする。

```
CLI/
└── templates/
    ├── server/
    │   ├── go/
    │   │   ├── cmd/main.go.tera
    │   │   ├── internal/domain/model/entity.go.tera
    │   │   ├── internal/domain/repository/repository.go.tera
    │   │   ├── internal/usecase/usecase.go.tera
    │   │   ├── internal/usecase/usecase_test.go.tera
    │   │   ├── internal/adapter/handler/rest_handler.go.tera
    │   │   ├── internal/adapter/handler/grpc_handler.go.tera
    │   │   ├── internal/adapter/handler/graphql_resolver.go.tera
    │   │   ├── internal/adapter/handler/handler_test.go.tera
    │   │   ├── internal/infra/persistence/db.go.tera
    │   │   ├── internal/infra/persistence/repository.go.tera
    │   │   ├── internal/infra/persistence/repository_test.go.tera
    │   │   ├── internal/infra/messaging/kafka.go.tera
    │   │   ├── internal/infra/config/config.go.tera
    │   │   ├── config/config.yaml.tera
    │   │   ├── api/openapi/openapi.yaml.tera
    │   │   ├── api/proto/service.proto.tera
    │   │   ├── api/graphql/schema.graphql.tera
    │   │   ├── gqlgen.yml.tera
    │   │   ├── buf.yaml.tera
    │   │   ├── buf.gen.yaml.tera
    │   │   ├── go.mod.tera
    │   │   ├── Dockerfile.tera
    │   │   ├── oapi-codegen.yaml.tera
    │   │   └── README.md.tera
    │   └── rust/
    │       ├── src/main.rs.tera
    │       ├── src/domain/mod.rs.tera
    │       ├── src/domain/model.rs.tera
    │       ├── src/domain/repository.rs.tera
    │       ├── src/usecase/mod.rs.tera
    │       ├── src/usecase/service.rs.tera
    │       ├── src/adapter/mod.rs.tera
    │       ├── src/adapter/handler/mod.rs.tera
    │       ├── src/adapter/handler/rest.rs.tera
    │       ├── src/adapter/handler/grpc.rs.tera
    │       ├── src/adapter/handler/graphql.rs.tera
    │       ├── src/infra/mod.rs.tera
    │       ├── src/infra/persistence.rs.tera
    │       ├── src/infra/messaging.rs.tera
    │       ├── src/infra/config.rs.tera
    │       ├── config/config.yaml.tera
    │       ├── tests/integration_test.rs.tera
    │       ├── build.rs.tera
    │       ├── buf.yaml.tera
    │       ├── Cargo.toml.tera
    │       ├── Dockerfile.tera
    │       └── README.md.tera
    ├── client/
    │   ├── react/
    │   │   ├── package.json.tera
    │   │   ├── tsconfig.json.tera
    │   │   ├── vite.config.ts.tera
    │   │   ├── eslint.config.mjs.tera
    │   │   ├── .prettierrc.tera
    │   │   ├── vitest.config.ts.tera
    │   │   ├── src/app/App.tsx.tera
    │   │   ├── src/lib/api-client.ts.tera
    │   │   ├── src/lib/query-client.ts.tera
    │   │   ├── tests/testutil/setup.ts.tera
    │   │   ├── tests/testutil/msw-setup.ts.tera
    │   │   ├── tests/App.test.tsx.tera
    │   │   ├── Dockerfile.tera
    │   │   ├── nginx.conf.tera
    │   │   └── README.md.tera
    │   └── flutter/
    │       ├── pubspec.yaml.tera
    │       ├── analysis_options.yaml.tera
    │       ├── lib/main.dart.tera
    │       ├── lib/app/router.dart.tera
    │       ├── lib/utils/dio_client.dart.tera
    │       ├── test/widget_test.dart.tera
    │       ├── Dockerfile.tera
    │       ├── nginx.conf.tera
    │       └── README.md.tera
    ├── library/
    │   ├── go/
    │   │   ├── go.mod.tera
    │   │   ├── {name}.go.tera
    │   │   └── internal/internal.go.tera
    │   ├── rust/
    │   │   ├── Cargo.toml.tera
    │   │   ├── src/lib.rs.tera
    │   │   └── src/{module}.rs.tera
    │   ├── typescript/
    │   │   ├── package.json.tera
    │   │   ├── tsconfig.json.tera
    │   │   └── src/index.ts.tera
    │   └── dart/
    │       ├── pubspec.yaml.tera
    │       ├── lib/{name}.dart.tera
    │       └── lib/src/{module}.dart.tera
    └── database/
        ├── postgresql/
        │   ├── 001_init.up.sql.tera
        │   └── 001_init.down.sql.tera
        ├── mysql/
        │   ├── 001_init.up.sql.tera
        │   └── 001_init.down.sql.tera
        └── sqlite/
            ├── 001_init.up.sql.tera
            └── 001_init.down.sql.tera
```

### ディレクトリ構成のルール

- **第1階層**: `kind`（`server` / `client` / `library` / `database`）
- **第2階層**: `language` または `database_type`
- **第3階層以降**: 生成先のディレクトリ構造をそのまま反映
- **ファイル名**: 生成先ファイル名 + `.tera` 拡張子
- **プレースホルダ**: `{name}` や `{module}` は生成時に `service_name` 等で置換

## 生成後の後処理

CLI がテンプレートからひな形を生成した後、以下の後処理コマンドを自動実行する。後処理はプロジェクトの言語・ツールに応じて選択される。

| 言語/ツール | 後処理コマンド | 目的 |
|---|---|---|
| Go | `go mod tidy` | 依存解決 |
| Rust | `cargo check` | コンパイルチェック |
| TypeScript/React | `npm install` | 依存インストール |
| Dart/Flutter | `flutter pub get` | 依存インストール |
| protobuf | `buf generate` | コード生成（gRPC 時） |
| OpenAPI | `oapi-codegen` / `cargo xtask codegen` | コード生成（REST 時） |
| SQL | マイグレーションツールの初期化 | DB 初期化 |

### 後処理の実行順序

1. テンプレートからファイルを生成
2. 言語固有の依存解決（`go mod tidy` / `cargo check` / `npm install` / `flutter pub get`）
3. コード生成（`buf generate` / `oapi-codegen` 等、該当する場合のみ）
4. SQL マイグレーションの初期化（DB ありの場合のみ）

### 後処理の失敗時

後処理コマンドが失敗した場合、CLI は以下の動作を行う。

- エラー内容を標準エラー出力に表示
- 生成済みファイルはそのまま残す（ロールバックしない）
- 手動での修正を促すメッセージを表示

## テンプレート作成ガイドライン

新しいテンプレートを追加する際は、以下のガイドラインに従うこと。

### 命名規則

- テンプレートファイルの拡張子は `.tera` とする
- ファイル名は生成先のファイル名に `.tera` を付与する（例: `main.go` → `main.go.tera`）
- ディレクトリ構造は生成先の構造を反映する

### 条件付きセクションのベストプラクティス

1. **条件ブロックの前後に空行を入れない**: 不要な空行が生成されるのを防ぐ

    ```tera
    // 良い例
    {% if has_database %}
    import "database/sql"
    {% endif %}

    // 悪い例（余分な空行が生成される）
    {% if has_database %}

    import "database/sql"

    {% endif %}
    ```

2. **ネストは最大2段まで**: 可読性を維持するため、条件分岐のネストは2段までとする

    ```tera
    // 良い例
    {% if has_database %}
    {% if database_type == "postgresql" %}
    import "github.com/lib/pq"
    {% endif %}
    {% endif %}

    // 避けるべき例（3段以上のネスト）
    {% if has_database %}
    {% if database_type == "postgresql" %}
    {% if api_style == "rest" %}
    // ...
    {% endif %}
    {% endif %}
    {% endif %}
    ```

3. **共通部分は条件の外に出す**: 複数の条件で同じコードが出現する場合は、条件の外に配置する

### テンプレートのテスト方法

テンプレートの動作確認は以下の手順で行う。

1. テストコンテキスト（JSON）を作成する

    ```bash
    cat > test-context.json << 'EOF'
    {
      "service_name": "order-api",
      "service_name_snake": "order_api",
      "service_name_pascal": "OrderApi",
      "service_name_camel": "orderApi",
      "tier": "service",
      "domain": "",
      "module_path": "regions/service/order-api/server/go",
      "language": "go",
      "kind": "server",
      "api_style": "rest",
      "has_database": true,
      "database_type": "postgresql",
      "has_kafka": false,
      "has_redis": true,
      "go_module": "github.com/org/k1s0/regions/service/order-api/server/go",
      "docker_registry": "harbor.internal.example.com",
      "docker_project": "k1s0-service"
    }
    EOF
    ```

2. Tera CLI でレンダリングを確認する

    ```bash
    tera --template CLI/templates/server/go/cmd/main.go.tera \
         --context test-context.json
    ```

3. 生成結果が期待通りであることを確認する

    ```bash
    # Go の場合: 構文チェック
    tera --template CLI/templates/server/go/cmd/main.go.tera \
         --context test-context.json \
         --out /tmp/main.go && go vet /tmp/main.go

    # Rust の場合: 構文チェック
    tera --template CLI/templates/server/rust/src/main.rs.tera \
         --context test-context.json \
         --out /tmp/main.rs && rustfmt --check /tmp/main.rs
    ```

4. CI での自動テスト: 全テンプレートに対して複数のコンテキストパターンでレンダリングを実行し、構文エラーがないことを検証する

## 関連ドキュメント

- [CLIフロー](CLIフロー.md) --- CLI の対話フローと操作手順
- [ディレクトリ構成図](ディレクトリ構成図.md) --- 生成先のディレクトリ構成
- [テンプレート仕様-サーバー](テンプレート仕様-サーバー.md) --- サーバーテンプレートの詳細
- [テンプレート仕様-クライアント](テンプレート仕様-クライアント.md) --- クライアントテンプレートの詳細
- [テンプレート仕様-ライブラリ](テンプレート仕様-ライブラリ.md) --- ライブラリテンプレートの詳細
- [テンプレート仕様-データベース](テンプレート仕様-データベース.md) --- データベーステンプレートの詳細
- [テンプレート仕様-コード生成パイプライン](テンプレート仕様-コード生成パイプライン.md) --- 後処理パイプラインの詳細
- [テンプレート仕様-レンダリングテスト](テンプレート仕様-レンダリングテスト.md) --- テンプレートレンダリングテストの仕様
- [テンプレート仕様-Helm](テンプレート仕様-Helm.md) --- Helm Chart テンプレートの詳細
- [テンプレート仕様-CICD](テンプレート仕様-CICD.md) --- CI/CD ワークフローテンプレートの詳細
- [コンセプト](コンセプト.md) --- プロジェクトの目的・技術スタック
