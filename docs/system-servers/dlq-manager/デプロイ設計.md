# system-dlq-manager-server デプロイ設計

system-dlq-manager-server の Dockerfile・テスト・CI/CD パイプライン・設定ファイル・Helm values を定義する。概要・API 定義・アーキテクチャは [system-dlq-manager-server設計.md](server設計.md) を参照。

---

## Dockerfile

[Dockerイメージ戦略.md](../../infrastructure/docker/Dockerイメージ戦略.md) のテンプレートに従う。ビルドコンテキストは `regions/system`（ライブラリ依存解決のため）。

```dockerfile
# Build stage
# Note: build context must be ./regions/system (to include library dependencies)
FROM rust:1.88-bookworm AS builder

# Install protobuf compiler (for tonic-build in build.rs) and
# cmake + build-essential (for rdkafka cmake-build feature)
RUN apt-get update && apt-get install -y --no-install-recommends \
    protobuf-compiler \
    cmake \
    build-essential \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy the entire system directory to resolve path dependencies
COPY . .

RUN cargo build --release -p k1s0-dlq-manager

# Runtime stage
FROM gcr.io/distroless/cc-debian12:nonroot

COPY --from=builder /usr/lib/x86_64-linux-gnu/libz.so.1 /usr/lib/x86_64-linux-gnu/libz.so.1
COPY --from=builder /app/target/release/k1s0-dlq-manager /k1s0-dlq-manager

USER nonroot:nonroot
EXPOSE 8080

ENTRYPOINT ["/k1s0-dlq-manager"]
```

### Dockerfile 構成のポイント

| 項目 | 詳細 |
| --- | --- |
| ビルドステージ | `rust:1.88-bookworm`（マルチステージビルド） |
| ランタイムステージ | `gcr.io/distroless/cc-debian12:nonroot`（最小イメージ） |
| 追加パッケージ | `protobuf-compiler`（proto 生成）、`cmake` + `build-essential`（rdkafka ビルド） |
| libz コピー | distroless には zlib が含まれないため、ビルドステージから手動コピー |
| ビルドコマンド | `cargo build --release -p k1s0-dlq-manager`（ワークスペースから特定パッケージを指定） |
| ビルドコンテキスト | `regions/system`（`COPY . .` でシステム全体のライブラリ依存を含める） |
| 公開ポート | 8080（REST API のみ、gRPC なし） |
| 実行ユーザー | `nonroot:nonroot`（セキュリティベストプラクティス） |

> **注意**: `.dockerignore` で `**/target/` を除外すること（ビルドコンテキストの肥大化防止）。

---

## テスト方針

### レイヤー別テスト

| レイヤー | テスト種別 | ツール |
| --- | --- | --- |
| domain/entity | 単体テスト | `#[cfg(test)]` + `assert!` |
| usecase | 単体テスト（モック） | `mockall` |
| adapter/handler | 統合テスト（HTTP） | `axum::test` + `tokio::test` |
| infrastructure/config | 単体テスト | `#[cfg(test)]` |
| infrastructure/database | 単体テスト | `#[cfg(test)]` |
| infrastructure/kafka | 単体テスト（モック） | `mockall` |
| infrastructure/persistence | 統合テスト（DB） | `testcontainers` |

### ユニットテスト一覧（48 テスト）

| テスト対象 | テスト数 | 内容 |
| --- | --- | --- |
| domain/entity/dlq_message | 13 | ステータス遷移、リトライ判定、Display/from_str、UUID 生成 |
| infrastructure/config | 4 | 設定デシリアライズ、デフォルト値、DB/Kafka 設定 |
| infrastructure/database | 2 | 接続 URL 生成、設定デシリアライズ |
| infrastructure/kafka/mod | 2 | KafkaConfig デシリアライズ、デフォルト値 |
| infrastructure/kafka/producer | 2 | MockDlqEventPublisher 正常/エラー |
| usecase/list_messages | 4 | 空一覧、結果あり、ページネーション、リポジトリエラー |
| usecase/get_message | 2 | 取得成功、未存在 |
| usecase/retry_message | 4 | 正常リトライ、未存在、リトライ不可、上限超過 |
| usecase/delete_message | 2 | 正常削除、エラー |
| usecase/retry_all | 3 | 空トピック、メッセージあり、非リトライ対象スキップ |
| adapter/handler/dlq_handler | 10 | healthz/readyz、一覧、詳細取得（成功/404/400）、削除、リトライ、一括リトライ |

### 統合テスト

`tests/integration_test.rs` に配置。InMemory リポジトリを使用した REST API のエンドツーエンド動作を検証する（12 テストケース）。

| テストケース | 内容 |
| --- | --- |
| `test_healthz_returns_ok` | ヘルスチェック正常 |
| `test_readyz_returns_ok` | レディネスチェック正常 |
| `test_list_messages_empty_topic` | 空トピックの一覧取得 |
| `test_list_messages_returns_stored_message` | メッセージありの一覧取得 |
| `test_get_message_returns_404_when_not_found` | 未存在メッセージ取得時 404 |
| `test_get_message_returns_message` | メッセージ取得成功 |
| `test_get_message_returns_400_for_invalid_id` | 不正 UUID 時 400 |
| `test_retry_message_returns_404_when_not_found` | 未存在メッセージリトライ時 404 |
| `test_retry_message_resolves_pending_message` | PENDING メッセージのリトライ成功 |
| `test_delete_message_returns_ok` | メッセージ削除成功 |
| `test_retry_all_returns_retried_count` | 一括リトライの件数返却 |

---

## CI/CD パイプライン

### CI（`.github/workflows/dlq-manager-ci.yaml`）

PR 時に `regions/system/server/rust/dlq-manager/**` の変更を検出してトリガーする。

```
detect-changes → lint-rust → test-rust → build-rust → security-scan
```

| ジョブ | 内容 |
| --- | --- |
| `detect-changes` | `dorny/paths-filter@v3` でパス変更検出 |
| `lint-rust` | `cargo fmt --check` + `cargo clippy -D warnings` |
| `test-rust` | `cargo test --all` |
| `build-rust` | `cargo build --release` |
| `security-scan` | Trivy ファイルシステムスキャン（HIGH/CRITICAL） |

**Concurrency**: `ci-${{ github.ref }}-dlq-manager`（同一ブランチの古い実行をキャンセル）

### CD（`.github/workflows/dlq-manager-deploy.yaml`）

main ブランチへの push 時に `regions/system/server/rust/dlq-manager/**` の変更を検出してトリガーする。

```
build-and-push → deploy-dev → deploy-staging → deploy-prod（手動承認）
```

| ジョブ | 内容 |
| --- | --- |
| `build-and-push` | Docker Buildx ビルド、Harbor プッシュ、Cosign 署名、Trivy イメージスキャン、SBOM 生成 |
| `deploy-dev` | Cosign 署名検証 → Helm upgrade（dev 環境） |
| `deploy-staging` | Cosign 署名検証 → Helm upgrade（staging 環境） |
| `deploy-prod` | Cosign 署名検証 → Helm upgrade（prod 環境、手動承認必須） |

### イメージタグ戦略

| タグ | 形式 |
| --- | --- |
| バージョン | `{VERSION}`（git describe から取得） |
| バージョン + SHA | `{VERSION}-{SHORT_SHA}` |
| latest | `latest` |

**レジストリ**: `harbor.internal.example.com/k1s0-system/dlq-manager`

---

## 設定ファイル（config.docker.yaml）

Docker 環境用の設定ファイル。`regions/system/server/rust/dlq-manager/config/config.docker.yaml` に配置。

```yaml
app:
  name: "dlq-manager"
  version: "0.1.0"
  environment: "dev"

server:
  host: "0.0.0.0"
  port: 8084          # docker-compose 内部ポート（ホスト: 8086 → コンテナ: 8080）

database:
  host: postgres
  port: 5432
  name: dlq_db
  user: dev
  password: dev
  ssl_mode: disable

kafka:
  brokers:
    - "kafka:9092"
  consumer_group: "dlq-manager.docker"
  dlq_topic_pattern: "*.dlq.v1"
  security_protocol: "PLAINTEXT"
```

### 本番設定（config.yaml）

| 項目 | 値 |
| --- | --- |
| `server.port` | 8080 |
| `database.host` | `postgres.k1s0-system.svc.cluster.local` |
| `database.name` | `k1s0_dlq` |
| `database.ssl_mode` | `disable` |
| `kafka.brokers` | `kafka-0.messaging.svc.cluster.local:9092` |
| `kafka.consumer_group` | `dlq-manager.default` |
| `kafka.security_protocol` | `PLAINTEXT` |

---

## ポートマッピング

| 環境 | ホストポート | コンテナポート | プロトコル |
| --- | --- | --- | --- |
| docker-compose | 8086 | 8080 | REST API |
| Kubernetes | 80（Service） | 8080（Pod） | REST API |

DLQ Manager は REST API のみを提供し、gRPC エンドポイントは持たない。

### エンドポイント

| パス | 用途 |
| --- | --- |
| `/api/v1/dlq/*` | DLQ メッセージ管理 REST API |
| `/healthz` | ヘルスチェック（Liveness Probe） |
| `/readyz` | レディネスチェック（Readiness Probe） |
| `/metrics` | Prometheus メトリクス |

---

## 依存サービス

| サービス | 用途 | 必須 |
| --- | --- | --- |
| PostgreSQL | DLQ メッセージの永続化 | No（未設定時は InMemory リポジトリで動作） |
| Kafka | DLQ トピック購読・元トピックへの再発行 | No（未設定時は REST API のみ動作、再処理時は再発行をスキップ） |

### PostgreSQL

- DB 名: `dlq_db`（docker）/ `k1s0_dlq`（本番）
- 接続設定: `database` セクションで指定
- マイグレーション: DLQ スキーマの `dlq_messages` テーブル

### Kafka

- ブローカー: `kafka:9092`（docker）/ `kafka-0.messaging.svc.cluster.local:9092`（本番）
- コンシューマーグループ: `dlq-manager.docker`（docker）/ `dlq-manager.default`（本番）
- DLQ トピックパターン: `*.dlq.v1`
- セキュリティプロトコル: `PLAINTEXT`

---

## ヘルスチェック

### Kubernetes Probes

```yaml
# Liveness Probe
livenessProbe:
  httpGet:
    path: /healthz
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 15
  failureThreshold: 3

# Readiness Probe
readinessProbe:
  httpGet:
    path: /readyz
    port: 8080
  initialDelaySeconds: 5
  periodSeconds: 5
  failureThreshold: 3
```

### docker-compose 環境

distroless コンテナには curl/sh が含まれないため、`CMD-SHELL` によるヘルスチェックは使用不可。ホスト側から `curl` で確認する。

```bash
# ヘルスチェック
curl -f http://localhost:8086/healthz

# レディネスチェック
curl -f http://localhost:8086/readyz
```

---

## Helm Chart

Helm Chart は `infra/helm/services/system/dlq-manager/` に配置。k1s0-common チャート（v0.1.0）に依存。

### Chart 構成

```
infra/helm/services/system/dlq-manager/
  Chart.yaml
  Chart.lock
  values.yaml           # デフォルト values
  values-dev.yaml       # dev 環境オーバーライド
  values-staging.yaml   # staging 環境オーバーライド
  values-prod.yaml      # prod 環境オーバーライド
  charts/
    k1s0-common-0.1.0.tgz
  templates/
    _helpers.tpl
    configmap.yaml
    deployment.yaml
    hpa.yaml
    pdb.yaml
    service.yaml
    serviceaccount.yaml
```

### Helm values（デフォルト）

```yaml
image:
  registry: harbor.internal.example.com
  repository: k1s0-system/dlq-manager
  tag: ""
  pullPolicy: IfNotPresent

replicaCount: 2

container:
  port: 8080
  grpcPort: null        # REST API のみ

service:
  type: ClusterIP
  port: 80
  grpcPort: null

resources:
  requests:
    cpu: 250m
    memory: 256Mi
  limits:
    cpu: 1000m
    memory: 1Gi

autoscaling:
  enabled: true
  minReplicas: 2
  maxReplicas: 5
  targetCPUUtilizationPercentage: 70
  targetMemoryUtilizationPercentage: 80

pdb:
  enabled: true
  minAvailable: 1

vault:
  enabled: true
  role: "system"
  secrets:
    - path: "secret/data/k1s0/system/dlq-manager/database"
      key: "password"
      mountPath: "/vault/secrets/db-password"

kafka:
  enabled: true
  brokers: []

labels:
  tier: system
```

### dev 環境オーバーライド

```yaml
replicaCount: 1

resources:
  requests:
    cpu: 100m
    memory: 128Mi
  limits:
    cpu: 500m
    memory: 512Mi

autoscaling:
  enabled: false

pdb:
  enabled: false

vault:
  enabled: false
```

### Vault シークレットパス

| シークレット | パス |
| --- | --- |
| DB パスワード | `secret/data/k1s0/system/dlq-manager/database` |
| Kafka SASL | `secret/data/k1s0/system/kafka/sasl` |

### セキュリティ設定

```yaml
podSecurityContext:
  runAsNonRoot: true
  runAsUser: 65532
  fsGroup: 65532

containerSecurityContext:
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  capabilities:
    drop: ["ALL"]
```

---

## Kong ルーティング

[認証認可設計.md](../../auth/design/認証認可設計.md) の Kong ルーティング設計に従い、DLQ Manager を Kong に登録する。

```yaml
services:
  - name: dlq-manager-v1
    url: http://dlq-manager.k1s0-system.svc.cluster.local:80
    routes:
      - name: dlq-manager-v1-route
        paths:
          - /api/v1/dlq
        strip_path: false
    plugins:
      - name: rate-limiting
        config:
          minute: 3000
          policy: redis
```

---

## 関連ドキュメント

- [system-dlq-manager-server設計.md](server設計.md) -- 概要・API 定義・アーキテクチャ
- [system-dlq-manager-server-実装設計.md](実装設計.md) -- Rust 実装詳細
- [system-library-dlq-client設計.md](../../system-libraries/messaging/dlq-client設計.md) -- DLQ クライアントライブラリ設計
- [Dockerイメージ戦略.md](../../infrastructure/docker/Dockerイメージ戦略.md) -- マルチステージビルド・ベースイメージ
- [helm設計.md](../../infrastructure/kubernetes/helm設計.md) -- Helm Chart・Vault Agent Injector
- [可観測性設計.md](../../observability/overview/可観測性設計.md) -- OpenTelemetry・Prometheus・構造化ログ
- [認証認可設計.md](../../auth/design/認証認可設計.md) -- Kong ルーティング設計
- [メッセージング設計.md](../../architecture/messaging/メッセージング設計.md) -- DLQ パターンの基本方針
