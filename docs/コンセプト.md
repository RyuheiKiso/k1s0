# コンセプト

k1s0（キソ）は、CLIツール一つでプロジェクトの構築から運用までを完結させるための開発基盤です。

## ターゲット

企業のシステム開発部門を対象とします。

## ミッション

| 目標                       | 概要                                                             |
| -------------------------- | ---------------------------------------------------------------- |
| 開発工数の削減             | ひな形生成と自動化により、初期構築・運用の手間を最小化する       |
| 新技術の採用ハードルの低下 | ベストプラクティスを組み込んだテンプレートで、学習コストを抑える |
| システムの柔軟性の向上     | マイクロサービス構成を前提とし、サービスの追加・変更を容易にする |
| 可観測性の向上             | トレース・メトリクス・ログを初期構成に含め、運用品質を底上げする |

## バリュー

- **ワンストップ** — ひな形生成・ビルド・テスト・デプロイをCLI一つで完結
- **ベストプラクティスの内蔵** — クリーンアーキテクチャ・DDD・TDDに沿ったコードを最初から生成
- **可観測性のゼロコンフィグ** — OpenTelemetry・ログ・メトリクスを初期構成に組み込み済み
- **技術選定の簡素化** — 用途に応じた通信方式（REST / gRPC / GraphQL）やインフラ構成を対話的に選択

## 技術スタック

### 設計思想

| 設計思想                       | 適用範囲                           |
| ------------------------------ | ---------------------------------- |
| クリーンアーキテクチャ         | レイヤー分離とテスタビリティの確保 |
| ドメイン駆動設計（DDD）        | ドメインモデルを中心とした設計     |
| テスト駆動開発（TDD）          | テストファーストによる品質担保     |
| マイクロサービスアーキテクチャ | サービス単位の独立デプロイ         |
| イベント駆動アーキテクチャ     | サービス間の疎結合な連携           |

### 設計パターン

| パターン           | 用途                             |
| ------------------ | -------------------------------- |
| CQRS               | コマンドとクエリの責務分離       |
| イベントソーシング | 状態変更をイベントとして永続化   |
| Saga パターン      | 分散トランザクションの整合性制御 |

#### 適用基準

これらのパターンは全サービスに一律適用するのではなく、要件に応じて段階的に導入する。まずシンプルな同期 REST / gRPC で実装し、パフォーマンスや整合性の課題が顕在化した段階で該当パターンの導入を検討する。

| パターン           | 適用条件                                                                                       | 適用例                                 |
| ------------------ | ---------------------------------------------------------------------------------------------- | -------------------------------------- |
| CQRS               | 読み取りと書き込みの負荷特性が大きく異なるサービス。初期フェーズでは不要、パフォーマンス課題が顕在化した段階で導入検討 | レポート集約、ダッシュボード表示       |
| イベントソーシング | 変更履歴の完全な追跡が必要なドメイン。全サービスに一律適用はしない                               | 監査ログ、承認ワークフロー             |
| Saga パターン      | 複数サービスにまたがるトランザクション管理が必要な場合。4 ステップ以下はコレオグラフィ方式、5 ステップ以上はオーケストレーション方式を検討 | クロスサービスの注文・決済・在庫連携   |

### API / 通信

> 詳細: [API設計.md](API設計.md)、[コーディング規約.md](コーディング規約.md)

| 技術     | 用途                                     |
| -------- | ---------------------------------------- |
| REST API | 汎用的なHTTP通信                         |
| gRPC     | サービス間の高速な内部通信               |
| GraphQL  | クライアント主導の柔軟なデータ取得       |
| OpenAPI  | REST APIのスキーマ定義・コードからの自動生成 |
| protobuf | gRPC用のインターフェース定義・シリアライズ   |

### セキュリティ

> 詳細: [認証認可設計.md](認証認可設計.md)

| 技術             | 用途                           |
| ---------------- | ------------------------------ |
| OAuth 2.0 / OIDC | 認証・ID連携                   |
| JWT              | トークンベースの認可           |
| HashiCorp Vault  | シークレットの一元管理・配布   |

### インフラ / CI・CD

> 詳細: [インフラ設計.md](インフラ設計.md)、[kubernetes設計.md](kubernetes設計.md)、[terraform設計.md](terraform設計.md)、[CI-CD設計.md](CI-CD設計.md)

| 技術       | 用途                             |
| ---------- | -------------------------------- |
| Docker     | コンテナによる実行環境の統一     |
| Kubernetes | コンテナオーケストレーション     |
| Helm       | Kubernetesマニフェストのテンプレート管理 |
| Terraform  | インフラのコード管理（IaC）      |
| CI/CD      | ビルド・テスト・デプロイの自動化 |

### サービスメッシュ

> 詳細: [サービスメッシュ設計.md](サービスメッシュ設計.md)

| 技術           | 用途                                     |
| -------------- | ---------------------------------------- |
| Istio / Envoy  | トラフィック制御・mTLS・サービス間通信管理 |

### 可観測性

> 詳細: [可観測性設計.md](可観測性設計.md)

| 技術          | 用途                         |
| ------------- | ---------------------------- |
| OpenTelemetry | テレメトリデータの収集・送信 |
| Jaeger        | 分散トレーシング             |
| Prometheus    | メトリクス収集               |
| Grafana       | ダッシュボード・可視化       |
| Loki          | ログ集約                     |

### メッセージング

> 詳細: [メッセージング設計.md](メッセージング設計.md)

| 技術  | 用途                             |
| ----- | -------------------------------- |
| Kafka | サービス間の非同期メッセージング |

### データストア

| 技術       | 用途                               |
| ---------- | ---------------------------------- |
| PostgreSQL | メインのリレーショナルデータベース |
| MySQL      | リレーショナルデータベース         |
| SQLite     | 軽量な組み込みデータベース         |
| Redis      | キャッシュ・セッション管理         |

### ORM / クエリビルダー

| 言語 | ライブラリ | 用途                                                                 |
| ---- | ---------- | -------------------------------------------------------------------- |
| Go   | sqlx       | SQL ファーストのクエリビルダー。クリーンアーキテクチャとの親和性が高い |
| Rust | sqlx       | async 対応・コンパイル時クエリ検証による型安全なデータアクセス       |

sqlx を両言語で統一することで、学習コストの低減と SQL スキルの共有を図る。ORM の暗黙的な振る舞いを避け、ドメイン層とインフラ層の明確な分離を維持する。

### データベースマイグレーション

| 言語 | ツール         | 用途                                            |
| ---- | -------------- | ----------------------------------------------- |
| Go   | golang-migrate | SQL ベースの up / down 双方向マイグレーション管理 |
| Rust | sqlx-cli       | sqlx に統合されたマイグレーション管理            |

マイグレーションファイルは `{連番}_{説明}.up.sql` / `{連番}_{説明}.down.sql` の形式で管理する（[ディレクトリ構成図](ディレクトリ構成図.md) 参照）。

### API ゲートウェイ

> 詳細: [APIゲートウェイ設計.md](APIゲートウェイ設計.md)

| 技術 | 用途                                 |
| ---- | ------------------------------------ |
| Kong | APIゲートウェイ・トラフィック制御    |

### 耐障害性

| パターン                   | 用途                     |
| -------------------------- | ------------------------ |
| Circuit Breaker            | 障害の連鎖防止           |
| Retry + Exponential Backoff | 一時的障害への自動復旧   |
| Rate Limiting              | 過負荷防止               |

### 開発者体験

| 技術          | 用途                       |
| ------------- | -------------------------- |
| Dev Container | 開発環境の統一・即時構築   |

### クライアント（React）

> 詳細設計は別途 `docs/クライアント設計.md`（未作成）で定義予定

| 技術            | 用途                                           |
| --------------- | ---------------------------------------------- |
| TanStack Query  | サーバー状態管理（API データのフェッチ・キャッシュ） |
| Zustand         | クライアント状態管理（UI 状態）                |
| TanStack Router | 型安全なファイルベースルーティング             |
| React Hook Form | フォーム状態管理                               |
| Zod             | スキーマバリデーション                         |
| Tailwind CSS    | ユーティリティファースト CSS                   |
| Radix UI        | アクセシブルなヘッドレス UI コンポーネント     |

### クライアント（Flutter）

> 詳細設計は別途 `docs/クライアント設計.md`（未作成）で定義予定

| 技術     | 用途                                     |
| -------- | ---------------------------------------- |
| Riverpod | 状態管理（型安全・テスタビリティ重視）   |
| go_router | 宣言的ルーティング                      |
| freezed  | イミュータブルモデルの自動生成           |
| dio      | HTTP クライアント                        |

### テスト

| 言語 / FW  | ツール          | 用途                         |
| ---------- | --------------- | ---------------------------- |
| Go         | testify         | アサーション・テストスイート |
| Go         | gomock          | モック自動生成               |
| Rust       | mockall         | モック自動生成               |
| TypeScript | Vitest          | テストランナー               |
| TypeScript | Testing Library | コンポーネントテスト         |
| TypeScript | MSW             | API モック（Service Worker） |
| Dart       | mocktail        | モック生成                   |
| Python     | pytest          | E2E テスト                   |

### コード・ドキュメント自動生成

| 技術                     | 用途                                 |
| ------------------------ | ------------------------------------ |
| OpenAPI → SDK生成        | REST APIクライアントコードの自動生成 |
| protobuf → ドキュメント生成 | gRPC APIのドキュメント自動生成       |

## 設計上の制約

- アプリケーション内での環境変数の直接参照を禁止し、YAMLファイルで一元管理する
