# 開発ルール

このドキュメントは、k1s0 の開発における「品質を落とさずに変更を積み重ねる」ための共通ルールを定めます。
迷ったときは、このドキュメントのチェックリストに立ち戻って判断してください。

## 前提

- 開発手法: TDD（テスト駆動開発）
- 設計指針: クリーンアーキテクチャ + DDD（ドメイン駆動設計）

## 必須の品質ゲート

変更を提出（PR作成/レビュー依頼）する前に、少なくとも以下を満たします。

- テストが全て成功している（失敗を放置しない）
- フォーマットが統一されている（差分がフォーマットだけにならない）
- 静的解析で新しい警告/エラーを増やしていない

Rust プロジェクトでは、基本的に以下を目安にします。

- `cargo test`
- `cargo fmt`
- `cargo clippy`

## 開発フロー（TDD）

基本は Red → Green → Refactor のサイクルで進めます。

1. **Red**: まずテストを書く（この時点で失敗することを確認する）
2. **Green**: テストを通す最小の実装を行う
3. **Refactor**: 仕様を変えずに内部構造を改善する（重複排除・命名改善・責務分離）

運用上のルール:

- 実装を始める前に「何を満たしたら完了か」をテスト名/テストケースで明確化する
- リファクタは小刻みに行い、途中でテストが落ちた状態を長時間放置しない

## アーキテクチャ（クリーンアーキテクチャ）

狙いは、変更に強い境界（責務と依存方向）を作り、ビジネスルールを安定させることです。

- 依存方向は「外側 → 内側」だけにする（ドメインを外部要因に引っ張られない）
- UI/CLI、永続化、外部API等の詳細は境界の外に追い出す
- ビジネスルールはテストしやすい形（純粋な入力→出力、状態変更が明確）を優先する

判断基準:

- ドメイン層の型が I/O やフレームワーク、具体的なDB実装の知識を持っていないか
- ユースケース（アプリケーション層）の責務が「手順のオーケストレーション」に留まっているか

## ドメイン駆動設計（DDD）

DDD の狙いは、ビジネス概念をコードに正確に写し取り、チームの共通理解をコードで保つことです。

- ドメインモデル（Entity / Value Object）を明確にし、制約はできるだけモデルに閉じ込める
- ユビキタス言語を維持する（命名で妥協しない）
- 重要な不変条件（invariant）は、型/コンストラクタ/メソッドの境界で守る

## コーディング規約

### 命名

- ユビキタス言語を優先し、技術都合の略語や曖昧な名前を避ける
- 役割が伝わる名前にする（`manager` / `util` のような万能語を避ける）

### コメント

- コメントは「なぜ（Why）/判断（Decision）/前提（Assumption）」に絞る
- コードを読めば分かることは書かない

### 設計

- 関数/メソッドは単一責任にする（入力・出力・副作用が説明できる粒度）
- 重複は放置しない（ただし過度な共通化で可読性を落とさない）
- スコープを最小化し、グローバル/共有状態を増やさない

### エラーハンドリング

- 予期される失敗は `Result` 等で表現し、呼び出し側に伝播できる形にする
- `panic` は「回復不能なプログラマのバグ」に限定する（入力不備等に使わない）
- エラーの粒度は、呼び出し側が適切に扱える程度に保つ（潰しすぎない）

### セキュリティ

- 外部入力（CLI入力、ファイル、環境変数など）は常に不正を想定して検証する
- ログ/エラー出力に機密情報を含めない

## テスト方針

- テストは仕様の例（サンプル）として読めるようにする
- 失敗時に原因が分かるよう、期待値と前提を明確にする
- 1テストは 1つの振る舞いに集中させる

## レビュー指針（チェックリスト）

レビュー依頼前にセルフチェックしてください。

- 変更の目的がPR説明/コミットメッセージで説明できる
- テストが追加/更新され、意図した失敗→成功が確認できる
- 境界（ドメイン/ユースケース/インフラ等）の依存方向が崩れていない
- 命名がユビキタス言語に沿っている
- 不要なコード、未使用の依存、デッドコードが残っていない

## ドキュメント運用

- 仕様や判断がコードだけでは伝わりにくい場合は、最小限の追記を行う
- ドキュメントと実装がズレたまま放置しない（ズレに気付いた人が直す）

