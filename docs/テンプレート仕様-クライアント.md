# テンプレート仕様 — クライアント

k1s0 プロジェクトにおけるクライアントテンプレートの仕様を定義する。React（SPA）と Flutter（Web / Mobile）の両フレームワークを対象とし、CLI の `ひな形生成` で展開されるスケルトンコードの全容を記載する。

## 1. 概要

### 目的

k1s0 CLI の `ひな形生成 → client` で使用するテンプレートファイル群を定義する。テンプレートエンジン **Tera** の構文でパラメータ化されており、CLI の対話フローで収集した情報をもとに実用的なプロジェクトスケルトンを生成する。

### 対象フレームワーク

| フレームワーク | 言語       | 用途               | テンプレートパス                  |
| -------------- | ---------- | ------------------ | --------------------------------- |
| React          | TypeScript | SPA（ブラウザ）    | `CLI/templates/client/react/`     |
| Flutter        | Dart       | Web / Mobile       | `CLI/templates/client/flutter/`   |

### 配置制約

- **system 層には client を配置しない** — system は基盤提供が目的であり、ユーザー向け画面を持たない（[ディレクトリ構成図](ディレクトリ構成図.md) 参照）
- client は **business** および **service** Tier のみに配置する

### 認証方式

クライアントは BFF（Backend for Frontend）経由の **HttpOnly Cookie** 方式で認証を行う（[認証認可設計](認証認可設計.md) D-013 参照）。テンプレートの API クライアント設定は `withCredentials: true`（React）またはそれに相当する設定（Flutter）を前提とする。

---

## 2. Tier 別配置パス

### business Tier

```
regions/business/{domain}/client/{framework}/{service_name}/
```

例:

| domain       | framework | service_name       | 配置パス                                                   |
| ------------ | --------- | ------------------ | ---------------------------------------------------------- |
| `accounting` | `react`   | `ledger-app`       | `regions/business/accounting/client/react/ledger-app/`     |
| `fa`         | `flutter`  | `asset-manager`   | `regions/business/fa/client/flutter/asset-manager/`        |

### service Tier

```
regions/service/{service_name}/client/{framework}/
```

例:

| service_name | framework | 配置パス                                      |
| ------------ | --------- | --------------------------------------------- |
| `order`      | `react`   | `regions/service/order/client/react/`          |
| `inventory`  | `flutter`  | `regions/service/inventory/client/flutter/`   |

---

## 3. React テンプレート

テンプレートファイルは `CLI/templates/client/react/` に配置する。以下に各ファイルの完全なスケルトンコードを示す。

### 3.1 package.json

`CLI/templates/client/react/package.json.tera`

```json
{
  "name": "{{ service_name }}",
  "version": "0.1.0",
  "private": true,
  "type": "module",
  "scripts": {
    "dev": "vite",
    "build": "tsc -b && vite build",
    "preview": "vite preview",
    "test": "vitest run",
    "test:watch": "vitest",
    "test:coverage": "vitest run --coverage",
    "lint": "eslint .",
    "lint:fix": "eslint . --fix",
    "format": "prettier --write 'src/**/*.{ts,tsx,json,css}'",
    "format:check": "prettier --check 'src/**/*.{ts,tsx,json,css}'"
  },
  "dependencies": {
    "react": "^19.0.0",
    "react-dom": "^19.0.0",
    "@tanstack/react-query": "^5.62.0",
    "@tanstack/react-router": "^1.92.0",
    "zustand": "^5.0.0",
    "react-hook-form": "^7.54.0",
    "@hookform/resolvers": "^3.9.0",
    "zod": "^3.24.0",
    "axios": "^1.7.0",
    "@radix-ui/react-dialog": "^1.1.0",
    "@radix-ui/react-dropdown-menu": "^2.1.0",
    "@radix-ui/react-label": "^2.1.0",
    "@radix-ui/react-slot": "^1.1.0",
    "@radix-ui/react-toast": "^1.2.0"
  },
  "devDependencies": {
    "typescript": "^5.7.0",
    "vite": "^6.0.0",
    "@vitejs/plugin-react": "^4.3.0",
    "tailwindcss": "^4.0.0",
    "@tailwindcss/vite": "^4.0.0",
    "vitest": "^2.1.0",
    "@testing-library/react": "^16.1.0",
    "@testing-library/jest-dom": "^6.6.0",
    "msw": "^2.7.0",
    "eslint": "^9.16.0",
    "@eslint/js": "^9.16.0",
    "typescript-eslint": "^8.18.0",
    "eslint-plugin-react": "^7.37.0",
    "eslint-plugin-react-hooks": "^5.1.0",
    "eslint-plugin-import": "^2.31.0",
    "prettier": "^3.4.0",
    "@types/react": "^19.0.0",
    "@types/react-dom": "^19.0.0"
  }
}
```

### 3.2 tsconfig.json

`CLI/templates/client/react/tsconfig.json.tera`

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "lib": ["ES2023", "DOM", "DOM.Iterable"],
    "module": "ESNext",
    "moduleResolution": "bundler",
    "jsx": "react-jsx",
    "strict": true,
    "noUnusedLocals": true,
    "noUnusedParameters": true,
    "noFallthroughCasesInSwitch": true,
    "forceConsistentCasingInFileNames": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "outDir": "./dist",
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"]
    }
  },
  "include": ["src"],
  "references": [{ "path": "./tsconfig.node.json" }]
}
```

### 3.3 vite.config.ts

`CLI/templates/client/react/vite.config.ts.tera`

```typescript
import { defineConfig } from 'vite';
import react from '@vitejs/plugin-react';
import tailwindcss from '@tailwindcss/vite';
import path from 'path';

export default defineConfig({
  plugins: [react(), tailwindcss()],
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  server: {
    port: 3000,
    proxy: {
      '/api': {
        target: 'http://localhost:8080',
        changeOrigin: true,
      },
    },
  },
  build: {
    outDir: 'dist',
    sourcemap: false,
  },
});
```

### 3.4 eslint.config.mjs

`CLI/templates/client/react/eslint.config.mjs.tera`

```javascript
import eslint from '@eslint/js';
import tseslint from 'typescript-eslint';
import react from 'eslint-plugin-react';
import reactHooks from 'eslint-plugin-react-hooks';
import importPlugin from 'eslint-plugin-import';

export default tseslint.config(
  eslint.configs.recommended,
  ...tseslint.configs.strictTypeChecked,
  {
    languageOptions: {
      parserOptions: {
        projectService: true,
        tsconfigRootDir: import.meta.dirname,
      },
    },
    plugins: { react, 'react-hooks': reactHooks, import: importPlugin },
    rules: {
      'react-hooks/rules-of-hooks': 'error',
      'react-hooks/exhaustive-deps': 'warn',
      'import/order': [
        'error',
        {
          groups: ['builtin', 'external', 'internal', 'parent', 'sibling'],
          'newlines-between': 'always',
          alphabetize: { order: 'asc' },
        },
      ],
      '@typescript-eslint/no-unused-vars': ['error', { argsIgnorePattern: '^_' }],
      '@typescript-eslint/explicit-function-return-type': 'off',
      '@typescript-eslint/no-floating-promises': 'error',
    },
  },
  {
    files: ['tests/**/*.{ts,tsx}'],
    languageOptions: {
      globals: {
        describe: 'readonly',
        it: 'readonly',
        expect: 'readonly',
        vi: 'readonly',
        beforeEach: 'readonly',
        afterEach: 'readonly',
        beforeAll: 'readonly',
        afterAll: 'readonly',
      },
    },
  },
);
```

### 3.5 .prettierrc

`CLI/templates/client/react/.prettierrc.tera`

```json
{
  "semi": true,
  "singleQuote": true,
  "trailingComma": "all",
  "printWidth": 100,
  "tabWidth": 2
}
```

### 3.6 vitest.config.ts

`CLI/templates/client/react/vitest.config.ts.tera`

```typescript
import { defineConfig } from 'vitest/config';
import path from 'path';

export default defineConfig({
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./tests/testutil/setup.ts'],
    include: ['tests/**/*.test.{ts,tsx}'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'lcov'],
      include: ['src/**/*.{ts,tsx}'],
      exclude: ['src/**/*.d.ts', 'src/main.tsx'],
    },
  },
});
```

### 3.7 src/app/App.tsx

`CLI/templates/client/react/src/app/App.tsx.tera`

```typescript
import { QueryClientProvider } from '@tanstack/react-query';
import { RouterProvider, createRouter } from '@tanstack/react-router';

import { queryClient } from '@/lib/query-client';
import { routeTree } from '@/app/route-tree.gen';

const router = createRouter({ routeTree });

declare module '@tanstack/react-router' {
  interface Register {
    router: typeof router;
  }
}

export function App() {
  return (
    <QueryClientProvider client={queryClient}>
      <RouterProvider router={router} />
    </QueryClientProvider>
  );
}
```

### 3.8 src/lib/api-client.ts

`CLI/templates/client/react/src/lib/api-client.ts.tera`

BFF + HttpOnly Cookie 認証に対応した axios インスタンス。トークンは BFF がサーバーサイドで管理するため、クライアントから直接扱わない（[認証認可設計](認証認可設計.md) D-013 参照）。

```typescript
import axios from 'axios';

/**
 * API クライアント
 *
 * - baseURL: BFF のプロキシエンドポイント
 * - withCredentials: Cookie を自動送信（BFF + HttpOnly Cookie 方式）
 * - CSRF トークン: BFF が発行する X-CSRF-Token をリクエストヘッダーに付与
 */
const apiClient = axios.create({
  baseURL: '/api',
  withCredentials: true,
  headers: {
    'Content-Type': 'application/json',
  },
});

// CSRF トークンをリクエストヘッダーに付与
apiClient.interceptors.request.use((config) => {
  const csrfToken = document.querySelector<HTMLMetaElement>(
    'meta[name="csrf-token"]',
  )?.content;
  if (csrfToken) {
    config.headers['X-CSRF-Token'] = csrfToken;
  }
  return config;
});

// レスポンスインターセプター: エラーハンドリング
apiClient.interceptors.response.use(
  (response) => response,
  (error) => {
    if (axios.isAxiosError(error)) {
      switch (error.response?.status) {
        case 401:
          // 認証エラー: ログインページへリダイレクト
          window.location.href = '/auth/login';
          break;
        case 403:
          // 権限エラー: アクセス拒否
          console.error('アクセスが拒否されました');
          break;
        case 500:
          // サーバーエラー
          console.error('サーバーエラーが発生しました');
          break;
      }
    }
    return Promise.reject(error);
  },
);

export { apiClient };
```

### 3.9 src/lib/query-client.ts

`CLI/templates/client/react/src/lib/query-client.ts.tera`

```typescript
import { QueryClient } from '@tanstack/react-query';

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      staleTime: 1000 * 60 * 5,       // 5 分間はキャッシュを新鮮とみなす
      gcTime: 1000 * 60 * 30,          // 30 分間キャッシュを保持
      retry: 1,                         // リトライ 1 回
      refetchOnWindowFocus: false,      // ウィンドウフォーカス時の再取得を無効化
    },
    mutations: {
      retry: 0,                         // ミューテーションはリトライしない
    },
  },
});
```

### 3.10 tests/testutil/msw-setup.ts

`CLI/templates/client/react/tests/testutil/msw-setup.ts.tera`

```typescript
import '@testing-library/jest-dom/vitest';
import { setupServer } from 'msw/node';
import { http, HttpResponse } from 'msw';

/**
 * MSW ハンドラー定義
 *
 * テスト用の API モックハンドラーを定義する。
 * 各テストファイルで server.use() を使い、テスト固有のハンドラーを追加・上書きできる。
 */
const handlers = [
  // ヘルスチェック
  http.get('/api/health', () => {
    return HttpResponse.json({ status: 'ok' });
  }),

  // TODO: {{ service_name }} 固有のハンドラーを追加
];

export const server = setupServer(...handlers);

// テストライフサイクル
beforeAll(() => server.listen({ onUnhandledRequest: 'warn' }));
afterEach(() => server.resetHandlers());
afterAll(() => server.close());
```

### 3.11 Dockerfile

`CLI/templates/client/react/Dockerfile.tera`

```dockerfile
# ---- Build ----
FROM node:22-bookworm AS build
WORKDIR /src

COPY package.json package-lock.json ./
RUN npm ci

COPY . .
RUN npm run build

# ---- Runtime ----
FROM nginx:1.27-alpine
COPY --from=build /src/dist /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

# nginx のデフォルトユーザーは root のため、非 root 実行に切り替える。
# helm設計.md の securityContext（runAsUser: 65532）を使用する場合は
# Dockerfile 側で該当 UID のユーザーを作成し、nginx が listen する
# ポートを 1024 以上に変更する必要がある。
# 簡易的な非 root 化として USER nginx を使用する場合は、
# helm 側の runAsUser を nginx ユーザーの UID（101）に合わせること。
USER nginx
EXPOSE 8080
```

### 3.12 nginx.conf

`CLI/templates/client/react/nginx.conf.tera`

```nginx
server {
    listen 8080;
    server_name _;

    root /usr/share/nginx/html;
    index index.html;

    # gzip 圧縮
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_min_length 256;
    gzip_types
        text/plain
        text/css
        text/javascript
        application/javascript
        application/json
        application/xml
        image/svg+xml;

    # SPA ルーティング: 存在しないパスは index.html にフォールバック
    location / {
        try_files $uri $uri/ /index.html;
    }

    # 静的アセットのキャッシュ制御
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # index.html はキャッシュしない（常に最新版を配信）
    location = /index.html {
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # セキュリティヘッダー
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
}
```

---

## 4. Flutter テンプレート

テンプレートファイルは `CLI/templates/client/flutter/` に配置する。以下に各ファイルの完全なスケルトンコードを示す。

### 4.1 pubspec.yaml

`CLI/templates/client/flutter/pubspec.yaml.tera`

```yaml
name: {{ service_name_snake }}
description: {{ service_name }} client application
version: 0.1.0
publish_to: none

environment:
  sdk: ">=3.5.0 <4.0.0"
  flutter: ">=3.24.0"

dependencies:
  flutter:
    sdk: flutter
  flutter_riverpod: ^2.6.0
  go_router: ^14.6.0
  freezed_annotation: ^2.4.0
  json_annotation: ^4.9.0
  dio: ^5.7.0

dev_dependencies:
  flutter_test:
    sdk: flutter
  build_runner: ^2.4.0
  freezed: ^2.5.0
  json_serializable: ^6.8.0
  mocktail: ^1.0.0
  flutter_lints: ^5.0.0
```

### 4.2 analysis_options.yaml

`CLI/templates/client/flutter/analysis_options.yaml.tera`

```yaml
include: package:flutter_lints/flutter.yaml

linter:
  rules:
    - prefer_const_constructors
    - prefer_const_declarations
    - avoid_print
    - prefer_single_quotes
    - always_declare_return_types
    - annotate_overrides
    - avoid_empty_else
    - prefer_final_fields
    - sort_constructors_first
    - unawaited_futures
    - unnecessary_brace_in_string_interps

analyzer:
  errors:
    missing_return: error
    dead_code: warning
  exclude:
    - "**/*.g.dart"
    - "**/*.freezed.dart"
```

### 4.3 lib/main.dart

`CLI/templates/client/flutter/lib/main.dart.tera`

```dart
import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';

import 'package:{{ service_name_snake }}/app/router.dart';

void main() {
  runApp(
    const ProviderScope(
      child: MyApp(),
    ),
  );
}

class MyApp extends StatelessWidget {
  const MyApp({super.key});

  @override
  Widget build(BuildContext context) {
    return MaterialApp.router(
      title: '{{ service_name_pascal }}',
      theme: ThemeData(
        colorSchemeSeed: Colors.blue,
        useMaterial3: true,
      ),
      darkTheme: ThemeData(
        colorSchemeSeed: Colors.blue,
        useMaterial3: true,
        brightness: Brightness.dark,
      ),
      themeMode: ThemeMode.system,
      routerConfig: appRouter,
      debugShowCheckedModeBanner: false,
    );
  }
}
```

### 4.4 lib/app/router.dart

`CLI/templates/client/flutter/lib/app/router.dart.tera`

```dart
import 'package:flutter/material.dart';
import 'package:go_router/go_router.dart';

/// アプリケーションルーター
///
/// go_router を使用してルーティングを定義する。
/// 新しい画面を追加する際は routes にルートを追加すること。
final GoRouter appRouter = GoRouter(
  initialLocation: '/',
  debugLogDiagnostics: true,
  routes: <RouteBase>[
    GoRoute(
      path: '/',
      name: 'home',
      builder: (BuildContext context, GoRouterState state) {
        return const HomeScreen();
      },
    ),
    // TODO: {{ service_name }} 固有のルートを追加
  ],
  errorBuilder: (BuildContext context, GoRouterState state) {
    return const NotFoundScreen();
  },
);

/// ホーム画面（スケルトン）
class HomeScreen extends StatelessWidget {
  const HomeScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('{{ service_name_pascal }}'),
      ),
      body: const Center(
        child: Text('Welcome to {{ service_name_pascal }}'),
      ),
    );
  }
}

/// 404 画面
class NotFoundScreen extends StatelessWidget {
  const NotFoundScreen({super.key});

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      appBar: AppBar(
        title: const Text('Not Found'),
      ),
      body: Center(
        child: Column(
          mainAxisAlignment: MainAxisAlignment.center,
          children: [
            const Text('ページが見つかりません'),
            const SizedBox(height: 16),
            ElevatedButton(
              onPressed: () => context.go('/'),
              child: const Text('ホームに戻る'),
            ),
          ],
        ),
      ),
    );
  }
}
```

### 4.5 lib/utils/dio_client.dart

`CLI/templates/client/flutter/lib/utils/dio_client.dart.tera`

```dart
import 'package:dio/dio.dart';
import 'package:flutter/foundation.dart';

/// API クライアント
///
/// Dio を使用した HTTP クライアント。
/// BFF 経由でバックエンドと通信する。
/// Cookie ベースの認証に対応（Web の場合は withCredentials で自動送信）。
class DioClient {
  DioClient._();

  static final Dio _dio = _createDio();

  static Dio get instance => _dio;

  static Dio _createDio() {
    final dio = Dio(
      BaseOptions(
        baseUrl: const String.fromEnvironment(
          'API_BASE_URL',
          defaultValue: 'http://localhost:8080/api',
        ),
        connectTimeout: const Duration(seconds: 10),
        receiveTimeout: const Duration(seconds: 30),
        sendTimeout: const Duration(seconds: 30),
        headers: {
          'Content-Type': 'application/json',
          'Accept': 'application/json',
        },
        // Web 環境では Cookie を自動送信（BFF + HttpOnly Cookie 方式）
        extra: {
          'withCredentials': true,
        },
      ),
    );

    // ログインターセプター（デバッグモードのみ）
    if (kDebugMode) {
      dio.interceptors.add(
        LogInterceptor(
          requestBody: true,
          responseBody: true,
          logPrint: (obj) => debugPrint(obj.toString()),
        ),
      );
    }

    // エラーハンドリングインターセプター
    dio.interceptors.add(
      InterceptorsWrapper(
        onError: (DioException error, ErrorInterceptorHandler handler) {
          switch (error.response?.statusCode) {
            case 401:
              // 認証エラー: 再ログインが必要
              debugPrint('認証エラー: 再ログインが必要です');
              break;
            case 403:
              // 権限エラー: アクセス拒否
              debugPrint('アクセスが拒否されました');
              break;
            case 500:
              // サーバーエラー
              debugPrint('サーバーエラーが発生しました');
              break;
          }
          handler.next(error);
        },
      ),
    );

    return dio;
  }
}
```

### 4.6 Dockerfile

`CLI/templates/client/flutter/Dockerfile.tera`

```dockerfile
# ---- Build Stage ----
FROM ghcr.io/cirruslabs/flutter:3.24.0 AS build
WORKDIR /app

COPY pubspec.* ./
RUN flutter pub get

COPY . .
RUN flutter build web --release

# ---- Runtime Stage ----
FROM nginx:1.27-alpine
COPY --from=build /app/build/web /usr/share/nginx/html
COPY nginx.conf /etc/nginx/conf.d/default.conf

# nginx のデフォルトユーザーは root のため、非 root 実行に切り替える。
# helm設計.md の securityContext との整合については React クライアントと同様。
USER nginx
EXPOSE 8080
```

> **注**: Flutter クライアントは React と同じ nginx.conf を使用する。SPA ルーティング・gzip 圧縮・セキュリティヘッダーの設定は共通であるため、3.12 の nginx.conf をそのまま適用する。

---

## 5. 既存ドキュメント参照マップ

テンプレートファイルと既存ドキュメントの対応関係を示す。

| テンプレートファイル                        | 参照ドキュメント                                  | 該当セクション                               |
| ------------------------------------------- | ------------------------------------------------- | -------------------------------------------- |
| `api-client.ts` / `dio_client.dart`         | [認証認可設計](認証認可設計.md)                    | D-013 BFF + HttpOnly Cookie                  |
| `api-client.ts`（CSRF トークン）            | [認証認可設計](認証認可設計.md)                    | CSRF 対策                                    |
| `Dockerfile`（React / Flutter）             | [Dockerイメージ戦略](Dockerイメージ戦略.md)        | ベースイメージ一覧・マルチステージビルド      |
| `nginx.conf`                                | [Dockerイメージ戦略](Dockerイメージ戦略.md)        | React / Flutter クライアント                 |
| `vitest.config.ts` / `msw-setup.ts`         | [コーディング規約](コーディング規約.md)            | テストツール一覧（TypeScript）               |
| `eslint.config.mjs` / `.prettierrc`         | [コーディング規約](コーディング規約.md)            | TypeScript ツール・設定                      |
| `analysis_options.yaml`                     | [コーディング規約](コーディング規約.md)            | Dart ツール・設定                            |
| `package.json` / `pubspec.yaml`（変数展開） | [テンプレートエンジン仕様](テンプレートエンジン仕様.md) | テンプレート変数一覧・フィルタ               |

---

## 6. 関連ドキュメント

- [テンプレートエンジン仕様](テンプレートエンジン仕様.md) --- 変数置換・条件分岐・フィルタの仕様
- [テンプレート仕様-サーバー](テンプレート仕様-サーバー.md) --- サーバーテンプレート
- [テンプレート仕様-ライブラリ](テンプレート仕様-ライブラリ.md) --- ライブラリテンプレート
- [テンプレート仕様-データベース](テンプレート仕様-データベース.md) --- データベーステンプレート
- [CLIフロー](CLIフロー.md) --- CLI の対話フローと操作手順
- [ディレクトリ構成図](ディレクトリ構成図.md) --- 生成先ディレクトリ構成
- [Dockerイメージ戦略](Dockerイメージ戦略.md) --- Docker ビルド戦略
- [認証認可設計](認証認可設計.md) --- BFF + Cookie 認証
- [コーディング規約](コーディング規約.md) --- Linter・テストツール
