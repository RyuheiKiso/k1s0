# テンプレート仕様 — サーバー — 認証認可 Middleware

本ドキュメントは、[テンプレート仕様-サーバー](テンプレート仕様-サーバー.md) から分割された認証認可 Middleware テンプレートの詳細仕様である。

---

## 認証認可 Middleware テンプレート

[認証認可設計.md](認証認可設計.md) D-004（Kong API Gateway 認証フロー）および D-005（アプリケーションレベル RBAC）に基づき、Kong から転送されるヘッダーを使用した認証認可ミドルウェアのスケルトンコードを生成する。

### 認証フロー概要

```
Client → Kong (JWT検証) → Backend Service (auth middleware → rbac middleware → handler)
```

Kong が JWT を検証し、`X-User-Id` / `X-User-Roles` / `X-User-Email` ヘッダーをバックエンドに転送する。バックエンドの auth middleware はこれらのヘッダーからユーザー情報を取得し、rbac middleware がパーミッション検証を行う。

### src/adapter/middleware/auth.rs

`src/adapter/middleware/auth.rs.tera` — JWT Claims 検証（Kong 転送ヘッダーからユーザー情報取得）。

```rust
use axum::{
    extract::Request,
    http::StatusCode,
    middleware::Next,
    response::{IntoResponse, Json, Response},
};
use serde::Serialize;

/// Kong から転送された JWT Claims のユーザー情報。
#[derive(Debug, Clone)]
pub struct UserInfo {
    pub user_id: String,
    pub roles: Vec<String>,
    pub email: String,
}

#[derive(Serialize)]
struct ErrorResponse {
    code: String,
    message: String,
}

/// Kong から転送されたヘッダーを検証し、UserInfo をリクエスト拡張に格納する。
pub async fn auth_middleware(mut req: Request, next: Next) -> Result<Response, Response> {
    let user_id = req
        .headers()
        .get("X-User-Id")
        .and_then(|v| v.to_str().ok())
        .map(|s| s.to_string());

    let user_id = match user_id {
        Some(id) if !id.is_empty() => id,
        _ => {
            return Err((
                StatusCode::UNAUTHORIZED,
                Json(ErrorResponse {
                    code: "SYS_AUTH_UNAUTHENTICATED".to_string(),
                    message: "認証が必要です".to_string(),
                }),
            )
                .into_response());
        }
    };

    let roles: Vec<String> = req
        .headers()
        .get("X-User-Roles")
        .and_then(|v| v.to_str().ok())
        .unwrap_or("")
        .split(',')
        .filter(|s| !s.is_empty())
        .map(|s| s.to_string())
        .collect();

    let email = req
        .headers()
        .get("X-User-Email")
        .and_then(|v| v.to_str().ok())
        .unwrap_or("")
        .to_string();

    let user_info = UserInfo {
        user_id,
        roles,
        email,
    };

    req.extensions_mut().insert(user_info);
    Ok(next.run(req).await)
}
```

### src/adapter/middleware/rbac.rs

`src/adapter/middleware/rbac.rs.tera` — RBAC パーミッション検証。

```rust
use axum::{
    extract::Request,
    http::StatusCode,
    middleware::Next,
    response::{IntoResponse, Json, Response},
};
use serde::Serialize;

use super::auth::UserInfo;

#[derive(Serialize)]
struct ErrorResponse {
    code: String,
    message: String,
}

/// 指定されたパーミッションを要求する axum ミドルウェア。
/// ロール → パーミッション変換は JWT Claims ベースの静的解決で行う。
pub async fn require_permission(
    permission: &str,
    resource: &str,
    req: Request,
    next: Next,
) -> Result<Response, Response> {
    let user_info = req
        .extensions()
        .get::<UserInfo>()
        .cloned();

    let user_info = match user_info {
        Some(info) => info,
        None => {
            return Err((
                StatusCode::UNAUTHORIZED,
                Json(ErrorResponse {
                    code: "SYS_AUTH_UNAUTHENTICATED".to_string(),
                    message: "認証が必要です".to_string(),
                }),
            )
                .into_response());
        }
    };

    if !has_permission(&user_info.roles, permission, resource) {
        return Err((
            StatusCode::FORBIDDEN,
            Json(ErrorResponse {
                code: "SYS_AUTH_FORBIDDEN".to_string(),
                message: "この操作を実行する権限がありません".to_string(),
            }),
        )
            .into_response());
    }

    Ok(next.run(req).await)
}

/// ロール一覧から指定されたパーミッションを持つかチェックする。
/// パーミッション解決はインメモリのロール → パーミッション変換テーブルで行う（DB ルックアップ不要）。
fn has_permission(roles: &[String], _permission: &str, _resource: &str) -> bool {
    // TODO: Keycloak Admin API から取得したロール → パーミッション変換テーブルで解決する
    // 現在はプレースホルダー実装（全ロールに全パーミッションを許可）
    !roles.is_empty()
}
```

### src/adapter/middleware/mod.rs

`src/adapter/middleware/mod.rs.tera` — ミドルウェアモジュール宣言。

```rust
pub mod auth;
pub mod rbac;
```

---

## 関連ドキュメント

- [テンプレート仕様-サーバー](テンプレート仕様-サーバー.md) --- 概要・条件付き生成表・Tier別配置パス
- [テンプレート仕様-サーバー-Rust](テンプレート仕様-サーバー-Rust.md) --- Rust テンプレート詳細
- [テンプレート仕様-サーバー-可観測性](テンプレート仕様-サーバー-可観測性.md) --- 可観測性テンプレート
- [テンプレート仕様-サーバー-gRPC](テンプレート仕様-サーバー-gRPC.md) --- gRPC Health Check・GraphQL Subscription
- [認証認可設計](認証認可設計.md) --- 認証・認可・シークレット管理
