# コーディング規約

k1s0 プロジェクトで使用する Linter・Formatter と共通ルールを定義する。

## 言語別ツール

### Go

| ツール          | 用途                         | 設定ファイル       |
| --------------- | ---------------------------- | ------------------ |
| gofmt           | コードフォーマット           | （組み込み）       |
| goimports       | import 整理 + フォーマット   | （組み込み）       |
| golangci-lint   | 静的解析                     | `.golangci.yaml`   |

#### .golangci.yaml

```yaml
run:
  timeout: 5m

linters:
  enable:
    - errcheck
    - govet
    - staticcheck
    - unused
    - gosimple
    - ineffassign
    - misspell
    - gocyclo
    - gocritic
    - revive
    - gosec

linters-settings:
  gocyclo:
    min-complexity: 15
  revive:
    rules:
      - name: exported
      - name: var-naming
      - name: unexported-return
  gosec:
    includes:
      - G101  # ハードコード認証情報の検出
      - G201  # SQL インジェクションの検出
      - G301  # ディレクトリ作成時のパーミッション
      - G302  # ファイル作成時のパーミッション
      - G303  # 一時ファイルの安全な作成
      - G304  # ファイルパストラバーサル
      - G305  # ZIP スリップ
      - G306  # ファイル書き込み時のパーミッション
      - G307  # ファイルクローズの遅延エラー
      - G401  # 非推奨ハッシュ関数（MD5 等）
      - G402  # TLS 設定の安全性
      - G403  # RSA 鍵長の最小値
      - G404  # 暗号用途での math/rand 使用禁止
      - G405  # 非推奨 DES 暗号
      - G501  # 非推奨ブロック暗号のインポート
      - G502  # 非推奨 DES のインポート
      - G503  # 非推奨 RC4 のインポート
      - G504  # 非推奨 CGO のインポート
      - G505  # 非推奨 SHA1 のインポート
    excludes:
      - G104  # 未チェックエラー → errcheck で代替
      - G114  # net/http デフォルトサーバー → 独自サーバー設定で対応済み
```

#### gosec ルール適用ポリシー

gosec は Go コードのセキュリティ脆弱性を検出する静的解析ツールであり、golangci-lint 経由で実行する。

**有効化するルール:**

| ルール ID   | 検出対象                           |
| ----------- | ---------------------------------- |
| G101        | ハードコードされた認証情報         |
| G201        | SQL インジェクション               |
| G301 - G307 | ファイル・ディレクトリパーミッション |
| G401 - G405 | 非推奨・脆弱な暗号アルゴリズム     |
| G501 - G505 | 非推奨ブロック暗号のインポート     |

**除外するルール:**

| ルール ID | 除外理由                                                   |
| --------- | ---------------------------------------------------------- |
| G104      | 未チェックエラーは `errcheck` リンターで代替検出する       |
| G114      | `net/http` デフォルトサーバーは独自サーバー設定で対応済み |

### Rust

| ツール   | 用途               | 設定ファイル                |
| -------- | ------------------ | --------------------------- |
| rustfmt  | コードフォーマット | `rustfmt.toml`              |
| clippy   | 静的解析           | `Cargo.toml` の `[lints]`   |

#### rustfmt.toml

```toml
edition = "2021"
max_width = 100
tab_spaces = 4
use_field_init_shorthand = true
```

#### Cargo.toml（lints セクション）

```toml
[lints.clippy]
pedantic = { level = "warn", priority = -1 }
module_name_repetitions = "allow"
must_use_candidate = "allow"
```

### TypeScript

| ツール    | 用途               | 設定ファイル        |
| --------- | ------------------ | ------------------- |
| ESLint    | 静的解析           | `eslint.config.mjs` |
| Prettier  | コードフォーマット | `.prettierrc`       |

#### .prettierrc

```json
{
  "semi": true,
  "singleQuote": true,
  "trailingComma": "all",
  "printWidth": 100,
  "tabWidth": 2
}
```

#### eslint.config.mjs

```javascript
// eslint.config.mjs
import eslint from "@eslint/js";
import tseslint from "typescript-eslint";
import react from "eslint-plugin-react";
import reactHooks from "eslint-plugin-react-hooks";
import importPlugin from "eslint-plugin-import";

export default tseslint.config(
  eslint.configs.recommended,
  ...tseslint.configs.strictTypeChecked,
  {
    plugins: { react, "react-hooks": reactHooks, import: importPlugin },
    rules: {
      "react-hooks/rules-of-hooks": "error",
      "react-hooks/exhaustive-deps": "warn",
      "import/order": ["error", {
        "groups": ["builtin", "external", "internal", "parent", "sibling"],
        "newlines-between": "always",
        "alphabetize": { "order": "asc" }
      }],
      "@typescript-eslint/no-unused-vars": ["error", { "argsIgnorePattern": "^_" }],
      "@typescript-eslint/explicit-function-return-type": "off",
      "@typescript-eslint/no-floating-promises": "error",
    },
  }
);
```

### Dart

| ツール        | 用途               | 設定ファイル              |
| ------------- | ------------------ | ------------------------- |
| dart analyze  | 静的解析           | `analysis_options.yaml`   |
| dart format   | コードフォーマット | （組み込み）              |

#### analysis_options.yaml

```yaml
include: package:flutter_lints/flutter.yaml

linter:
  rules:
    - prefer_const_constructors
    - prefer_const_declarations
    - avoid_print
    - prefer_single_quotes
```

### Python（E2E テスト）

| ツール | 用途                  | 設定ファイル   |
| ------ | --------------------- | -------------- |
| Ruff   | Linter + Formatter    | `ruff.toml`    |
| mypy   | 型チェック            | `mypy.ini`     |

#### ruff.toml

```toml
line-length = 100
target-version = "py312"

[lint]
select = ["E", "F", "I", "UP", "B", "SIM"]
```

#### mypy.ini

```ini
[mypy]
python_version = 3.12
strict = true
warn_return_any = true
warn_unused_configs = true
```

## 命名規則

| 言語       | 変数・関数   | 型・構造体   | 定数                  | ファイル名      |
| ---------- | ------------ | ------------ | --------------------- | --------------- |
| Go         | camelCase    | PascalCase   | PascalCase            | snake_case.go   |
| Rust       | snake_case   | PascalCase   | SCREAMING_SNAKE_CASE  | snake_case.rs   |
| TypeScript | camelCase    | PascalCase   | SCREAMING_SNAKE_CASE  | kebab-case.ts   |
| Dart       | camelCase    | PascalCase   | camelCase             | snake_case.dart |
| Python     | snake_case   | PascalCase   | SCREAMING_SNAKE_CASE  | snake_case.py   |

## 共通方針

- 各言語の公式スタイルガイドに従う
- フォーマットは保存時に自動実行する（Dev Container の設定で統一）
- Linter の警告はすべて解消してからコミットする
- `// nolint`・`#[allow]`・`// eslint-disable` 等の抑制コメントには理由を明記する

## Pre-commit フック

Git の pre-commit フックで以下を自動実行する。

```yaml
# .pre-commit-config.yaml
repos:
  - repo: local
    hooks:
      - id: go-lint
        name: Go Lint
        entry: golangci-lint run
        language: system
        files: '\.go$'
        pass_filenames: false

      - id: rust-fmt
        name: Rust Format Check
        entry: cargo fmt -- --check
        language: system
        files: '\.rs$'
        pass_filenames: false

      - id: rust-clippy
        name: Rust Clippy
        entry: cargo clippy -- -D warnings
        language: system
        files: '\.rs$'
        pass_filenames: false

      - id: ts-lint
        name: TypeScript Lint
        entry: npx eslint
        language: system
        files: '\.[tj]sx?$'

      - id: prettier
        name: Prettier
        entry: npx prettier --check
        language: system
        files: '\.(ts|tsx|js|jsx|json|yaml|yml)$'

      - id: dart-analyze
        name: Dart Analyze
        entry: dart analyze --fatal-infos
        language: system
        files: '\.dart$'
        pass_filenames: false

      - id: dart-format
        name: Dart Format Check
        entry: dart format --set-exit-if-changed
        language: system
        files: '\.dart$'

      - id: python-lint
        name: Python Lint
        entry: ruff check
        language: system
        files: '\.py$'
```

## テストツール

### Go

| ツール   | 用途                       | インストール                                  |
| -------- | -------------------------- | --------------------------------------------- |
| testify  | アサーション・テストスイート | `go get github.com/stretchr/testify`         |
| gomock   | モック自動生成             | `go install go.uber.org/mock/mockgen@latest` |

#### gomock の使用方法

Repository インターフェースからモックを自動生成する。

```go
//go:generate mockgen -source=internal/domain/repository/order.go -destination=internal/domain/repository/mock_order.go -package=repository
```

テストコードでの使用:

```go
func TestCreateOrder(t *testing.T) {
    ctrl := gomock.NewController(t)
    defer ctrl.Finish()

    mockRepo := repository.NewMockOrderRepository(ctrl)
    mockRepo.EXPECT().
        Save(gomock.Any(), gomock.Any()).
        Return(nil)

    uc := usecase.NewOrderUsecase(mockRepo)
    err := uc.Create(context.Background(), input)
    assert.NoError(t, err)
}
```

### Rust

| ツール  | 用途           | インストール                    |
| ------- | -------------- | ------------------------------- |
| mockall | モック自動生成 | `cargo add --dev mockall`       |
| tokio   | async テスト   | dev-dependencies に追加         |

#### Cargo.toml（dev-dependencies）

```toml
[dev-dependencies]
mockall = "0.13"
tokio = { version = "1", features = ["test-util", "macros"] }
```

#### mockall の使用方法

Repository トレイトに `#[automock]` を付与してモックを自動生成する。

```rust
#[cfg(test)]
use mockall::automock;

#[cfg_attr(test, automock)]
pub trait OrderRepository: Send + Sync {
    async fn save(&self, order: &Order) -> Result<(), DomainError>;
    async fn find_by_id(&self, id: &str) -> Result<Option<Order>, DomainError>;
}
```

### TypeScript

| ツール          | 用途               | インストール                                                     |
| --------------- | ------------------ | ---------------------------------------------------------------- |
| Vitest          | テストランナー     | `npm install -D vitest`                                          |
| Testing Library | コンポーネントテスト | `npm install -D @testing-library/react @testing-library/jest-dom` |
| MSW             | API モック         | `npm install -D msw`                                             |

#### vitest.config.ts

```typescript
import { defineConfig } from 'vitest/config';

export default defineConfig({
  test: {
    globals: true,
    environment: 'jsdom',
    setupFiles: ['./tests/testutil/setup.ts'],
    coverage: {
      provider: 'v8',
      reporter: ['text', 'lcov'],
    },
  },
});
```

#### ESLint 連携

テストファイルで Vitest のグローバル API を許可する。

```javascript
// eslint.config.mjs（テスト用設定の追加）
{
  files: ['tests/**/*.{ts,tsx}'],
  languageOptions: {
    globals: {
      describe: 'readonly',
      it: 'readonly',
      expect: 'readonly',
      vi: 'readonly',
      beforeEach: 'readonly',
      afterEach: 'readonly',
    },
  },
}
```

#### MSW ハンドラー

```typescript
// tests/testutil/handlers.ts
import { http, HttpResponse } from 'msw';

export const handlers = [
  http.get('/api/v1/orders', () => {
    return HttpResponse.json([
      { id: '1', product_id: 'p1', quantity: 2, status: 'PENDING' },
    ]);
  }),
];
```

```typescript
// tests/testutil/setup.ts
import '@testing-library/jest-dom/vitest';
import { setupServer } from 'msw/node';
import { handlers } from './handlers';

export const server = setupServer(...handlers);

beforeAll(() => server.listen());
afterEach(() => server.resetHandlers());
afterAll(() => server.close());
```

### Dart / Flutter

| ツール       | 用途             | インストール                      |
| ------------ | ---------------- | --------------------------------- |
| flutter_test | ウィジェットテスト | Flutter SDK 内蔵                 |
| mocktail     | モック生成       | `dart pub add --dev mocktail`     |

#### mocktail の使用方法

```dart
import 'package:flutter_test/flutter_test.dart';
import 'package:mocktail/mocktail.dart';

class MockOrderRepository extends Mock implements OrderRepository {}

void main() {
  late MockOrderRepository mockRepo;

  setUp(() {
    mockRepo = MockOrderRepository();
  });

  test('should create order', () async {
    when(() => mockRepo.save(any())).thenAnswer((_) async => unit);

    final usecase = OrderUsecase(mockRepo);
    await usecase.create(input);

    verify(() => mockRepo.save(any())).called(1);
  });
}
```

### テスト共通方針

- ユニットテストの配置は言語慣習に従う（[ディレクトリ構成図](ディレクトリ構成図.md) 参照）
- テストファイル命名: Go `*_test.go`、Rust `#[cfg(test)]`、TS `*.test.ts(x)`、Dart `*_test.dart`、Python `test_*.py`
- モックは自動生成を基本とし、手動モックは避ける
- 統合テストでは testcontainers を活用し、実際の DB / Kafka に対してテストする
- `go generate` / `build.rs` でモック・コード生成を自動化し、CI で生成漏れを検出する

### testcontainers 使用パターン

統合テストでは testcontainers を使い、テスト実行時に実際のコンテナ（PostgreSQL・Kafka 等）を起動する。テスト終了後にコンテナは自動的に破棄される。

#### Go

```go
func TestWithPostgres(t *testing.T) {
    ctx := context.Background()
    postgres, err := testcontainers.GenericContainer(ctx, testcontainers.GenericContainerRequest{
        ContainerRequest: testcontainers.ContainerRequest{
            Image:        "postgres:17-alpine",
            ExposedPorts: []string{"5432/tcp"},
            Env: map[string]string{
                "POSTGRES_PASSWORD": "test",
                "POSTGRES_DB":       "testdb",
            },
            WaitingFor: wait.ForListeningPort("5432/tcp"),
        },
        Started: true,
    })
    require.NoError(t, err)
    defer postgres.Terminate(ctx)
    // テスト実行
}
```

#### Rust

```rust
#[tokio::test]
async fn test_with_postgres() {
    let postgres = testcontainers::runners::AsyncRunner::start(
        testcontainers_modules::postgres::Postgres::default()
    ).await.unwrap();
    let port = postgres.get_host_port_ipv4(5432).await.unwrap();
    let url = format!("postgres://postgres:postgres@localhost:{}/postgres", port);
    // テスト実行
}
```

## コードレビューガイドライン

### レビュー観点

| # | 観点               | 確認内容                                                                 |
| - | ------------------ | ------------------------------------------------------------------------ |
| 1 | 機能要件           | 仕様通りに動作するか                                                     |
| 2 | Tier 依存ルール    | 依存方向が正しいか（下位→上位のみ）                                     |
| 3 | エラーハンドリング | 適切なエラー型を使用しているか、エラーメッセージは十分か                 |
| 4 | セキュリティ       | 入力バリデーション、認証・認可チェックが適切か                           |
| 5 | テスト             | ユニットテスト・統合テストが追加されているか、カバレッジが低下していないか |
| 6 | パフォーマンス     | N+1 クエリ、不要なメモリアロケーションがないか                           |

### レビュープロセス

- PR は最低 1 名の Approve が必要
- system Tier の変更は 2 名の Approve が必要
- 自動テスト（CI）が全パスしていることが Merge 条件

## 関連ドキュメント

- [devcontainer設計](devcontainer設計.md)
- [CI-CD設計](CI-CD設計.md)
- [API設計](API設計.md)
- [コンセプト](コンセプト.md)
