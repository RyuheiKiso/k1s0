# system-library 概要

system tier が提供する共通ライブラリの設計を定義する。
全ライブラリは Go / Rust / TypeScript / Dart の 4 言語で平等に実装する。

## ライブラリ一覧

| ライブラリ | 用途 | 利用者 | 詳細設計 |
|-----------|------|--------|---------|
| config | YAML 設定読み込み・環境別オーバーライド・バリデーション | 全サーバー・クライアント | [system-library-config設計](../config/config.md) |
| telemetry | OpenTelemetry 初期化・構造化ログ・分散トレース・メトリクス | 全サーバー・クライアント | [system-library-telemetry設計](../observability/telemetry.md) |
| auth | JWT 検証（サーバー用）/ OAuth2 PKCE トークン管理（クライアント用） | 全サーバー・クライアント | [system-library-authlib設計](../auth-security/authlib.md) |
| k1s0-messaging | Kafka イベント発行・購読の抽象化（EventProducer トレイト・EventEnvelope） | 全サーバー（Kafka イベント発行） | [system-library-messaging設計](../messaging/messaging.md) |
| k1s0-kafka | Kafka 接続設定・管理・ヘルスチェック（KafkaConfig・TLS 対応） | k1s0-messaging を使うサーバー | [system-library-kafka設計](../messaging/kafka.md) |
| k1s0-correlation | 分散トレーシング用相関 ID・トレース ID 管理（UUID v4・32 文字 hex） | 全サーバー・クライアント | [system-library-correlation設計](../observability/correlation.md) |
| k1s0-outbox | トランザクショナルアウトボックスパターン（指数バックオフリトライ） | Kafka 発行を必要とするサーバー | [system-library-outbox設計](../messaging/outbox.md) |
| k1s0-schemaregistry | Confluent Schema Registry クライアント（Avro/Json/Protobuf 対応） | Kafka プロデューサー・コンシューマー | [system-library-schemaregistry設計](../data/schemaregistry.md) |
| k1s0-serviceauth | サービス間 OAuth2 Client Credentials 認証（トークンキャッシュ・SPIFFE） | サービス間 gRPC/HTTP 通信を行うサーバー | [system-library-serviceauth設計](../auth-security/serviceauth.md) |
| k1s0-saga | SagaサーバーREST/gRPCクライアントSDK | サービス間Saga起動・状態確認 | [system-library-saga設計](../resilience/saga.md) |
| k1s0-dlq-client | Kafka DLQ メッセージ管理クライアント | DLQメッセージ再処理・モニタリング | [system-library-dlq-client設計](../messaging/dlq-client.md) |
| k1s0-cache | Redis 分散キャッシュ抽象化（get/set/delete/分散ロック・Redis Cluster/Sentinel 対応） | 全サーバー（分散キャッシュを必要とする場合） | [system-library-cache設計](../data/cache.md) |
| k1s0-idempotency | API リクエストの冪等性保証（Idempotency-Key ヘッダー処理・TTL 付きレスポンスキャッシュ） | REST/gRPC エンドポイントを提供する全サーバー | [system-library-idempotency設計](../resilience/idempotency.md) |
| k1s0-retry | 指数バックオフリトライ・サーキットブレーカーパターン（OpenTelemetry メトリクス連携） | サービス間 gRPC/HTTP 通信を行うサーバー | [system-library-retry設計](../resilience/retry.md) |
| k1s0-featureflag | フィーチャーフラグサーバーのクライアント SDK（ローカルキャッシュ・Kafka リアルタイム更新） | 動的機能制御を必要とする全サーバー・クライアント | [system-library-featureflag設計](../config/featureflag.md) |
| k1s0-eventstore | イベントソーシング向けイベント永続化・再生基盤（Append-only ストリーム・スナップショット対応） | イベントソーシングを採用するサーバー | [system-library-eventstore設計](../data/eventstore.md) |
| k1s0-tracing | W3C TraceContext 伝播・Span 作成・Baggage 管理に特化した分散トレーシングライブラリ（telemetry から分離） | 分散トレーシングを必要とする全サーバー・クライアント | [system-library-tracing設計](../observability/tracing.md) |
| k1s0-graphql-client | GraphQL クエリ・ミューテーション・サブスクリプション（WebSocket）クライアント | graphql-gateway を利用する全サーバー・クライアント | [system-library-graphql-client設計](../client-sdk/graphql-client.md) |
| k1s0-websocket | WebSocket 接続管理・自動再接続・Ping/Pong ハートビート・メッセージキューイング | リアルタイム通信を必要とするサーバー・クライアント | [system-library-websocket設計](../messaging/websocket.md) |
| k1s0-session-client | session-server（ポート 8102）へのセッション作成・取得・更新・失効クライアント | セッション管理を必要とする全サーバー・クライアント | [system-library-session-client設計](../client-sdk/session-client.md) |
| k1s0-audit-client | 監査ログ送信クライアント（audit-server への構造化ログ記録・バッチ送信） | 監査ログ記録を必要とする全サーバー | [system-library-audit-client設計](../observability/audit-client.md) |
| k1s0-circuit-breaker | サーキットブレーカーパターン（Open/HalfOpen/Closed 状態管理・閾値ベースの自動遮断） | サービス間通信を行う全サーバー | [system-library-circuit-breaker設計](../resilience/circuit-breaker.md) |
| k1s0-distributed-lock | 分散ロック（Redis / PostgreSQL ベースの排他制御・TTL 付きリース） | 排他制御を必要とする全サーバー | [system-library-distributed-lock設計](../data/distributed-lock.md) |
| k1s0-encryption | 暗号化・復号化ユーティリティ（AES-GCM / RSA / Argon2id パスワードハッシュ）| データ暗号化を必要とする全サーバー・クライアント | [system-library-encryption設計](../auth-security/encryption.md) |
| k1s0-event-bus | ドメインイベントバス（in-process パブサブ・非同期ハンドラー・イベント優先度制御） | ドメインイベント駆動を採用するサーバー | [system-library-event-bus設計](../messaging/event-bus.md) |
| k1s0-file-client | ファイルストレージクライアント（S3 / GCS / Azure Blob 対応・マルチパートアップロード） | ファイル操作を必要とする全サーバー | [system-library-file-client設計](../client-sdk/file-client.md) |
| k1s0-health | ヘルスチェック（liveness / readiness / startup プローブ・依存サービス状態集約） | 全サーバー | [system-library-health設計](../observability/health.md) |
| k1s0-migration | DB マイグレーション管理（バージョン管理・ロールバック・マイグレーション履歴） | DB を使用する全サーバー | [system-library-migration設計](../data/migration.md) |
| k1s0-notification-client | 通知送信クライアント（メール / SMS / Push 通知の統一インターフェース） | 通知送信を必要とする全サーバー | [system-library-notification-client設計](../messaging/notification-client.md) |
| k1s0-pagination | ページネーション共通ユーティリティ（カーソルベース / オフセットベース・ソート対応） | 一覧取得 API を提供する全サーバー | [system-library-pagination設計](../data/pagination.md) |
| k1s0-quota-client | クォータ管理クライアント（リソース使用量の追跡・制限チェック・超過通知） | リソース制限を必要とする全サーバー | [system-library-quota-client設計](../client-sdk/quota-client.md) |
| k1s0-ratelimit-client | レートリミットクライアント（スライディングウィンドウ / トークンバケット・分散カウンター） | API レート制限を必要とする全サーバー | [system-library-ratelimit-client設計](../client-sdk/ratelimit-client.md) |
| k1s0-resiliency | リトライ + バックオフ + タイムアウト統合（ポリシーベースのレジリエンス制御） | サービス間通信を行う全サーバー | [system-library-resiliency設計](../resilience/resiliency.md) |
| k1s0-scheduler-client | スケジューラークライアント（ジョブ登録・cron スケジュール・実行履歴管理） | 定期実行を必要とする全サーバー | [system-library-scheduler-client設計](../client-sdk/scheduler-client.md) |
| k1s0-search-client | 全文検索クライアント（Elasticsearch / OpenSearch 対応・クエリビルダー・集約） | 全文検索を必要とする全サーバー | [system-library-search-client設計](../client-sdk/search-client.md) |
| k1s0-tenant-client | テナント管理クライアント（テナント作成・メンバー管理・プロビジョニング状態確認） | マルチテナント機能を必要とする全サーバー | [system-library-tenant-client設計](../client-sdk/tenant-client.md) |
| k1s0-test-helper | テストユーティリティ（フィクスチャ生成・モックビルダー・DB セットアップ・テストコンテナ管理） | 全ライブラリ・サーバーのテストコード | [system-library-test-helper設計](../testing/test-helper.md) |
| k1s0-validation | バリデーションユーティリティ（宣言的ルール定義・多言語エラーメッセージ・カスタムバリデーター） | 入力バリデーションを必要とする全サーバー・クライアント | [system-library-validation設計](../testing/validation.md) |
| k1s0-vault-client | Vault シークレット管理クライアント（シークレット取得・一覧・更新検知・リース管理）| シークレット管理を必要とする全サーバー | [system-library-vault-client設計](../auth-security/vault-client.md) |
| k1s0-webhook-client | Webhook 送信クライアント（HMAC 署名・リトライ・配信ログ・ペイロードシリアライゼーション） | Webhook 配信を必要とする全サーバー | [system-library-webhook-client設計](../messaging/webhook-client.md) |

## Rust 固有ライブラリ

以下は Rust サーバー向けの内部共有ライブラリであり、多言語対応はない。

| ライブラリ | 用途 | 利用者 |
|-----------|------|--------|
| k1s0-server-common | axum 向けエラー型・構造化エラーコードの共通インフラ（HTTP エラーレスポンス型・共通エラーコード定数） | Rust サーバー（axum / utoipa feature 有効時） |

---

## テスト方針

全ライブラリで TDD を適用する。

| 言語 | ユニットテスト | モック | 統合テスト |
|------|---------------|--------|-----------|
| Go | testify + assert/require | gomock | testcontainers-go |
| Rust | #[cfg(test)] + assert | mockall | wiremock |
| TypeScript | vitest + expect | MSW | vitest |
| Dart | test + expect | mocktail | test |

### テストカバレッジ目標

| 対象 | カバレッジ |
|------|-----------|
| config ライブラリ | 90% 以上 |
| telemetry ライブラリ | 80% 以上 |
| authlib ライブラリ | 90% 以上 |
| k1s0-messaging | 85% 以上 |
| k1s0-kafka | 80% 以上 |
| k1s0-correlation | 90% 以上 |
| k1s0-outbox | 85% 以上 |
| k1s0-schemaregistry | 85% 以上 |
| k1s0-serviceauth | 90% 以上 |
| k1s0-saga | 85% 以上 |
| k1s0-dlq-client | 85% 以上 |
| k1s0-cache | 85% 以上 |
| k1s0-idempotency | 85% 以上 |
| k1s0-retry | 85% 以上 |
| k1s0-featureflag | 85% 以上 |
| k1s0-eventstore | 85% 以上 |
| k1s0-tracing | 80% 以上 |
| k1s0-graphql-client | 90% 以上 |
| k1s0-websocket | 90% 以上 |
| k1s0-session-client | 90% 以上 |
| k1s0-audit-client | 85% 以上 |
| k1s0-circuit-breaker | 85% 以上 |
| k1s0-distributed-lock | 85% 以上 |
| k1s0-encryption | 90% 以上 |
| k1s0-event-bus | 85% 以上 |
| k1s0-file-client | 85% 以上 |
| k1s0-health | 85% 以上 |
| k1s0-migration | 80% 以上 |
| k1s0-notification-client | 85% 以上 |
| k1s0-pagination | 90% 以上 |
| k1s0-quota-client | 85% 以上 |
| k1s0-ratelimit-client | 90% 以上 |
| k1s0-resiliency | 85% 以上 |
| k1s0-scheduler-client | 90% 以上 |
| k1s0-search-client | 90% 以上 |
| k1s0-tenant-client | 90% 以上 |
| k1s0-test-helper | 80% 以上 |
| k1s0-validation | 90% 以上 |
| k1s0-vault-client | 85% 以上 |
| k1s0-webhook-client | 85% 以上 |

---

## 関連ドキュメント

- [config設計](../../cli/config/config設計.md) — config.yaml スキーマ・環境別管理
- [可観測性設計](../../architecture/observability/可観測性設計.md) — OpenTelemetry・構造化ログ・メトリクス
- [認証認可設計](../../architecture/auth/認証認可設計.md) — OAuth2.0・JWT・RBAC
- [tier-architecture](../../architecture/overview/tier-architecture.md) — Tier 間の依存関係
- [コーディング規約](../../architecture/conventions/コーディング規約.md) — 命名規則・Linter 設定
- [ディレクトリ構成図](../../architecture/overview/ディレクトリ構成図.md) — ライブラリのディレクトリ構成
- [system-server設計](../../servers/auth/server.md) — auth サーバーの詳細設計
- [system-database設計](../../servers/_common/database.md) — auth-db スキーマ設計
