# system-library 共通実装パターン

system tier の全ライブラリで共通する実装パターンを定義する。各ライブラリ設計書ではサービス固有部分のみを記載し、共通パターンは本ドキュメントを参照する。

---

## 言語別配置パス {#言語別配置パス}

| 言語 | 配置パス |
| --- | --- |
| Go | `regions/system/library/go/{lib-name}/` |
| Rust | `regions/system/library/rust/{lib-name}/` |
| TypeScript | `regions/system/library/typescript/{lib-name}/` |
| Dart | `regions/system/library/dart/{lib-name}/` |

---

## 言語別定型ディレクトリ構成 {#定型ディレクトリ構成}

### Go

```
{lib-name}/
├── {module}.go
├── {module}_test.go
├── go.mod
└── go.sum
```

### Rust

```
{lib-name}/
├── src/
│   ├── lib.rs          # 公開 API（再エクスポート）
│   ├── {module}.rs     # 各機能モジュール
│   └── error.rs        # エラー型
├── Cargo.toml
└── README.md
```

### TypeScript

```
{lib-name}/
├── src/
│   ├── index.ts        # 公開 API
│   └── {module}.ts     # 各機能モジュール
├── tests/
│   └── {module}.test.ts
├── package.json
└── tsconfig.json
```

### Dart

```
{lib-name}/
├── lib/
│   ├── {lib_name}.dart # 公開 API
│   └── src/
│       └── {module}.dart
├── test/
│   └── {module}_test.dart
└── pubspec.yaml
```

---

## Cargo.toml 依存追加方法 {#cargo依存追加}

サーバーの `Cargo.toml` にライブラリ依存を追加する際の標準パターン:

```toml
# パス依存（モノリポ内）
k1s0-{lib-name} = { path = "../../system/library/rust/{lib-name}" }

# feature 有効化（テスト用モック等）
k1s0-{lib-name} = { path = "../../system/library/rust/{lib-name}", features = ["mock"] }
```

---

## テスト戦略 {#テスト戦略}

| テスト種別 | ツール | 対象 |
| --- | --- | --- |
| ユニットテスト | `#[cfg(test)]` + `mockall` | ドメインロジック・ビジネスルール |
| 統合テスト | `testcontainers` | DB・Redis・Kafka 接続 |
| プロパティテスト | `proptest`（必要時） | 変換ロジック・バリデーション |

### カバレッジ目標

- **ライン**: 80% 以上
- **ブランチ**: 70% 以上
- 公開 API は全パスをテストすること

---

## 関連ドキュメント

- [概要.md](./概要.md) -- ライブラリ一覧
- [テンプレート仕様-ライブラリ](../../templates/codegen/ライブラリ.md) -- ライブラリテンプレート
- [コーディング規約.md](../../architecture/conventions/コーディング規約.md) -- Linter・Formatter・命名規則
