# Build stage
FROM golang:1.23-alpine AS builder

RUN apk add --no-cache ca-certificates git

WORKDIR /app

COPY go.mod ./
# go.sum will be generated by go mod tidy before build
COPY go.sum* ./
RUN go mod download

COPY . .

RUN CGO_ENABLED=0 GOOS=linux go build -ldflags="-s -w" -o /bff-proxy ./cmd/main.go

# Runtime stage
FROM gcr.io/distroless/static-debian12:nonroot

COPY --from=builder /bff-proxy /bff-proxy
COPY --from=builder /app/config/ /etc/app/

EXPOSE 8080

ENTRYPOINT ["/bff-proxy"]
