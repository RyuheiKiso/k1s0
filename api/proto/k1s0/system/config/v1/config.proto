// k1s0 設定管理サービス gRPC 定義。
// 設定値の取得・更新・削除・監視を提供する。
syntax = "proto3";

package k1s0.system.config.v1;

option go_package = "github.com/k1s0-platform/system-server-go-config/gen/go/k1s0/system/config/v1;configv1";

import "k1s0/system/common/v1/types.proto";

// ConfigService は設定値の取得・更新・削除・監視を提供する。
service ConfigService {
  // 設定値取得
  rpc GetConfig(GetConfigRequest) returns (GetConfigResponse);

  // namespace 内の設定値一覧取得
  rpc ListConfigs(ListConfigsRequest) returns (ListConfigsResponse);

  // 設定値更新
  rpc UpdateConfig(UpdateConfigRequest) returns (UpdateConfigResponse);

  // 設定値削除
  rpc DeleteConfig(DeleteConfigRequest) returns (DeleteConfigResponse);

  // サービス向け設定一括取得
  rpc GetServiceConfig(GetServiceConfigRequest) returns (GetServiceConfigResponse);

  // 設定変更の監視（Server-Side Streaming）
  rpc WatchConfig(WatchConfigRequest) returns (stream WatchConfigResponse);

  // 設定スキーマ取得
  rpc GetConfigSchema(GetConfigSchemaRequest) returns (GetConfigSchemaResponse);

  // 設定スキーマ作成・更新
  rpc UpsertConfigSchema(UpsertConfigSchemaRequest) returns (UpsertConfigSchemaResponse);
}

// ============================================================
// ConfigEntry
// ============================================================

// ConfigEntry は設定値エントリ。
message ConfigEntry {
  // UUID
  string id = 1;
  // 名前空間（例: "system.auth.database"）
  string namespace = 2;
  // キー名（例: "max_connections"）
  string key = 3;
  // JSON エンコード済みの値
  bytes value = 4;
  // 楽観的排他制御用バージョン
  int32 version = 5;
  string description = 6;
  string created_by = 7;
  string updated_by = 8;
  k1s0.system.common.v1.Timestamp created_at = 9;
  k1s0.system.common.v1.Timestamp updated_at = 10;
}

// ============================================================
// GetConfig
// ============================================================

// GetConfigRequest は設定値取得リクエスト。
message GetConfigRequest {
  string namespace = 1;
  string key = 2;
}

// GetConfigResponse は設定値取得レスポンス。
message GetConfigResponse {
  ConfigEntry entry = 1;
}

// ============================================================
// ListConfigs
// ============================================================

// ListConfigsRequest は設定値一覧取得リクエスト。
message ListConfigsRequest {
  string namespace = 1;
  k1s0.system.common.v1.Pagination pagination = 2;
  // キー名の部分一致検索
  string search = 3;
}

// ListConfigsResponse は設定値一覧取得レスポンス。
message ListConfigsResponse {
  repeated ConfigEntry entries = 1;
  k1s0.system.common.v1.PaginationResult pagination = 2;
}

// ============================================================
// UpdateConfig
// ============================================================

// UpdateConfigRequest は設定値更新リクエスト。
message UpdateConfigRequest {
  string namespace = 1;
  string key = 2;
  // JSON エンコード済みの値
  bytes value = 3;
  // 楽観的排他制御用（現在のバージョン番号）
  int32 version = 4;
  string description = 5;
  string updated_by = 6;
}

// UpdateConfigResponse は設定値更新レスポンス。
message UpdateConfigResponse {
  ConfigEntry entry = 1;
}

// ============================================================
// DeleteConfig
// ============================================================

// DeleteConfigRequest は設定値削除リクエスト。
message DeleteConfigRequest {
  string namespace = 1;
  string key = 2;
  string deleted_by = 3;
}

// DeleteConfigResponse は設定値削除レスポンス。
message DeleteConfigResponse {
  bool success = 1;
}

// ============================================================
// GetServiceConfig
// ============================================================

// GetServiceConfigRequest はサービス向け設定一括取得リクエスト。
message GetServiceConfigRequest {
  string service_name = 1;
  // dev | staging | prod
  string environment = 2;
}

// GetServiceConfigResponse はサービス向け設定一括取得レスポンス。
message GetServiceConfigResponse {
  // flattened key-value pairs
  map<string, string> configs = 1;
}

// ============================================================
// WatchConfig（Server-Side Streaming）
// ============================================================

// WatchConfigRequest は設定変更監視リクエスト。
message WatchConfigRequest {
  // 監視対象 namespace（空の場合は全件）
  repeated string namespaces = 1;
}

// WatchConfigResponse は設定変更の監視レスポンス（ストリーミング）。
message WatchConfigResponse {
  string namespace = 1;
  string key = 2;
  // 変更前の値（JSON エンコード済み）
  bytes old_value = 3;
  // 変更後の値（JSON エンコード済み）
  bytes new_value = 4;
  int32 old_version = 5;
  int32 new_version = 6;
  string changed_by = 7;
  // CREATED, UPDATED, DELETED
  string change_type = 8;
  k1s0.system.common.v1.Timestamp changed_at = 9;
}

// ============================================================
// ConfigEditorSchema（設定エディタ向けスキーマ）
// ============================================================

// ConfigFieldType は設定フィールドの型を表す。
enum ConfigFieldType {
  CONFIG_FIELD_TYPE_UNSPECIFIED = 0;
  CONFIG_FIELD_TYPE_STRING      = 1;
  CONFIG_FIELD_TYPE_INTEGER     = 2;
  CONFIG_FIELD_TYPE_FLOAT       = 3;
  CONFIG_FIELD_TYPE_BOOLEAN     = 4;
  CONFIG_FIELD_TYPE_ENUM        = 5;
  CONFIG_FIELD_TYPE_OBJECT      = 6;
  CONFIG_FIELD_TYPE_ARRAY       = 7;
}

// ConfigFieldSchema は設定フィールドのスキーマ定義。
message ConfigFieldSchema {
  string          key           = 1;
  string          label         = 2;
  string          description   = 3;
  ConfigFieldType type          = 4;
  int64           min           = 5;
  int64           max           = 6;
  repeated string options       = 7;
  string          pattern       = 8;
  string          unit          = 9;
  bytes           default_value = 10;
}

// ConfigCategorySchema はカテゴリ単位のスキーマ定義。
message ConfigCategorySchema {
  string                     id         = 1;
  string                     label      = 2;
  string                     icon       = 3;
  repeated string            namespaces = 4;
  repeated ConfigFieldSchema fields     = 5;
}

// ConfigEditorSchema はサービスの設定エディタスキーマ全体を表す。
message ConfigEditorSchema {
  string                        service          = 1;
  string                        namespace_prefix = 2;
  repeated ConfigCategorySchema categories       = 3;
  k1s0.system.common.v1.Timestamp updated_at    = 4;
}

// ============================================================
// GetConfigSchema
// ============================================================

// GetConfigSchemaRequest は設定スキーマ取得リクエスト。
message GetConfigSchemaRequest {
  string service_name = 1;
}

// GetConfigSchemaResponse は設定スキーマ取得レスポンス。
message GetConfigSchemaResponse {
  ConfigEditorSchema schema = 1;
}

// ============================================================
// UpsertConfigSchema
// ============================================================

// UpsertConfigSchemaRequest は設定スキーマ作成・更新リクエスト。
message UpsertConfigSchemaRequest {
  ConfigEditorSchema schema     = 1;
  string             updated_by = 2;
}

// UpsertConfigSchemaResponse は設定スキーマ作成・更新レスポンス。
message UpsertConfigSchemaResponse {
  ConfigEditorSchema schema = 1;
}
